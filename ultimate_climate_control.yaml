blueprint:
  name: Ultimate Smart Climate Control - v3.9.30

  description: |
    **Ultimate Smart Climate Control v3.9.30**

    ğŸŒ¡ï¸ The most advanced Home Assistant climate automation with intelligent presence detection, dynamic fan control, outside temperature compensation, and 40-60% energy savings.

    ---

    ## ğŸš€ EASY SETUP - Use the Setup Wizard!

    **âš ï¸ Don't create helpers manually!** Install the companion **Setup Wizard** for automated setup:

    âœ… **2-Minute Setup** - Complete automation in ~2 minutes
    âœ… **Zero Manual Work** - All 19 helpers created automatically (4 new in v3.3.0)
    âœ… **Dashboard Card Generator** - Animated control card included
    âœ… **Safe & Isolated** - Package-based helpers won't affect existing setup

    **Install via HACS:**
    Settings â†’ HACS â†’ Integrations â†’ â‹® Menu â†’ Custom Repositories
    Add: `https://github.com/Chris971991/Smart-Climate-Control` (Category: Integration)

    *Advanced users can still create helpers manually - see [Documentation](https://github.com/Chris971991/Smart-Climate-Control)*

    ---

    ## âœ¨ Key Features

    **ğŸ® 3 Control Modes:**
    - **Auto:** House-wide automation with home/away detection
    - **Smart:** Room-specific presence with BLE/PIR/mmWave sensors (immediate shutoff when leaving)
    - **Manual:** Full user control with emergency temperature overrides only

    **ğŸ§  Intelligent Automation:**
    - Room-specific presence detection (BLE, motion, door sensors, adjacent room support)
    - Dynamic 5-level fan escalation based on actual effectiveness (Level 1â†’5)
    - Temperature stability auto-off (prevents wasted runtime)
    - Proximity pre-conditioning (cools/heats before you arrive home)
    - Near-target stall detection (pushes through final degrees)
    - **NEW v3.3.0:** Enhanced manual override detection (temp, fan, swing, HVAC mode changes)

    **âš¡ Energy Efficiency:**
    - 40-60% energy savings vs always-on operation
    - Smart hysteresis prevents short-cycling and equipment wear
    - Graduated temperature tiers (LOW/MEDIUM/HIGH with escalation)
    - Eco mode for unoccupied rooms (off/eco/maintain options)
    - Comfort zone idle (no unnecessary cooling/heating)

    **ğŸ”§ Advanced Capabilities:**
    - Universal A/C compatibility (auto-detects HVAC modes, fan speeds, swing modes)
    - Multi-zone support (control 1 or multiple units simultaneously)
    - **NEW v3.2.0:** Outside Temperature Compensation (makes AC work HARDER on extreme days to ACHIEVE your target)
    - Time-based scheduling (morning/day/evening/night + weekends)
    - Window detection with auto-shutoff
    - **ENHANCED v3.3.0:** Comprehensive manual override (detects all parameter changes via HA UI or remote)

    ---

    ## ğŸ†• Latest Update - v3.9.27

    **ğŸ› CRITICAL BUG FIX: Old Target Achievement Check Bypassing Overshoot System**
    - ğŸ”´ FIXED: Legacy target check turned off AC at user target, ignoring overshoot
    - ğŸš¨ PROBLEM: Line 11296 checked `current_temp <= target_temp` (22.5Â°C) not overshoot (21.8Â°C)
    - ğŸ’¥ IMPACT: AC turned off at 22.5Â°C, never created 0.7Â°C buffer - rapid cycling!
    - ğŸ›¡ï¸ SOLUTION: Updated legacy check to use `(target_temp - target_overshoot)` for cooling
    - âœ… RESULT: **ALL** target checks now use overshoot - buffer finally works correctly!

    **ğŸ“ Previous Updates:**
    - v3.9.26: ğŸ› Fixed stability auto-off preventing overshoot target achievement
    - v3.9.25: ğŸ› Fixed de-escalation preventing overshoot target achievement

    ğŸ“– **Full changelog & features:** https://github.com/Chris971991/Smart-Climate-Control

    ---

    ## ğŸ”— Quick Links

    ğŸš€ [Setup Wizard Installation](https://github.com/Chris971991/Smart-Climate-Control#setup-wizard-installation-method-1-recommended)
    ğŸ“– [Complete Documentation](https://github.com/Chris971991/Smart-Climate-Control/blob/main/README.md)
    ğŸ“‹ [Configuration Guide](https://github.com/Chris971991/Smart-Climate-Control/blob/main/setup-new-room-guide.md)
    ğŸ› [Report Issues](https://github.com/Chris971991/Smart-Climate-Control/issues)

    ---

    ## ğŸ“‹ Latest Changes

    **v3.1.8** - ğŸ› CRITICAL FIX: Removed time-based override persistence (eliminated all false re-triggers)
    **v3.1.7** - âŒ BROKEN: Attempted mode change timestamp fix (still had re-trigger issues)

    [Full Changelog](https://github.com/Chris971991/Smart-Climate-Control/releases)

    ---

    **Blueprint Direct Import:** `https://github.com/Chris971991/Smart-Climate-Control/blob/main/ultimate_climate_control.yaml`
  domain: automation
  source_url: https://github.com/Chris971991/Smart-Climate-Control/blob/main/ultimate_climate_control.yaml
  input:
    # Basic required settings (always visible)
    room_name:
      name: Room Name *
      description: |
        **Enter the name of this room** for logging and BLE detection.
        
        **Used for:**
        â€¢ **Debug logging:** Prefixes all log entries with room name
        â€¢ **BLE triangulation:** Must match sensor output exactly for presence detection
        â€¢ **Multi-room setup:** Helps distinguish between different AC automations
        
        **Examples:** "Office", "Living Room", "Master Bedroom"
        
        **Important:** If using BLE sensors, check sensor state in Developer Tools for exact string
      selector:
        text:
    
    climate_entities:
      name: Climate Entities *
      description: |
        Select one or more **climate entities** to control with this automation.

        **Supported devices:** All types of A/C units, heat pumps, and climate control devices.
      selector:
        entity:
          multiple: true
          domain: climate
    
    helper_last_mode:
      name: Last Mode Helper Entity *
      description: |
        Input Text helper to track the **last active climate mode**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_text.climate_last_mode_living_room`

        â€¢ `input_text.climate_last_mode_bedroom`

        â€¢ `input_text.climate_last_mode_office`

        **Important:** This helper stores state information for proper automation behavior.
      selector:
        entity:
          domain: input_text
    
    helper_last_change:
      name: Last Change Helper Entity *
      description: |
        Input DateTime helper to track **when climate changes occurred**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_datetime.climate_last_change_living_room`

        â€¢ `input_datetime.climate_last_change_bedroom`

        â€¢ `input_datetime.climate_last_change_office`

        **Used for:** Timing calculations and false detection protection (2-minute buffer).
      selector:
        entity:
          domain: input_datetime

    helper_override_active:
      name: Manual Override Flag Helper *
      description: |
        Input Boolean helper to track **manual override state**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_boolean.climate_override_active_living_room`

        â€¢ `input_boolean.climate_override_active_bedroom`

        â€¢ `input_boolean.climate_override_active_office`

        **Purpose:** Flag that is set when user manually changes AC, cleared when timeout expires or mode switched.
      selector:
        entity:
          domain: input_boolean

    helper_override_time:
      name: Manual Override Time Helper *
      description: |
        Input DateTime helper to track **when manual override was activated**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_datetime.climate_override_time_living_room`

        â€¢ `input_datetime.climate_override_time_bedroom`

        â€¢ `input_datetime.climate_override_time_office`

        **Purpose:** Timestamp used to calculate if override timeout period has expired.
      selector:
        entity:
          domain: input_datetime

    helper_expected_temp:
      name: Expected Temperature Helper *
      description: |
        Input Number helper to track **expected temperature setpoint**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_number.climate_expected_temp_living_room`

        â€¢ `input_number.climate_expected_temp_bedroom`

        â€¢ `input_number.climate_expected_temp_office`

        **Purpose:** Enhanced manual override detection - tracks what temperature automation expects vs actual AC setpoint.

        **Required for:** Detecting user temperature changes via HA UI or physical remote (e.g., 20Â°C â†’ 24Â°C).
      selector:
        entity:
          domain: input_number

    helper_expected_fan:
      name: Expected Fan Mode Helper *
      description: |
        Input Text helper to track **expected fan mode**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_text.climate_expected_fan_living_room`

        â€¢ `input_text.climate_expected_fan_bedroom`

        â€¢ `input_text.climate_expected_fan_office`

        **Purpose:** Enhanced manual override detection - tracks what fan mode automation expects vs actual AC fan mode.

        **Required for:** Detecting user fan speed changes via HA UI or physical remote (e.g., Fan 3 â†’ Fan 5).
      selector:
        entity:
          domain: input_text

    helper_expected_swing:
      name: Expected Swing Mode Helper *
      description: |
        Input Text helper to track **expected swing mode**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_text.climate_expected_swing_living_room`

        â€¢ `input_text.climate_expected_swing_bedroom`

        â€¢ `input_text.climate_expected_swing_office`

        **Purpose:** Enhanced manual override detection - tracks what swing mode automation expects vs actual AC swing mode.

        **Required for:** Detecting user swing mode changes via HA UI or physical remote (e.g., vertical â†’ horizontal).
      selector:
        entity:
          domain: input_text

    helper_expected_hvac:
      name: Expected HVAC Mode Helper *
      description: |
        Input Text helper to track **expected HVAC mode**.

        **Create a unique helper for each room/automation instance:**

        â€¢ `input_text.climate_expected_hvac_living_room`

        â€¢ `input_text.climate_expected_hvac_bedroom`

        â€¢ `input_text.climate_expected_hvac_office`

        **Purpose:** Enhanced manual override detection - tracks what HVAC mode automation expects vs actual AC mode.

        **Required for:** Detecting user HVAC mode changes via HA UI or physical remote (e.g., cool â†’ heat).
      selector:
        entity:
          domain: input_text

    # Temperature Settings - Simple Mode
    temperature_settings:
      name: "Temperature Settings"
      icon: mdi:thermometer
      collapsed: false
      input:
        temperature_sensor:
          name: Temperature Sensor(s) (Optional)
          description: |
            External temperature sensor(s) for **more accurate room temperature readings**.

            **NEW v3.9.0:** Supports **multiple sensors** for rooms cooled/heated by one AC unit!

            If not configured, the system will use your A/C unit's built-in sensor.

            **Multi-Sensor Strategy (automatic):**
            â€¢ **Cooling Mode:** Uses WARMEST room (ensures all rooms cool down)
            â€¢ **Heating Mode:** Uses COLDEST room (ensures all rooms warm up)
            â€¢ **Both/Neither:** Uses AVERAGE temperature

            **Example:** Living Room AC also cools Media Room
            â†’ Add both room sensors â†’ System ensures both reach target temperature

            **Best practices for external sensors:**

            â€¢ Place at seated height (1-1.5m from floor)
            â€¢ Position away from direct sunlight and heat sources
            â€¢ Central location in the room for representative readings
            â€¢ Avoid drafty areas or corners

            **Benefit:** External sensors provide significantly better temperature control accuracy.
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: true
        
        use_average_temperature:
          name: Use Average Temperature
          description: |
            Controls how temperature is calculated when using **multiple A/C units**.

            â€¢ **ON:** Average temperatures from all A/C units
            â€¢ **OFF:** Use temperature from the first A/C unit only

            **Important:** Turn OFF when using a single external sensor for all units to avoid conflicts.
          default: true
          selector:
            boolean:
        
        # SIMPLE CONTROLS (Always visible)
        target_temperature:
          name: ğŸ¯ Target Temperature
          description: |
            Your **ideal room temperature** in degrees Celsius.

            This is the **main temperature control** that affects all other zones proportionally.

            Adjusting this value will shift all temperature thresholds up or down together.

            **Auto mode target:** This is where the system will maintain temperature.
          default: 23
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
              mode: slider
        
        comfort_zone_width:
          name: ğŸ“ Comfort Zone Range
          description: |
            Temperature variation tolerance around target **(Â±Â°C)**:

            â€¢ **Wider** = more tolerance, less switching, more efficient
            â€¢ **Narrower** = tighter control, more activity, less efficient

            **Example:** Target 23Â°C with Â±2Â°C = comfort zone 21-25Â°C (saves 40-60% power)
          default: 2
          selector:
            number:
              min: 0.5
              max: 3
              step: 0.1
              unit_of_measurement: "Â°C"
              mode: slider

        target_overshoot_strategy:
          name: ğŸ¯ Target Overshoot Strategy
          description: |
            **How far past target temperature** should AC run before turning off?

            Overshooting creates a buffer zone that prevents rapid on/off cycling while maintaining comfort.

            â€¢ **None:** No overshoot - Turns off exactly at target temp âš ï¸ **May cause rapid cycling**
            â€¢ **Minimal:** 0.5Â°C past target - Precise control, may cycle more often in extreme conditions
            â€¢ **Moderate:** Halfway to comfort zone edge - Balanced comfort and efficiency â­ **RECOMMENDED**
            â€¢ **Maximum:** Full comfort zone edge - Maximum cycling prevention, larger temperature swings

            **Example with target 22.5Â°C, comfort zone 21.1-23.9Â°C:**
            â€¢ Cooling stops at: **22.5Â°C** (none) / **22.0Â°C** (minimal) / **21.8Â°C** (moderate) / **21.1Â°C** (maximum)
            â€¢ Heating stops at: **22.5Â°C** (none) / **23.0Â°C** (minimal) / **23.2Â°C** (moderate) / **23.9Â°C** (maximum)

            **When to use:**
            â€¢ **None:** Only if you understand cycling risks and want pure target-based operation
            â€¢ **Minimal:** Bedrooms, offices where precise temp control is critical
            â€¢ **Moderate:** Most rooms - best balance (default)
            â€¢ **Maximum:** High thermal load rooms, extreme outdoor temps, or frequent cycling issues
          default: moderate
          selector:
            select:
              options:
                - label: "None (No overshoot - âš ï¸ May cause rapid cycling)"
                  value: "none"
                - label: "Minimal (0.5Â°C overshoot)"
                  value: "minimal"
                - label: "Moderate (Halfway to comfort edge) - RECOMMENDED"
                  value: "moderate"
                - label: "Maximum (Full comfort zone)"
                  value: "maximum"

        enable_heating_mode:
          name: ğŸ”¥ Enable Heating Mode
          description: |
            **Control whether heating activates** when temperature drops below comfort zone.
            
            â€¢ **ON:** Heating will activate when room gets cold (full climate control)
            â€¢ **OFF:** Heating disabled - cooling only (perfect for people who run hot)
            
            **Use cases:** Seasonal control, energy management, personal preference, cooling-only setups.
          default: true
          selector:
            boolean:
        
        enable_cooling_mode:
          name: â„ï¸ Enable Cooling Mode
          description: |
            **Control whether cooling activates** when temperature rises above comfort zone.
            
            â€¢ **ON:** Cooling will activate when room gets warm (full climate control)
            â€¢ **OFF:** Cooling disabled - heating only (perfect for cold climates)
            
            **Use cases:** Seasonal control, energy management, heating-only setups, winter operation.
          default: true
          selector:
            boolean:
        
        temperature_aggressiveness:
          name: âš¡ Response Aggressiveness
          description: |
            **Controls how quickly the AC reaches maximum power** when temperature goes outside comfort zone.

            **What this actually does:**
            - Higher values = AC ramps to HIGH/MAX cooling faster = reaches target temp quicker
            - Lower values = AC escalates gradually through LOWâ†’MEDIUMâ†’HIGH = more efficient but slower

            **Settings explained:**

            â€¢ **1 = Gentle** - AC won't hit maximum power until 3Â°C past comfort zone
              â””â”€ Most efficient, but AC may run for hours on low power

            â€¢ **2 = Smooth** (Default) - Medium power at comfort edge, high at +1Â°C, max at +2Â°C
              â””â”€ Balanced approach for most situations

            â€¢ **3 = Balanced** - Maximum power kicks in at 2Â°C past comfort zone
              â””â”€ Good balance between speed and efficiency

            â€¢ **5 = Aggressive** - Maximum power immediately at 1Â°C past comfort zone
              â””â”€ Fastest response, reaches target quickly, uses more power

            **Real Example** (Target: 23Â°C, Comfort Zone: Â±2Â°C = 21-25Â°C):

            **With Aggressiveness = 2 (Default):**
            - 21-25Â°C â†’ AC OFF (in comfort zone)
            - 25.1Â°C â†’ LOW cooling starts
            - 26Â°C â†’ MEDIUM cooling (+1Â°C past edge)
            - 27Â°C â†’ HIGH cooling (+2Â°C past edge)

            **With Aggressiveness = 5 (Aggressive):**
            - 21-25Â°C â†’ AC OFF (in comfort zone)
            - 25.1Â°C â†’ LOW cooling starts
            - 26Â°C â†’ HIGH cooling already! (+1Â°C triggers max power)

            **ğŸ’¡ Choose based on your priority:**
            - AC running too long trying to reach target? â†’ Increase to 3-5
            - Want maximum efficiency and don't mind slower response? â†’ Use 1-2
          default: 2
          selector:
            number:
              min: 1
              max: 5
              step: 1
              mode: slider
        
        # ADVANCED OVERRIDES (Hidden by default)
        enable_advanced_temp:
          name: ğŸ”§ Enable Advanced Temperature Controls
          description: |
            Manually override **individual temperature thresholds**.

            â€¢ For users who want **precise control** over all thresholds
            â€¢ Overrides automatic calculations based on target temperature
            â€¢ Allows fine-tuning of comfort zones and trigger points

            **Recommendation:** Most users should leave this disabled and use the base target temperature.
          default: false
          selector:
            boolean:
        
        # These are only shown when advanced mode is enabled
        comfort_min_temp:
          name: Comfort Zone Minimum (Advanced)
          description: |
            Override auto-calculated **minimum comfort temperature**.

            â€¢ **Bottom of comfort zone** where heating may start
            â€¢ Should be lower than comfort maximum
            â€¢ Typically 1-2Â°C below target temperature

            **Behavior:** When room is above this, system stays in eco/off mode.
          default: 21
          selector:
            number:
              min: 18
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"
        
        comfort_max_temp:
          name: Comfort Zone Maximum (Advanced)
          description: |
            Override auto-calculated **maximum comfort temperature**.

            â€¢ **Top of comfort zone** where cooling may start
            â€¢ Should be higher than comfort minimum
            â€¢ Typically 1-2Â°C above target temperature

            **Behavior:** When room is below this, system stays in eco/off mode.
          default: 23
          selector:
            number:
              min: 20
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        cooling_target_temp:
          name: Cooling Target (Advanced)
          description: |
            Override **cooling target temperature**.

            â€¢ **What temperature to cool the room to**
            â€¢ Used when room exceeds comfort maximum
            â€¢ Usually same as or slightly below base target

            **Behavior:** System will cool to this temperature then switch to eco/off.
          default: 22
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        heating_target_temp:
          name: Heating Target (Advanced)
          description: |
            Override **heating target temperature**.

            â€¢ **What temperature to heat the room to**
            â€¢ Used when room falls below comfort minimum
            â€¢ Usually same as or slightly above base target

            **Behavior:** System will heat to this temperature then switch to eco/off.
          default: 23
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        precool_target_temp:
          name: Pre-cooling Target (Advanced)
          description: |
            Override **pre-conditioning target temperature**.

            â€¢ **Temperature to achieve before you arrive home**
            â€¢ Used with proximity sensors and approaching detection
            â€¢ Should be comfortable for immediate occupancy

            **Recommendation:** Usually matches your preferred target temperature.
          default: 22
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        cooling_low_temp:
          name: Low Cooling Threshold (Advanced)
          description: |
            Override **low cooling trigger temperature**.

            â€¢ **Temperature that triggers gentle cooling mode**
            â€¢ When room just exceeds comfort zone, uses minimum fan speed
            â€¢ Should be just above comfort maximum (e.g., 24.1Â°C)

            **Purpose:** Gentle cooling when slightly warm.
          default: 24.1
          selector:
            number:
              min: 20
              max: 35
              step: 0.1
              unit_of_measurement: "Â°C"
        
        cooling_medium_temp:
          name: Medium Cooling Threshold (Advanced)
          description: |
            Override **medium cooling trigger temperature**.

            â€¢ **Temperature that triggers moderate cooling mode**
            â€¢ When room is moderately warm, uses medium fan speed
            â€¢ Should be 1Â°C above comfort maximum (e.g., 25Â°C)

            **Purpose:** Balanced cooling for moderately warm conditions.
          default: 25
          selector:
            number:
              min: 20
              max: 35
              step: 0.5
              unit_of_measurement: "Â°C"
        
        cooling_high_temp:
          name: High Cooling Threshold (Advanced)
          description: |
            Override **high cooling trigger temperature**.

            â€¢ **Temperature that triggers maximum cooling mode**
            â€¢ When room is very hot, uses maximum fan speed
            â€¢ Should be 2Â°C above comfort maximum (e.g., 26Â°C)

            **Purpose:** Emergency cooling when room gets very hot.
          default: 26
          selector:
            number:
              min: 20
              max: 35
              step: 0.5
              unit_of_measurement: "Â°C"
        
        heating_low_temp:
          name: Low Heating Threshold (Advanced)
          description: |
            Override **low heating trigger temperature**.

            â€¢ **Temperature that triggers gentle heating mode**
            â€¢ When room just falls below comfort zone, uses minimum fan speed
            â€¢ Should be just below comfort minimum (e.g., 19.9Â°C)

            **Purpose:** Gentle heating when slightly cool.
          default: 19.9
          selector:
            number:
              min: 10
              max: 25
              step: 0.1
              unit_of_measurement: "Â°C"
        
        heating_medium_temp:
          name: Medium Heating Threshold (Advanced)
          description: |
            Override **medium heating trigger temperature**.

            â€¢ **Temperature that triggers moderate heating mode**
            â€¢ When room is moderately cool, uses medium fan speed
            â€¢ Should be 1Â°C below comfort minimum (e.g., 19Â°C)

            **Purpose:** Balanced heating for moderately cool conditions.
          default: 19
          selector:
            number:
              min: 10
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"
        
        heating_high_temp:
          name: High Heating Threshold (Advanced)
          description: |
            Override **high heating trigger temperature**.

            â€¢ **Temperature that triggers maximum heating mode**
            â€¢ When room is very cold, uses maximum fan speed
            â€¢ Should be 2Â°C below comfort minimum (e.g., 18Â°C)

            **Purpose:** Emergency heating when room gets very cold.
          default: 18
          selector:
            number:
              min: 10
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"

    # Presence & Proximity Settings
    presence_settings:
      name: "Presence & Proximity"
      icon: mdi:account-multiple
      collapsed: true
      input:
        presence_persons:
          name: People to Track
          description: |
            Select people for **presence detection**.

            â€¢ **Used for away mode detection**
            â€¢ Triggers pre-conditioning when approaching home
            â€¢ Works with proximity/direction sensors for advanced features
          default: []
          selector:
            entity:
              multiple: true
              domain: person
        
        presence_devices:
          name: Presence Detection Devices
          description: |
            Additional devices indicating presence when **person entities aren't sufficient**.

            **Examples:**

            â€¢ PC power state sensors
            â€¢ Smart TV power sensors
            â€¢ Gaming console entities
            â€¢ Workstation activity sensors

            **Purpose:** These supplement person presence detection for more accurate home/away detection.
          default: []
          selector:
            entity:
              multiple: true
        
        proximity_sensor:
          name: Proximity Distance Sensor
          description: |
            Sensor tracking **nearest person's distance from home**.

            â€¢ **Used for proximity-based pre-conditioning**
            â€¢ Works with direction sensor for smart approach detection
            â€¢ **Example:** `sensor.home_nearest_distance`

            **Requirement:** Home Assistant proximity integration setup.
          default: sensor.home_nearest_distance
          selector:
            entity:
              domain: sensor
        
        direction_sensor:
          name: Direction of Travel Sensor
          description: |
            Sensor tracking **direction of travel** relative to home.

            **States:**

            â€¢ **towards:** Approaching home
            â€¢ **away:** Moving away from home
            â€¢ **arrived:** At home location

            **Example:** `sensor.home_nearest_direction_of_travel`
          default: sensor.home_nearest_direction_of_travel
          selector:
            entity:
              domain: sensor
        
        home_zone_distance:
          name: Home Zone Distance
          description: |
            Distance defining your **"home zone" boundary**. Controls all proximity behaviors:

            â€¢ **Within this distance:** Maintain comfort temperature, pre-condition when approaching
            â€¢ **Beyond this distance:** Switch to away mode (off or eco mode)
          default: 5000
          selector:
            number:
              min: 1000
              max: 10000
              step: 500
              unit_of_measurement: m

    # Away Mode Settings
    away_settings:
      name: "Away Mode Settings"
      icon: mdi:home-export-outline
      collapsed: true
      input:
        enable_away_mode:
          name: Enable Away Mode
          description: |
            **Turn off or set to eco** when everyone leaves.

            Automatically manages climate control based on home occupancy for **energy savings**.
          default: true
          selector:
            boolean:
        
        away_mode_action:
          name: Away Mode Action
          description: |
            What to do when **everyone leaves home**:

            â€¢ **OFF:** Turn AC completely off (saves most energy, slow to cool when returning)
            â€¢ **ECO:** Reduce to eco mode with wider temperature range (balanced energy savings)
            â€¢ **MAINTAIN:** Keep current temperature (wastes energy but fastest comfort when returning)
          default: "eco"
          selector:
            select:
              options:
                - "off"
                - "eco"
                - "maintain"
        
        enable_pre_conditioning:
          name: Enable Pre-conditioning
          description: |
            **Pre-cool/heat when approaching home**.

            Uses proximity sensors to start conditioning before arrival for **immediate comfort**.
          default: true
          selector:
            boolean:

    # Smart Mode Settings
    smart_mode_settings:
      name: "Smart Mode Settings"
      icon: mdi:brain
      collapsed: true
      input:
        helper_control_mode:
          name: Control Mode Helper Entity
          description: |
            Input Select helper for **control mode selection**.

            **Required options:**

            â€¢ **Auto:** Temperature-based control
            â€¢ **Manual:** User-controlled operation
            â€¢ **Smart:** Advanced presence-aware control

            **Example:** `input_select.climate_control_mode_living_room`
          selector:
            entity:
              domain: input_select
        
        helper_presence_detected:
          name: Last Presence Helper Entity
          description: |
            **Input DateTime helper** to track when presence was last detected.

            â€¢ **Used for** presence timeout calculations
            â€¢ **Updated automatically** by the system
            â€¢ **Required** for Smart Mode functionality

            **Example:** `input_datetime.presence_last_detected_living_room`
          selector:
            entity:
              domain: input_datetime
        
        helper_proximity_override:
          name: Proximity Override Helper Entity
          description: |
            **Input Boolean helper** for emergency temperature override.

            â€¢ **Bypasses all automation** when enabled
            â€¢ **Allows manual control** during emergencies
            â€¢ **Auto-resets** after specified duration

            **Example:** `input_boolean.climate_proximity_override_living_room`
          selector:
            entity:
              domain: input_boolean
        
        presence_timeout_minutes:
          name: Presence Timeout
          description: |
            **Minutes to wait** after leaving room before taking action.

            â€¢ **Prevents shutdown** during brief departures
            â€¢ **Common scenarios:** bathroom breaks, quick errands
            â€¢ **Recommended:** 15-30 minutes for comfort balance

            **Trade-off:** Lower values save more energy but may cause comfort issues.
          default: 15
          selector:
            number:
              min: 5
              max: 60
              step: 5
              unit_of_measurement: minutes

        presence_confirmation_delay:
          name: Presence Confirmation Delay (Smart Mode)
          description: |
            **How long presence must be continuously detected** before turning AC ON in Smart mode.

            â€¢ **0 minutes:** Immediate response (default, current behavior)
            â€¢ **2-5 minutes:** Filter brief visits and BLE sensor flickers
            â€¢ **10-15 minutes:** Moderate filtering for high-traffic areas
            â€¢ **20-30 minutes:** Only activate for confirmed extended stays

            **Use cases:**
            â€¢ **Bedrooms with BLE:** 3-5 min to filter boundary flickers
            â€¢ **High-traffic rooms:** 10-20 min to avoid activating when passing through
            â€¢ **Guest rooms:** 20-30 min to ensure actual occupancy
            â€¢ **Dedicated rooms (office, gaming):** 0 min for immediate comfort

            **Note:** This only affects initial turn-on. Once running, AC stays on for the full `presence_timeout` period after you leave.
          default: 0
          selector:
            number:
              min: 0
              max: 30
              step: 1
              unit_of_measurement: minutes
              mode: slider

        room_presence_sensors:
          name: Room Presence Sensors (Optional)
          description: |
            **BLE, PIR or other sensors** for room-specific presence detection.

            **Supported sensor types:**

            â€¢ **BLE area sensors:** Reports room names (e.g., "Office", "Living Room")
            â€¢ **PIR sensors:** Binary sensors reporting on/off
            â€¢ **mmWave sensors:** Human presence detection
            â€¢ **Smart device sensors:** Phone/device presence

            **Example:** `sensor.phone_ble_area`, `binary_sensor.living_room_motion`
          default: []
          selector:
            entity:
              multiple: true
              domain: 
                - binary_sensor
                - sensor
        
        presence_validation_mode:
          name: Presence Validation Mode
          description: |
            **How presence sensors work together** to detect room occupancy:

            **ğŸ¯ RECOMMENDED MODES:**
            â€¢ **BLE_MOTION** - BLE + Motion (BOTH required) - Best for bedrooms, prevents motion blips â­
            â€¢ **BLE_BED** - BLE + Bed sensor (BOTH required) - Best for sleep-only detection
            â€¢ **BLE_SMART** - BLE + (Motion OR Bed) - Intelligent: awake=motion, sleeping=bed sensor

            **âš ï¸ SINGLE SENSOR MODES (Use with caution):**
            â€¢ **MOTION_ONLY** - Motion sensor only âš ï¸ WARNING: Random motion blips will turn on AC!
            â€¢ **BLE_ONLY** - BLE sensor only âš ï¸ WARNING: Phone in adjacent room will turn on AC!
            â€¢ **BED_ONLY** - Bed/occupancy sensor only - Reliable for beds with weight sensors

            **ğŸ”§ FLEXIBLE MODES:**
            â€¢ **ANY** - Any sensor triggers (most responsive, may have false positives)
            â€¢ **ALL** - All sensors must agree (most accurate, may miss presence)
            â€¢ **MAJORITY** - Most sensors must agree (3+ sensors recommended)
            â€¢ **BLE_PLUS** - BLE + at least one other sensor

            **ğŸ“‹ Mode Details:**

            **BLE_MOTION** (Recommended for bedrooms with motion sensors):
            âœ… Requires: BLE detected AND Motion detected
            âœ… Prevents: Motion blips from turning on AC without you in room
            âœ… Prevents: BLE in adjacent room from turning on AC
            âŒ Won't detect: If phone is charging elsewhere while you're in bed

            **BLE_BED** (Recommended for bedrooms with bed sensors):
            âœ… Requires: BLE detected AND Bed sensor active
            âœ… Best for: Sleep detection with bed occupancy sensors
            âœ… Prevents: False triggers from motion or BLE alone
            âŒ Won't detect: If you're awake in room but not in bed

            **BLE_SMART** (Best for bedrooms with motion AND bed sensors):
            âœ… Requires: BLE detected AND (Motion OR Bed sensor)
            âœ… Detects: Awake (BLE+motion) or Sleeping (BLE+bed)
            âœ… Flexible: Works whether you're moving around or in bed
            âŒ Won't detect: If phone is charging elsewhere

            **MOTION_ONLY** âš ï¸ WARNING:
            âŒ Random motion blips trigger AC even when room is empty
            âŒ Shadows, pets, fans can cause false activation
            âš ï¸ Use presence_confirmation_delay (5+ min) to reduce false positives
            âœ… Only use if: No other sensors available and you understand the risk

            **BLE_ONLY** âš ï¸ WARNING:
            âŒ Phone in adjacent room will turn on AC
            âŒ Phone left in room will keep AC running when you leave
            âœ… Only use if: Room has thick walls/good BLE isolation

            **BED_ONLY** (Reliable if you have a good bed sensor):
            âœ… Requires: Bed occupancy sensor active
            âœ… Reliable: Weight-based bed sensors rarely have false positives
            âŒ Won't detect: Presence when not in bed (awake in room)
            âœ… Use for: Bedrooms where AC should ONLY run while sleeping

            **ğŸ’¡ Recommendations:**
            â€¢ **Master Bedroom**: BLE_MOTION or BLE_SMART (prevents motion blips) â­
            â€¢ **Guest Bedroom**: BED_ONLY (only cool while sleeping)
            â€¢ **Living Room**: BLE_MOTION or BLE_PLUS (prevent false triggers)
            â€¢ **Office**: BLE_MOTION (ensures you're actually there)
            â€¢ **Single Sensor Setup**: Use MOTION_ONLY/BLE_ONLY with 5+ min confirmation delay âš ï¸

            **ğŸ›¡ï¸ False Trigger Protection:**
            All modes work with `presence_confirmation_delay` to prevent brief sensor blips from activating AC.
            Recommended: 2-5 minutes for motion-based modes, 0-1 minute for BLE+combination modes.
          default: "any"
          selector:
            select:
              options:
                - label: "ğŸ¯ BLE_MOTION - BLE + Motion (BOTH required) â­ Recommended"
                  value: "ble_motion"
                - label: "ğŸ¯ BLE_BED - BLE + Bed sensor (BOTH required)"
                  value: "ble_bed"
                - label: "ğŸ¯ BLE_SMART - BLE + (Motion OR Bed) - Intelligent"
                  value: "ble_smart"
                - label: "âš ï¸ MOTION_ONLY - Motion only (WARNING: Random blips trigger AC!)"
                  value: "motion_only"
                - label: "âš ï¸ BLE_ONLY - BLE only (WARNING: Adjacent room triggers!)"
                  value: "ble_only"
                - label: "BED_ONLY - Bed/occupancy sensor only (Reliable)"
                  value: "bed_only"
                - label: "ANY - Any sensor triggers (Default, responsive but may have false positives)"
                  value: "any"
                - label: "ALL - All sensors must agree"
                  value: "all"
                - label: "MAJORITY - Most sensors must agree"
                  value: "majority"
                - label: "BLE_PLUS - BLE + at least one other"
                  value: "ble_plus"
        
        # Room name is now configured at the top as a required field
        
        adjacent_room_names:
          name: Adjacent Room Names (Open-Plan Spaces)
          description: |
            **For open-plan spaces**, specify adjacent room names that should also trigger this AC.
            
            **Use case:** Your Living Room AC covers an open Kitchen/Living/Dining area, but BLE 
            sensors report specific room names. This allows the AC to activate when you're detected
            in ANY of these connected spaces.
            
            **âš ï¸ CRITICAL: Check Your BLE Sensor Format First!**
            Before configuring, check **Developer Tools â†’ States** to see exactly how your BLE sensor reports room names:
            
            â€¢ **If sensor shows:** `living room` â†’ **Enter:** `Living Room`

            â€¢ **If sensor shows:** `living_room` (with underscores) â†’ **Enter:** `living_room`

            â€¢ **If sensor shows:** `livingroom` â†’ **Enter:** `livingroom`
            
            **Format must match exactly** (case-insensitive but spaces/underscores matter).
            
            **Examples based on your BLE sensor format:**
            â€¢ **Spaces format:** Kitchen, Dining Room, Living Room
            â€¢ **Underscore format:** kitchen, dining_room, living_room
            â€¢ **No spaces format:** kitchen, diningroom, livingroom
            
            **Example Configuration (assuming spaces format):**
            â€¢ **Room Name:** Living Room (main room from top of config)
            â€¢ **Adjacent Rooms:** Kitchen, Dining Room, Family Room
            â€¢ **Result:** AC activates when BLE detects Living Room, Kitchen, Dining Room, OR Family Room
            
            **âš ï¸ IMPORTANT for SMART/BLE_PLUS modes:**
            When using validation modes that require motion + BLE, you MUST also add the motion 
            sensors from adjacent rooms to the "Room Presence Sensors" list above.
            
            **Example for SMART mode (spaces format):**
            â€¢ **Adjacent Room Names:** Kitchen, Family Room  (match BLE sensor format)
            â€¢ **Room Presence Sensors must include:**
              - `sensor.phone_ble_area` (BLE sensor)

              - `binary_sensor.living_room_motion` (main room)

              - `binary_sensor.kitchen_motion` (adjacent room motion)
              
              - `binary_sensor.family_room_motion` (adjacent room motion)
            
            **Leave empty if not using open-plan space detection.**
          default: ""
          selector:
            text:
        
        smart_mode_behavior:
          name: Smart Mode Room Absence Behavior
          description: |
            What to do when **room presence sensors detect absence** (after timeout):

            â€¢ **ECO:** Reduce to eco mode (saves power, maintains some comfort)
            â€¢ **MAINTAIN:** Keep current temperature (comfort over efficiency)
            â€¢ **OFF:** Turn off completely (maximum power savings)

            **Note:** Only applies when still home but room is empty.
          default: "eco"
          selector:
            select:
              options:
                - "eco"
                - "maintain"
                - "off"

        temp_stability_enabled:
          name: Temperature Stability Auto-Off
          description: |
            **Automatically turn off AC** when temperature remains stable for specified duration.

            **How it works:** Detects when AC job is complete (thermal equilibrium reached) to save energy.

            **Note:** Works even when people are still in room. **Requires** temperature history helper.
          default: false
          selector:
            boolean:

        stability_tolerance:
          name: Stability Temperature Tolerance
          description: |
            Temperature range considered **"stable"** for auto-off detection.

            **Sensitivity levels:**

            â€¢ **Â±0.3Â°C:** High sensitivity (recommended for most users)
            â€¢ **Â±0.5Â°C:** Moderate sensitivity (balanced approach)
            â€¢ **Â±1.0Â°C:** Low sensitivity (less aggressive)

            **Rule:** Smaller values trigger auto-off sooner, larger values wait longer.
          default: 0.3
          selector:
            number:
              min: 0.1
              max: 5.0
              step: 0.1
              unit_of_measurement: "Â°C"

        stability_duration:
          name: Stability Duration
          description: |
            **Minutes** temperature must remain stable before auto-off triggers.

            **Timing strategies:**

            â€¢ **10-15 minutes:** Aggressive energy savings
            â€¢ **20-25 minutes:** Balanced efficiency and comfort
            â€¢ **25-30 minutes:** Conservative, prioritizes comfort

            **Trade-off:** Shorter duration saves more energy but may cause temperature fluctuations.
          default: 15
          selector:
            number:
              min: 10
              max: 30
              step: 5
              unit_of_measurement: "min"

        stability_behavior:
          name: Stability Auto-Off Action  
          description: |
            **Triggered when temperature becomes STABLE** (Â±1Â°C for 15+ minutes):
            
            **Purpose:** Recognizes AC achieved its goal and temperature isn't changing
            
            â€¢ **OFF:** Turn off completely (maximum energy savings)
            â€¢ **ECO:** Switch to eco mode (moderate energy savings, maintains some comfort)
            
            **Different from Eco Mode:** This responds to temperature **stability**, not comfort zone
          default: "off"
          selector:
            select:
              options:
                - "off"
                - "eco"

    # Scheduling Settings (Optional)
    scheduling_settings:
      name: "Time-Based Scheduling"
      icon: mdi:calendar-clock
      collapsed: true
      input:
        enable_scheduling:
          name: Enable Time-Based Scheduling
          description: |
            **Automatically adjust temperatures** based on time of day.

            **Benefits:**

            â€¢ **Optimized comfort** for different activities
            â€¢ **Energy savings** during sleeping hours
            â€¢ Cooler mornings, warmer evenings as needed
            â€¢ Separate weekend schedule option

            **Note:** Overrides base target temperature when enabled.
          default: false
          selector:
            boolean:
        
        morning_temp:
          name: Morning Temperature (6am-9am)
          description: |
            **Temperature target** for morning hours **(6am-9am)**.

            â€¢ **Typically cooler** for waking up comfort
            â€¢ Good for productivity during morning routines
            â€¢ Consider personal preferences and climate
          default: 22
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        day_temp:
          name: Day Temperature (9am-6pm)
          description: |
            **Temperature target** for daytime hours **(9am-6pm)**.

            â€¢ **Optimize** for work/activity comfort
            â€¢ Balance productivity and energy efficiency
            â€¢ Consider sunlight and heat gain during day
          default: 23
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        evening_temp:
          name: Evening Temperature (6pm-10pm)
          description: |
            **Temperature target** for evening hours **(6pm-10pm)**.

            â€¢ **Relaxation** and family time comfort
            â€¢ May prefer slightly warmer for leisure
            â€¢ Accounts for reduced outdoor temperatures
          default: 23
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        night_temp:
          name: Night Temperature (10pm-6am)
          description: |
            **Temperature target** for sleeping hours **(10pm-6am)**.

            â€¢ **Sleep research** recommends 18-21Â°C for best rest
            â€¢ **Cooler temperatures** promote deeper sleep
            â€¢ **Energy savings** during extended periods
          default: 24
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        enable_weekend_schedule:
          name: Different Weekend Schedule
          description: |
            Use **different temperature schedule** on weekends.

            â€¢ **Later wake times** with extended morning periods
            â€¢ Different activity patterns and comfort needs
            â€¢ More flexible scheduling for leisure days

            **Note:** Weekend morning period: 6am-10am (vs weekday 6am-9am)
          default: false
          selector:
            boolean:
        
        weekend_morning_temp:
          name: Weekend Morning Temperature
          description: |
            **Weekend morning temperature** **(6am-10am)**.

            â€¢ **Extended morning period** for leisurely weekends
            â€¢ May prefer warmer for relaxed mornings
            â€¢ Adjust based on weekend routines and preferences
          default: 23
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        weekend_day_temp:
          name: Weekend Day Temperature
          description: |
            **Weekend daytime temperature** **(10am-10pm)**.

            â€¢ **Extended day period** for weekend activities
            â€¢ Covers both day and evening in one setting
            â€¢ Simplifies weekend scheduling

            **Note:** Single temperature for entire active weekend period.
          default: 23
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"
        
        weekend_night_temp:
          name: Weekend Night Temperature
          description: |
            **Weekend night temperature** **(10pm-6am)**.

            â€¢ **Same sleep optimization** as weeknight temperature
            â€¢ May differ if weekend bedtime routines vary
            â€¢ Maintains consistent sleep comfort

            Consider if weekend sleep patterns require different settings.
          default: 24
          selector:
            number:
              min: 18
              max: 28
              step: 0.5
              unit_of_measurement: "Â°C"

    # Window Detection Settings (Optional)
    window_detection_settings:
      name: "Window Detection"
      icon: mdi:window-open
      collapsed: true
      input:
        enable_window_detection:
          name: Enable Window Detection
          description: |
            **Automatically turn off AC** when windows or doors are opened.

            **Benefits:**

            â€¢ **Prevents** cooling/heating the outdoors
            â€¢ **Significant energy savings**
            â€¢ Protects AC equipment from overwork
            â€¢ **Automatic resumption** when closed

            **Requirement:** Binary sensors on doors/windows.
          default: false
          selector:
            boolean:
        
        window_sensors:
          name: Window/Door Sensors
          description: |
            Select sensors that should **turn off AC** when opened.

            **Compatible sensors:**

            â€¢ **Door contact sensors**
            â€¢ **Window opening sensors**
            â€¢ **Magnetic reed switches**
            â€¢ **Smart window/door sensors**

            **Behavior:** All selected sensors will trigger AC shutdown when opened.
          default: []
          selector:
            entity:
              multiple: true
              domain: binary_sensor
        
        window_open_delay:
          name: Window Open Delay
          description: |
            **Minutes to wait** after window opens before turning off AC.

            â€¢ **Prevents false triggers** from brief openings
            â€¢ **0 minutes:** Immediate shutdown (most responsive)
            â€¢ **1-2 minutes:** Balanced (recommended)
            â€¢ **3+ minutes:** Delayed response

            **Result:** Brief openings won't unnecessarily stop your AC.
          default: 2
          selector:
            number:
              min: 0
              max: 10
              step: 1
              unit_of_measurement: "minutes"
        
        window_close_delay:
          name: Window Close Delay
          description: |
            **Minutes to wait** after window closes before resuming AC.

            â€¢ **Ensures window** is properly closed before restarting
            â€¢ Allows time for air exchange to stabilize
            â€¢ **Prevents rapid on/off cycling**

            **Recommendation:** Short delay to confirm sensor stability.
          default: 1
          selector:
            number:
              min: 0
              max: 10
              step: 1
              unit_of_measurement: "minutes"

    # Outside Temperature Compensation Settings (Optional)
    outside_temp_compensation_settings:
      name: "Outside Temperature Compensation"
      icon: mdi:sun-thermometer
      collapsed: true
      input:
        enable_outside_temp_compensation:
          name: Enable Outside Temperature Compensation
          description: |
            **Make AC work HARDER on extreme outdoor temperature days** to achieve your target.

            **How it works:**

            â€¢ **Hot outdoor weather (Cooling):** Set AC cooler than target + boost fan speed to counteract heat influx
            â€¢ **Cold outdoor weather (Heating):** Set heater warmer than target + boost fan speed to counteract cold influx
            â€¢ **Mild outdoor weather:** Use normal settings

            **Example:** 35Â°C outside, 22Â°C target â†’ AC set to 20.5Â°C with Fan 4 start (undershoots to maintain 22Â°C)

            **Result:** Your target temperature is ACHIEVED faster and MAINTAINED even on extreme days.
          default: false
          selector:
            boolean:

        weather_entity:
          name: Weather Entity
          description: |
            **Weather integration** for outdoor temperature data.

            â€¢ **Provides base** outdoor temperature readings
            â€¢ Usually `weather.home` or `weather.forecast_home`
            â€¢ **Fallback** if no dedicated outdoor sensor available

            **Recommendation:** Most users should start with their default weather integration.
          default: weather.home
          selector:
            entity:
              domain: weather

        outdoor_temp_sensor:
          name: Outdoor Temperature Sensor (Optional)
          description: |
            **External temperature sensor** for more accurate readings.

            â€¢ **More precise** than weather service data
            â€¢ **Real-time local conditions** vs forecast data
            â€¢ **Optional:** Falls back to weather entity if not set

            **Recommended** for users with outdoor temperature sensors (e.g., Daikin outdoor units).
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature

        outside_compensation_factor:
          name: Outside Compensation Factor
          description: |
            **How aggressively to compensate for outdoor temperature** (0-1).

            **Factor levels:**

            â€¢ **0.0:** No compensation (disabled)
            â€¢ **0.1-0.2:** Mild compensation (recommended for most climates)
            â€¢ **0.3-0.5:** Moderate compensation (hot/cold climates)
            â€¢ **0.6-1.0:** Aggressive compensation (extreme climates)

            **Example:** 0.2 factor with 35Â°C outside (10Â°C above neutral) â†’ 2Â°C undershoot (AC set to 20Â°C for 22Â°C target)
          default: 0.2
          selector:
            number:
              min: 0
              max: 1
              step: 0.1

        max_outside_compensation:
          name: Maximum Outside Compensation
          description: |
            **Maximum degrees** to undershoot/overshoot AC setpoint.

            â€¢ **Safety limit** to prevent extreme AC settings
            â€¢ **1-2Â°C:** Conservative, small adjustments
            â€¢ **3-4Â°C:** Moderate, noticeable compensation
            â€¢ **5Â°C:** Aggressive, maximum compensation

            **Example:** 2Â°C max â†’ AC won't go below 20Â°C for 22Â°C cooling target, or above 24Â°C for 22Â°C heating target.
          default: 2
          selector:
            number:
              min: 1
              max: 5
              step: 0.5
              unit_of_measurement: "Â°C"

        outside_compensation_base_temp:
          name: Outside Compensation Base Temperature
          description: |
            **Outdoor temperature** considered "neutral" (no compensation needed).

            â€¢ **Temperature where outdoor conditions don't fight your AC**
            â€¢ **25Â°C:** Good baseline for most climates
            â€¢ **Above baseline (cooling):** AC undershoots to counteract heat influx
            â€¢ **Below baseline (heating):** Heater overshoots to counteract cold influx

            **Recommendation:** Adjust based on your local climate and comfort preferences.
          default: 25
          selector:
            number:
              min: 20
              max: 30
              step: 1
              unit_of_measurement: "Â°C"

    # Fan & Swing Settings
    fan_settings:
      name: "Fan & Swing Settings"
      icon: mdi:fan
      collapsed: true
      input:
        fan_speed_max:
          name: Maximum Fan Speed
          description: |
            **Fan speed** for maximum cooling/heating conditions.

            â€¢ **Auto:** Let AC system manage fan speed
            â€¢ **Level 5/5:** Maximum airflow for rapid temperature changes
            â€¢ System auto-detects your AC's fan speed format

            **Used when:** Temperature is far from target or during initial conditioning.
          default: "Level 5"
          selector:
            select:
              options:
                - "Auto"
                - "auto"
                - "Quiet"
                - "Silence"
                - "Level 1"
                - "Level 2"
                - "Level 3"
                - "Level 4"
                - "Level 5"
                - "1"
                - "2"
                - "3"
                - "4"
                - "5"
                - "high"
                - "medium"
                - "low"
        
        fan_speed_medium:
          name: Medium Fan Speed
          description: |
            **Fan speed** for medium cooling/heating conditions.

            â€¢ **Balanced airflow** for moderate temperature adjustments
            â€¢ Good for maintaining temperatures within comfort zone
            â€¢ System auto-detects your AC's fan speed format

            **Used when:** Temperature is moderately outside target range.
          default: "Level 3"
          selector:
            select:
              options:
                - "Auto"
                - "auto"
                - "Quiet"
                - "Silence"
                - "Level 1"
                - "Level 2"
                - "Level 3"
                - "Level 4"
                - "Level 5"
                - "1"
                - "2"
                - "3"
                - "4"
                - "5"
                - "high"
                - "medium"
                - "low"
        
        fan_speed_eco:
          name: Eco Fan Speed
          description: |
            **Fan speed** for eco mode and comfort zone operation.

            â€¢ **Quiet, energy-efficient operation**
            â€¢ Used when temperature is within comfort zone
            â€¢ **Minimal noise** for continuous operation
            â€¢ System auto-detects your AC's fan speed format

            **Purpose:** Balances comfort with energy efficiency and noise levels.
          default: "Level 1"
          selector:
            select:
              options:
                - "Auto"
                - "auto"
                - "Quiet"
                - "Silence"
                - "Level 1"
                - "Level 2"
                - "Level 3"
                - "Level 4"
                - "Level 5"
                - "1"
                - "2"
                - "3"
                - "4"
                - "5"
                - "high"
                - "medium"
                - "low"
        
        swing_mode_active:
          name: Active Swing Mode
          description: |
            **Swing mode** when actively cooling/heating.

            â€¢ **both:** Full directional coverage (recommended)
            â€¢ **horizontal:** Left-right movement only
            â€¢ **vertical:** Up-down movement only
            â€¢ **off:** Fixed direction

            **Benefit:** Better air circulation helps achieve target temperatures faster.
          default: "both"
          selector:
            select:
              options:
                - "off"
                - "both"
                - "vertical"
                - "horizontal"

    # Power Efficiency Settings
    efficiency_settings:
      name: "Power Efficiency Settings"
      icon: mdi:leaf
      collapsed: true
      input:
        enable_eco_mode:
          name: Enable Eco Mode
          description: |
            **Triggered when temperature is in COMFORT ZONE** (21-23Â°C range):
            
            **Purpose:** Maintain temperature efficiently when already comfortable
            
            â€¢ **ON** = Eco mode (low power, maintains temp, uses ~150-250W)
            â€¢ **OFF** = Turn off completely (zero power, allows drift, saves more energy)
            
            **Different from Stability:** This responds to being in **comfort zone**, not temperature stability
            
            **Recommended:** Use Stability: OFF + Eco Mode: ON for maximum efficiency
          default: false
          selector:
            boolean:
        
        eco_mode_setpoint_offset:
          name: Eco Mode Setpoint Offset
          description: |
            **Degrees to adjust setpoint** in eco mode to reduce cycling.

            â€¢ **0Â°C:** Standard eco mode (maintains exact target)
            â€¢ **1Â°C:** Relaxed eco mode (recommended)
            â€¢ **2-3Â°C:** Very relaxed (maximum efficiency)

            **Rule:** Higher values reduce compressor cycling and save more energy.
          default: 1
          selector:
            number:
              min: 0
              max: 3
              step: 0.5
              unit_of_measurement: "Â°C"
        
        min_runtime_minutes:
          name: Minimum Runtime
          description: |
            **Minimum minutes** A/C must run before allowing mode change.

            â€¢ **Prevents rapid on/off cycling** (protects compressor)
            â€¢ **5-10 minutes:** Aggressive efficiency
            â€¢ **15-20 minutes:** Balanced approach (recommended)
            â€¢ **25-30 minutes:** Conservative, equipment protection

            **Benefit:** Extends compressor lifespan and improves efficiency.
          default: 15
          selector:
            number:
              min: 5
              max: 30
              unit_of_measurement: minutes
        
        min_off_time_minutes:
          name: Minimum Off Time
          description: |
            **Minimum minutes** A/C must be off before restarting.

            â€¢ **Allows compressor pressure** to equalize
            â€¢ **3-5 minutes:** Minimum for compressor safety
            â€¢ **10 minutes:** Recommended balance
            â€¢ **15 minutes:** Conservative protection

            **Note:** Modern AC units (2015+) often have built-in 3-5 minute delay timers.
            If your AC has hardware protection, you can disable enforcement below
            or reduce this to 3 minutes.

            **Critical** for compressor longevity and energy efficiency.
          default: 10
          selector:
            number:
              min: 3
              max: 15
              unit_of_measurement: minutes

        enforce_off_time_protection:
          name: Enforce Off-Time Protection
          description: |
            **Enable off-time protection** when restarting AC from OFF state.

            â€¢ **ON (Recommended):** Enforces `min_off_time_minutes` delay before restart
            â€¢ **OFF:** Allows immediate restart (use if AC has built-in protection)

            **When to disable:**
            - Modern AC with built-in 3-5 minute delay timer
            - Testing/debugging automation behavior
            - Rapid response scenarios (at your own risk)

            **When to keep enabled:**
            - Older AC units without built-in protection
            - Extending compressor lifespan
            - Conservative safety approach
          default: true
          selector:
            boolean:

        enable_gradual_adjustment:
          name: Enable Gradual Temperature Adjustment
          description: |
            **Gradually adjust temperature** instead of immediate changes.

            â€¢ **Smoother operation** with less temperature overshoot
            â€¢ **More comfortable** temperature transitions
            â€¢ **Better energy efficiency** through controlled adjustment
            â€¢ Reduces wear on AC equipment

            **Recommendation:** For most users for optimal comfort and efficiency.
          default: true
          selector:
            boolean:
        
        extreme_temp_override:
          name: Extreme Temperature Override
          description: |
            **Temperature thresholds** that override Manual mode for safety.

            **Emergency override:** Above high or below low will activate climate even in Manual mode.
          default: true
          selector:
            boolean:
        
        extreme_high_temp:
          name: Extreme High Temperature
          description: |
            **Safety threshold** - activate cooling even in Manual mode.

            â€¢ **Emergency override** for extremely hot conditions
            â€¢ **Protects health** and equipment from overheating
            â€¢ Only activates when indoor temperature exceeds threshold
            â€¢ **Returns to Manual mode** once temperature normalizes

            **Recommendation:** Set based on your comfort limits and local climate conditions.
          default: 30
          selector:
            number:
              min: 28
              max: 35
              step: 0.5
              unit_of_measurement: "Â°C"
        
        extreme_low_temp:
          name: Extreme Low Temperature
          description: |
            **Safety threshold** - activate heating even in Manual mode.

            â€¢ **Emergency override** for extremely cold conditions
            â€¢ **Prevents pipes freezing** and health risks
            â€¢ Only activates when indoor temperature falls below threshold
            â€¢ **Returns to Manual mode** once temperature normalizes

            **Recommendation:** Set based on your heating needs and local climate conditions.
          default: 15
          selector:
            number:
              min: 10
              max: 18
              step: 0.5
              unit_of_measurement: "Â°C"

    # Advanced Settings
    advanced_settings:
      name: "Advanced Settings"
      icon: mdi:cog
      collapsed: true
      input:
        enable_dynamic_adaptation:
          name: Enable Dynamic Adaptation
          description: |
            **Automatically escalate/de-escalate** cooling/heating power based on effectiveness.

            **How it works:**

            â€¢ **Monitors temperature progress** toward target
            â€¢ **Increases power** when progress stalls
            â€¢ **Reduces power** when target is approaching
            â€¢ **Learns** your AC's effectiveness over time

            **Requirement:** Helper entities for temperature tracking and analysis.
          default: true
          selector:
            boolean:
        
        effectiveness_check_minutes:
          name: Effectiveness Check Interval
          description: |
            **Minutes to wait** before checking if current mode is working.

            â€¢ **1-3 minutes:** Very aggressive adaptation (gaming rooms, high heat load)
            â€¢ **5-10 minutes:** Responsive adaptation
            â€¢ **15 minutes:** Balanced approach (recommended)
            â€¢ **20-30 minutes:** Conservative, gives more time for AC to work

            **Trade-off:** Too short may cause excessive mode switching; too long delays optimization.
          default: 10
          selector:
            number:
              min: 1
              max: 30
              unit_of_measurement: minutes

        stall_escalation_time:
          name: Stall Escalation Time
          description: |
            **Minutes of poor progress** before forcing escalation regardless of distance from target.

            **How it works:**
            â€¢ Monitors temperature change rate (Â°C/min)
            â€¢ If progress is too slow for this duration â†’ escalates immediately
            â€¢ Prevents AC getting stuck with minimal progress for hours

            **Time settings:**
            â€¢ **5-10 minutes:** Quick response to stalled progress
            â€¢ **15 minutes:** Balanced approach (recommended)
            â€¢ **30-60 minutes:** Patient, allows AC more time to work

            **Note:** Works with "Minimum Progress Rate" setting below.
          default: 15
          selector:
            number:
              min: 1
              max: 60
              step: 1
              unit_of_measurement: minutes

        minimum_progress_rate:
          name: Minimum Progress Rate
          description: |
            **Minimum acceptable temperature change rate** (Â°C per minute) before triggering escalation.

            **How it works:**
            â€¢ System calculates: (current_temp - previous_temp) / time_elapsed
            â€¢ If rate is below this threshold for the "Stall Escalation Time" â†’ escalates power
            â€¢ Customizable for your AC's capabilities and room characteristics

            **Rate examples:**
            â€¢ **0.10-0.20Â°C/min:** Very aggressive (gaming rooms, high-power ACs)
            â€¢ **0.05-0.10Â°C/min:** Aggressive (fast AC, small room, tight control)
            â€¢ **0.02-0.05Â°C/min:** Responsive (fast AC, good insulation)
            â€¢ **0.01-0.02Â°C/min:** Average AC, medium room (recommended)
            â€¢ **0.005-0.01Â°C/min:** Slow AC, large room, patient control
            â€¢ **0.001-0.005Â°C/min:** Very slow AC or poorly insulated room

            **Example scenarios:**
            â€¢ **Very Aggressive:** 0.15Â°C/min = expects 9Â°C drop per hour (gaming rooms)
            â€¢ **Aggressive:** 0.08Â°C/min = expects 4.8Â°C drop per hour
            â€¢ **Balanced:** 0.01Â°C/min = expects 0.6Â°C drop per hour (recommended)
            â€¢ **Patient:** 0.005Â°C/min = expects 0.3Â°C drop per hour

            **Tip:** Monitor your logs to see typical cooling/heating rates, then set threshold slightly below that.
          default: 0.01
          selector:
            number:
              min: 0.001
              max: 0.5
              step: 0.001
              unit_of_measurement: "Â°C/min"

        escalation_temp_tolerance:
          name: Temperature Stall Tolerance
          description: |
            **Maximum distance from target** before triggering stall escalation.

            **How it works:**
            â€¢ **Near-Target Stall:** Escalates if distance â‰¤ this value AND stalled for 15+ min
            â€¢ **Time-Based Stall:** Escalates if distance > half this value AND poor progress for configured time

            **Tolerance levels:**
            â€¢ **0.5-1.0Â°C:** Aggressive response (tight control, escalates early)
            â€¢ **1.0-2.0Â°C:** Balanced approach (recommended - default 1.0Â°C)
            â€¢ **2.0-3.0Â°C:** Patient response (allows more drift before escalating)

            **Example (1.0Â°C setting):**
            â€¢ If 0.9Â°C from target and stalled â†’ Gentle escalation (Level 1)
            â€¢ If 0.6Â°C from target and poor progress â†’ Strong escalation (Level 3)

            **Trade-off:** Lower values provide tighter control but may increase power cycling.
          default: 1.0
          selector:
            number:
              min: 0.1
              max: 3.0
              step: 0.1
              unit_of_measurement: "Â°C"

        extended_stall_multiplier:
          name: Extended Stall Multiplier
          description: |
            **How many times the stall time** before triggering maximum escalation (Level 4/Fan 5).

            **How it works:**
            When AC has been running with poor progress for `stall_escalation_time Ã— multiplier`,
            escalation jumps to Level 4 (emergency/maximum power).

            **Examples with stall_escalation_time = 2 minutes:**
            â€¢ **10x:** Emergency after 20 minutes stuck â†’ Very aggressive
            â€¢ **20x:** Emergency after 40 minutes stuck â†’ Aggressive (recommended)
            â€¢ **30x:** Emergency after 60 minutes stuck â†’ Balanced
            â€¢ **50x:** Emergency after 100 minutes stuck â†’ Patient
            â€¢ **100x:** Emergency after 200 minutes stuck â†’ Very patient

            **User scenario (20x multiplier, 2min stall time):**
            ```
            Time 0: AC starts cooling, 25Â°C â†’ 22Â°C target
            Time 2: Still 25Â°C, slow progress â†’ Level 3 (time-based stall)
            Time 10: Still 24.8Â°C, poor progress â†’ Level 3 (waiting)
            Time 40: Still 24.5Â°C after 40 min â†’ Level 4! (emergency)
            Result: Maximum fan power after extended stalling
            ```

            **When to use lower values (aggressive):**
            â€¢ Gaming rooms with high, variable heat loads
            â€¢ Rooms that need fast temperature correction
            â€¢ Poor insulation or external heat sources
            â€¢ Testing/debugging escalation behavior

            **When to use higher values (patient):**
            â€¢ Bedrooms (avoid sudden fan noise increases)
            â€¢ Well-insulated rooms with stable temps
            â€¢ Efficient AC units that eventually catch up
            â€¢ Rooms where you rarely need maximum power

            **Recommendation:** Start with 20x-30x, adjust based on how long your AC typically takes to reach target.
          default: 30
          selector:
            number:
              min: 5
              max: 100
              step: 5
              mode: slider

        enable_dynamic_target_adjustment:
          name: Enable Dynamic Target Adjustment
          description: |
            **SMART ESCALATION BOOST:** Automatically adjust AC target temperature when escalation is active to help struggling AC reach your desired temperature faster.

            **How it works:**
            - **Cooling mode:** Lowers AC target below your desired temp (e.g., 24Â°C â†’ 21Â°C at Level 3)
            - **Heating mode:** Raises AC target above your desired temp (e.g., 22Â°C â†’ 25Â°C at Level 3)
            - **Creates buffer zone:** Prevents temp from immediately drifting back
            - **Auto-reverts:** Returns to normal target once temperature stable

            **Why this helps:**
            - AC compressor works harder with more aggressive target
            - Combined with higher fan speed = maximum effectiveness
            - Faster cooling/heating when system detects struggle
            - Prevents getting stuck near target without reaching it

            **Example (cooling with 1.0Â°C offset):**
            - Level 0: Target 24Â°C (normal)
            - Level 1: Target 23Â°C (slightly lower)
            - Level 2: Target 22Â°C (more aggressive)
            - Level 3: Target 21Â°C (very aggressive)
            - Level 4: Target 20Â°C (maximum)

            **Recommended:** Enable for rooms where AC struggles to reach target. Disable for oversized AC units or if you want precise temperature control only.
          default: false
          selector:
            boolean:

        escalation_target_offset:
          name: Escalation Target Offset (per level)
          description: |
            **How much to adjust target temperature PER escalation level** when dynamic target adjustment is enabled.

            **The offset multiplies by escalation level:**
            - **0.5Â°C/level:** Gentle adjustment (Level 4 = Â±2Â°C from desired)
            - **1.0Â°C/level:** Balanced (Level 4 = Â±4Â°C from desired) â† **Recommended**
            - **1.5Â°C/level:** Aggressive (Level 4 = Â±6Â°C from desired)
            - **2.0Â°C/level:** Very aggressive (Level 4 = Â±8Â°C from desired)

            **Examples with 1.0Â°C offset:**

            **Cooling (desired: 24Â°C):**
            - Level 1: 24Â°C - 1Â°C = 23Â°C
            - Level 2: 24Â°C - 2Â°C = 22Â°C
            - Level 3: 24Â°C - 3Â°C = 21Â°C
            - Level 4: 24Â°C - 4Â°C = 20Â°C

            **Heating (desired: 22Â°C):**
            - Level 1: 22Â°C + 1Â°C = 23Â°C
            - Level 2: 22Â°C + 2Â°C = 24Â°C
            - Level 3: 22Â°C + 3Â°C = 25Â°C
            - Level 4: 22Â°C + 4Â°C = 26Â°C

            **Safety limits:** System will never adjust beyond 10Â°C (cooling) or 35Â°C (heating) regardless of offset.

            **Tuning guide:**
            - **Bedroom/quiet rooms:** 0.5Â°C (gentle, minimal overshoot)
            - **Office/living room:** 1.0Â°C (balanced)
            - **Gaming room/high heat loads:** 1.5-2.0Â°C (aggressive, fast recovery)
          default: 1.0
          selector:
            number:
              min: 0.0
              max: 3.0
              step: 0.1
              unit_of_measurement: "Â°C"

        deescalation_approach_threshold:
          name: De-escalation Approach Threshold
          description: |
            **Degrees from target** when system can de-escalate power.

            â€¢ **Prevents overshooting** target temperature
            â€¢ **1.0-2.0Â°C:** Aggressive de-escalation
            â€¢ **2.0-3.0Â°C:** Balanced approach (recommended)
            â€¢ **3.0-4.0Â°C:** Conservative, maintains power longer

            **Note:** Works when temperature is trending correctly toward target.
          default: 2.0
          selector:
            number:
              min: 0.1
              max: 4.0
              step: 0.1
              unit_of_measurement: "Â°C"
        
        helper_temp_history:
          name: Temperature History Helper (Optional)
          description: |
            **Input Number helper** to store previous temperature reading.

            â€¢ **Tracks temperature changes** over time
            â€¢ **Required** for dynamic adaptation features
            â€¢ **Automatically updated** by the system
            â€¢ **Range:** 0-50Â°C with 0.1Â°C steps

            **Example:** `input_number.climate_temp_history_living_room`
          default: []
          selector:
            entity:
              domain: input_number
        
        helper_trend_direction:
          name: Trend Direction Helper (Optional)
          description: |
            **Input Text helper** to track temperature trend direction.

            â€¢ **Stores:** rising, falling, or stable
            â€¢ **Required** for dynamic adaptation logic
            â€¢ **Automatically updated** by the system
            â€¢ **Used to determine** when to escalate/de-escalate

            **Example:** `input_text.climate_trend_direction_living_room`
          default: []
          selector:
            entity:
              domain: input_text
        
        helper_mode_start_time:
          name: Mode Start Time Helper (Optional)
          description: |
            **Input DateTime helper** to track when current mode started.

            â€¢ **Timestamp** when current AC mode began
            â€¢ **Required** for effectiveness calculations
            â€¢ **Used to determine** how long to wait before changes
            â€¢ **Automatically updated** by the system

            **Example:** `input_datetime.climate_mode_start_time_living_room`
          default: []
          selector:
            entity:
              domain: input_datetime
        
        helper_effectiveness_score:
          name: Effectiveness Score Helper (Optional)
          description: |
            **Input Number helper** to track how well current mode is working (0-100%).

            â€¢ **0%:** Mode not working (temperature getting worse)
            â€¢ **50%:** Mode working slowly
            â€¢ **100%:** Mode working effectively
            â€¢ **Used to decide** escalation/de-escalation

            **Example:** `input_number.climate_effectiveness_score_living_room`
          default: []
          selector:
            entity:
              domain: input_number
        
        helper_temp_stable_since:
          name: Temperature Stable Since Helper (Optional)
          description: |
            **Input DateTime helper** to track when temperature became stable.

            â€¢ **Timestamp** when temperature entered stable range
            â€¢ **Required** for stability auto-off feature
            â€¢ **Used to calculate** how long temperature has been stable
            â€¢ **Automatically updated** by the system

            **Example:** `input_datetime.temp_stable_since_living_room`
          default: []
          selector:
            entity:
              domain: input_datetime
        
        helper_last_transition:
          name: Last Transition Helper (Optional)
          description: |
            **Input Text helper** to track last temperature zone transition.

            â€¢ **Stores:** to_cooling, to_heating, to_comfort, etc.
            â€¢ **Used for hysteresis** to prevent rapid switching
            â€¢ **Prevents oscillation** at temperature boundaries
            â€¢ **Automatically updated** by the system

            **Example:** `input_text.climate_last_transition_living_room`
          default: []
          selector:
            entity:
              domain: input_text
        
        hysteresis_tolerance:
          name: Hysteresis Tolerance
          description: |
            **Temperature tolerance** for preventing rapid switching (Â±Â°C).

            â€¢ **Prevents oscillation** at temperature boundaries
            â€¢ **0.05-0.15Â°C:** Very tight control (gaming rooms, precise control)
            â€¢ **0.15-0.30Â°C:** Sensitive (may cause more switching)
            â€¢ **0.30-0.50Â°C:** Balanced approach (recommended)
            â€¢ **0.50-1.00Â°C:** Conservative (less switching)

            **Rule:** System won't change modes unless temperature exceeds threshold by this amount.
          default: 0.3
          selector:
            number:
              min: 0.05
              max: 1.0
              step: 0.01
              unit_of_measurement: "Â°C"

        ac_minimum_temp:
          name: AC Minimum Temperature Override
          description: |
            **Your AC's actual minimum temperature** (leave at 0 to use AC's reported minimum).

            â€¢ **Use this if your AC integration reports incorrect limits**
            â€¢ **Example:** AC reports 7Â°C minimum but physically can't go below 18Â°C
            â€¢ **Leave at 0:** Use the temperature reported by your AC integration (default)
            â€¢ **Set to actual:** Prevent automation from setting impossible temperatures

            **Why needed:** Some AC integrations report incorrect min/max values. This ensures dynamic targeting respects your AC's physical limits.
          default: 0
          selector:
            number:
              min: 0
              max: 25
              step: 1
              unit_of_measurement: "Â°C"
              mode: box

        ac_maximum_temp:
          name: AC Maximum Temperature Override
          description: |
            **Your AC's actual maximum temperature** (leave at 0 to use AC's reported maximum).

            â€¢ **Use this if your AC integration reports incorrect limits**
            â€¢ **Example:** AC reports 35Â°C maximum but physically can't go above 30Â°C
            â€¢ **Leave at 0:** Use the temperature reported by your AC integration (default)
            â€¢ **Set to actual:** Prevent automation from setting impossible temperatures

            **Why needed:** Some AC integrations report incorrect min/max values. This ensures dynamic targeting respects your AC's physical limits.
          default: 0
          selector:
            number:
              min: 0
              max: 40
              step: 1
              unit_of_measurement: "Â°C"
              mode: box
        
        enable_debug_logging:
          name: Enable Debug Logging
          description: |
            **Enable detailed warning-level logs** for troubleshooting.

            â€¢ **Shows decision-making process** and sensor states
            â€¢ **Helps diagnose** automation issues
            â€¢ **View logs** in Settings â†’ System â†’ Logs
            â€¢ **WARNING:** Creates many log entries!

            **Recommendation:** Enable only when troubleshooting - disable for normal operation.
          default: false
          selector:
            boolean:
        
        check_interval_minutes:
          name: Check Interval
          description: |
            **How often to check conditions** and evaluate temperature (in minutes).

            â€¢ **1-3 minutes:** Very responsive (more CPU usage)
            â€¢ **5 minutes:** Balanced approach (recommended)
            â€¢ **10+ minutes:** Conservative (less responsive)

            **Trade-off:** Lower intervals provide tighter control but increase system load.
          default: 5
          selector:
            number:
              min: 1
              max: 30
              step: 1
              unit_of_measurement: minutes
              mode: slider

        enable_wrong_direction_escalation:
          name: Enable Stall & Wrong Direction Escalation
          description: |
            **Incrementally escalate power when temperature stalls or moves the wrong way.**

            **How it works:**
            â€¢ Checks temperature trend at every effectiveness check (e.g., every 2 minutes)
            â€¢ **Cooling mode:** If temperature RISING (wrong direction) OR cooling TOO SLOWLY (stalling) â†’ add escalation levels
            â€¢ **Heating mode:** If temperature FALLING (wrong direction) OR heating TOO SLOWLY (stalling) â†’ add escalation levels
            â€¢ Adds levels incrementally until temperature stabilizes or reaches maximum

            **Example (with +1 per check, checking every 2 minutes):**
            ```
            Wrong Direction (temp rising during cooling):
            Time 0: 25.6Â°C â†’ Fan 1 (Base Level 0)
            Time 2: 25.7Â°C rising â†’ Fan 2 (Level 0+1)
            Time 4: 25.8Â°C rising â†’ Fan 3 (Level 0+2)
            Time 6: 25.9Â°C rising â†’ Fan 4 (Level 0+3)

            Stalling (temp falling but TOO slowly):
            Time 0: 23.6Â°C â†’ Fan 2 (cooling at -0.02Â°C/min - too slow!)
            Time 2: 23.5Â°C â†’ Fan 3 (still -0.02Â°C/min - add +1 level)
            Time 4: 23.3Â°C â†’ Fan 4 (now -0.1Â°C/min - fast enough, stops escalating)
            ```

            **When useful:**
            â€¢ Gaming rooms with variable heat load (PCs, consoles)
            â€¢ Rooms with external heat sources (sun, appliances, cooking)
            â€¢ Rooms that stall near target temperature (cooling too slowly)
            â€¢ Fast response to unexpected temperature changes
            â€¢ High-occupancy rooms with variable people count

            **Safe to disable if:**
            â€¢ Your room has stable temperature patterns
            â€¢ You prefer slower, more conservative escalation
            â€¢ Testing/debugging automation behavior

            **Advantages over time-based boost:**
            â€¢ Responds immediately at first effectiveness check
            â€¢ Smooth, gradual escalation instead of sudden jumps
            â€¢ Self-correcting (stops when temp stabilizes)
            â€¢ Simpler to configure and understand

            **Safety:** Disabled by default. Won't affect existing automations.
          default: false
          selector:
            boolean:

        wrong_direction_escalation_per_check:
          name: Stall & Wrong Direction Escalation Per Check
          description: |
            **How many escalation levels to add per effectiveness check when temperature stalls or moves wrong direction.**

            â€¢ **0:** Disabled (ignore stall/wrong direction, even if feature enabled)
            â€¢ **+1:** Gentle incremental response (â­ recommended for most rooms)
            â€¢ **+2:** Aggressive incremental response (for extreme heat loads or persistent stalling)

            **How it works:**
            At each effectiveness check (e.g., every 2 minutes), if temperature is stalling (moving too slowly)
            or moving the wrong direction, this many levels are added to escalation.

            **Example with +1 per check:**
            ```
            Check 1: Base L0, rising â†’ L0+1 = Fan 2
            Check 2: Base L0, rising â†’ L0+2 = Fan 3
            Check 3: Base L0, rising â†’ L0+3 = Fan 4
            Check 4: Base L0, rising â†’ L0+4 = Fan 5 (maximum)
            Result: Smooth escalation over 6-8 minutes
            ```

            **Example with +2 per check (aggressive):**
            ```
            Check 1: Base L0, rising â†’ L0+2 = Fan 3
            Check 2: Base L0, rising â†’ L0+4 = Fan 5 (maximum)
            Result: Reaches maximum in 4 minutes
            ```

            **Recommendation:**
            â€¢ **Gaming rooms:** +1 (balanced, reaches max in 8 min)
            â€¢ **Extreme heat loads:** +2 (aggressive, reaches max in 4 min)
            â€¢ **Stable rooms:** 0 or disable feature entirely
          default: 1
          selector:
            number:
              min: 0
              max: 2
              step: 1

        wrong_direction_min_rate:
          name: Wrong Direction Minimum Rate
          description: |
            Minimum temperature change rate to trigger WRONG DIRECTION escalation (Â°C/min).

            This detects when temperature moves the OPPOSITE direction (rising during cooling, falling during heating).
            Filters out sensor noise, only triggering when temperature is meaningfully moving the wrong way.

            **Note:** Slow progress (stalling) is detected separately using your "Minimum Progress Rate" setting.

            **Examples:**
            â€¢ **0.02Â°C/min:** Very sensitive (1.2Â°C/hour) - catches slight wrong direction trends
            â€¢ **0.03Â°C/min:** Balanced (1.8Â°C/hour) - filters noise, catches real wrong direction issues
            â€¢ **0.05Â°C/min:** Conservative (3Â°C/hour) - only triggers on clear wrong direction

            **Recommendation:**
            â€¢ **Most rooms:** 0.02Â°C/min (detect wrong direction early)
            â€¢ **Noisy sensors:** 0.03-0.05Â°C/min (reduce false triggers)
            â€¢ **Very stable sensors:** 0.01Â°C/min (maximum sensitivity)
          default: 0.05
          selector:
            number:
              min: 0.01
              max: 0.20
              step: 0.01
              unit_of_measurement: "Â°C/min"
              mode: slider

    # Notification Settings
    notifications:
      name: "Notification Settings"
      icon: mdi:bell
      collapsed: true
      input:
        enable_notifications:
          name: Enable Notifications
          description: |
            **Enable push notifications** when the climate control system makes changes.

            **Notifications include:** Mode switches, temperature adjustments, and system status updates.
          default: true
          selector:
            boolean:
        
        notification_service:
          name: Notification Service
          description: |
            **Primary notification service** to send alerts to.

            **Common options:** `notify.notify`, `notify.mobile_app_yourphone`, `notify.pushbullet`
          default: notify.notify
          selector:
            text:
        
        additional_notify_services:
          name: Additional Notification Services
          description: |
            Additional services to notify beyond the primary service.

            â€¢ One service per line
            â€¢ Useful for multiple people or notification methods
            â€¢ Examples: notify.mobile_app_phone2, notify.telegram

            Leave empty if only one notification service is needed.
          default: []
          selector:
            text:
              multiple: true

    # Adaptive Control Mode Settings
    adaptive_control:
      name: "Adaptive Control Mode Settings"
      icon: mdi:auto-mode
      collapsed: true
      input:
        enable_adaptive_control:
          name: Enable Adaptive Control Mode
          description: |
            **Automatically switches control modes** based on room occupancy patterns.

            **How it works:**

            â€¢ **Room becomes occupied** â†’ Switch to Auto/Smart mode after configurable delay
            â€¢ **Room becomes vacant** â†’ Turn AC off after delay (stays in current mode)

            **REQUIREMENTS:**

            â€¢ **Room presence sensors** configured in Smart Mode Settings
            â€¢ PIR/motion sensors, BLE tracking devices, or occupancy sensors
            â€¢ **Last Presence Helper Entity** (input_datetime) to track timing
            â€¢ **Smart Mode** must be properly configured

            **Use cases:** Automatic comfort when you enter, energy savings when you leave.
          default: false
          selector:
            boolean:
        
        adaptive_occupied_delay:
          name: Occupied Delay (minutes)
          description: |
            **ADAPTIVE CONTROL MODE SWITCHING ONLY:** How long to wait after detecting room presence before switching FROM Manual mode TO Auto/Smart mode.

            **This setting does NOT affect Smart mode turn-on protection** - use "Presence Confirmation Delay" for that instead.

            â€¢ **Shorter delays (1-3 min):** Quickly switch from Manual to Auto/Smart when you enter
            â€¢ **Longer delays (5-10 min):** Avoid switching too soon if you manually changed the mode
            â€¢ **Very long (15-60 min):** Stay in Manual mode longer after you manually set it

            **Recommended:** 5 minutes for balanced behavior.

            **Example:** You manually set AC to OFF, then enter the room. Adaptive control will wait 5 minutes of continuous presence before switching back to Auto/Smart mode and turning the AC on.
          default: 5
          selector:
            number:
              min: 1
              max: 60
              step: 1
              unit_of_measurement: minutes
              mode: slider
        
        adaptive_vacant_delay:
          name: Vacant Delay (minutes)
          description: |
            **How long to wait** after room becomes vacant before turning AC off.

            â€¢ **Shorter delays:** Better energy savings but may turn off too quickly
            â€¢ **Longer delays:** More comfort for brief departures but wastes energy

            **Recommended:** 15 minutes to handle brief absences without wasting energy.
          default: 15
          selector:
            number:
              min: 5
              max: 120
              step: 5
              unit_of_measurement: minutes
              mode: slider
        
        adaptive_target_mode:
          name: Target Mode When Occupied
          description: |
            **Which control mode** to activate when room occupancy is detected.

            â€¢ **Auto Mode:** Standard automatic temperature control
            â€¢ **Smart Mode:** Advanced occupancy-based control with presence timeout

            **Recommendation:** Choose Smart Mode if you want the most intelligent behavior.
          default: "smart"
          selector:
            select:
              options:
                - label: "Auto Mode"
                  value: "auto"
                - label: "Smart Mode"
                  value: "smart"
        
        adaptive_override_timeout:
          name: Manual Override Timeout (hours)
          description: |
            **How long to respect small adjustments** you make while automation is running.

            **WHAT THIS DOES:** When you tweak temperature/fan settings while in Auto/Smart mode,
            automation pauses its adjustments for this duration but **stays in the same mode**.

            **WHEN IT ACTIVATES:** Any manual adjustment while automation is active
            **WHAT CONTINUES:** Presence detection, mode switching, all other automation
            **WHAT PAUSES:** Temperature and fan speed adjustments only

            **Examples:**
            â€¢ You adjust 23Â°C â†’ 25Â°C for comfort â†’ System won't change it back for X hours
            â€¢ You turn off AC for pets â†’ System won't turn it back on for X hours
            â€¢ You change fan from Auto to Level 3 â†’ System respects your fan choice

            **This is NOT for remote pre-conditioning** - use Manual Mode for that.

            **Recommended:** 2 hours for most situations.
          default: 2
          selector:
            number:
              min: 0
              max: 24
              step: 0.5
              unit_of_measurement: hours
              mode: slider

        manual_mode_timeout:
          name: ğŸ® Manual Mode Timeout
          description: |
            **How long to completely bypass ALL automation** when you switch to Manual mode.

            **WHAT THIS DOES:** Manual mode = 100% user control with ZERO automation interference.
            Perfect for **remote pre-conditioning** before arriving home.

            **WHEN IT ACTIVATES:** Only when you switch the control mode to "Manual"
            **WHAT STOPS:** ALL automation - presence detection, temperature control, everything
            **WHAT YOU GET:** Complete control to set any temperature/fan remotely

            **Examples:**
            â€¢ Set AC to 18Â°C cold before coming home â†’ No presence sensors turn it off
            â€¢ Heat room to 26Â°C while away â†’ System won't adjust based on "empty room"
            â€¢ Set specific fan speed for noise â†’ Automation won't change it

            **After timeout:** Switches back to Smart mode (AC keeps running at your settings)
            **Then:** Normal automation resumes with presence detection

            **This IS for remote pre-conditioning** - different from Override above!
          default: "4_hours"
          selector:
            select:
              options:
                - label: "Never (Pure Manual - runs until manually changed)"
                  value: "never"
                - label: "1 Hour"
                  value: "1_hour"
                - label: "2 Hours"
                  value: "2_hours"
                - label: "4 Hours (Recommended)"
                  value: "4_hours"
                - label: "8 Hours"
                  value: "8_hours"
                - label: "12 Hours"
                  value: "12_hours"
                - label: "24 Hours"
                  value: "24_hours"

        
        adaptive_override_helper:
          name: Override Helper (Optional)
          description: |
            **Optional input_boolean helper** to manually disable adaptive control.

            When configured and set to **ON**, adaptive control will be **completely disabled** until turned OFF.

            **Example helper names:**

            â€¢ `input_boolean.climate_adaptive_override_office`

            â€¢ `input_boolean.ac_manual_override_bedroom`

            â€¢ `input_boolean.disable_adaptive_living_room`

            **Use this for:** Permanent manual control periods or when you want full override control via dashboard toggles.
          default: ""
          selector:
            entity:
              domain: input_boolean
              multiple: false

variables:
  climate_list: !input climate_entities
  persons: !input presence_persons
  devices: !input presence_devices
  eco_enabled: !input enable_eco_mode
  gradual_enabled: !input enable_gradual_adjustment
  enable_heating: !input enable_heating_mode
  enable_cooling: !input enable_cooling_mode
  away_action: !input away_mode_action
  temp_sensor: !input temperature_sensor
  use_avg: !input use_average_temperature
  helper_mode: !input helper_last_mode
  helper_change: !input helper_last_change
  helper_override_flag: !input helper_override_active
  helper_override_timestamp: !input helper_override_time
  helper_expected_temp: !input helper_expected_temp
  helper_expected_fan: !input helper_expected_fan
  helper_expected_swing: !input helper_expected_swing
  helper_expected_hvac: !input helper_expected_hvac
  proximity_sensor_input: !input proximity_sensor
  direction_sensor_input: !input direction_sensor
  
  # Simple temperature inputs
  target_temp: !input target_temperature
  comfort_width: !input comfort_zone_width
  aggressiveness: !input temperature_aggressiveness
  advanced_enabled: !input enable_advanced_temp
  
  # Store advanced inputs if enabled
  comfort_min_input: !input comfort_min_temp
  comfort_max_input: !input comfort_max_temp
  cooling_target_input: !input cooling_target_temp
  heating_target_input: !input heating_target_temp
  cooling_low_input: !input cooling_low_temp
  cooling_medium_input: !input cooling_medium_temp
  cooling_high_input: !input cooling_high_temp
  heating_low_input: !input heating_low_temp
  heating_medium_input: !input heating_medium_temp
  heating_high_input: !input heating_high_temp
  
  # Calculate comfort zones based on base target (before weather adjustment)
  base_comfort_min: "{{ comfort_min_input if advanced_enabled else (target_temp - comfort_width) | float }}"
  base_comfort_max: "{{ comfort_max_input if advanced_enabled else (target_temp + comfort_width) | float }}"
  base_cooling_target: "{{ cooling_target_input if advanced_enabled else target_temp | float }}"
  base_heating_target: "{{ heating_target_input if advanced_enabled else target_temp | float }}"
  
  # Auto-calculate base thresholds based on aggressiveness (smooth graduated response)
  # Cooling thresholds (escalate as temperature rises)
  base_cooling_low: "{{ cooling_low_input if advanced_enabled else (base_comfort_max + 0.1) | round(1) }}"
  base_cooling_medium: "{{ cooling_medium_input if advanced_enabled else (base_comfort_max + 1.0) | round(1) }}"
  base_cooling_high: "{{ cooling_high_input if advanced_enabled else (base_comfort_max + 2.0) | round(1) }}"
  # Heating thresholds (escalate as temperature drops)
  base_heating_low: "{{ heating_low_input if advanced_enabled else (base_comfort_min - 0.1) | round(1) }}"
  base_heating_medium: "{{ heating_medium_input if advanced_enabled else (base_comfort_min - 1.0) | round(1) }}"
  base_heating_high: "{{ heating_high_input if advanced_enabled else (base_comfort_min - 2.0) | round(1) }}"
  
  # Hysteresis logic variables to prevent short cycling
  # Cooling: Turn on at threshold, but continue until target reached
  cooling_on_threshold: "{{ base_cooling_low }}"     # Turn ON when temp reaches this
  cooling_off_threshold: "{{ target_temp }}"         # Turn OFF when temp reaches target
  heating_on_threshold: "{{ base_heating_low }}"     # Turn ON when temp drops to this  
  heating_off_threshold: "{{ target_temp }}"         # Turn OFF when temp reaches target
  
  enable_pre_conditioning: !input enable_pre_conditioning
  enable_away_mode: !input enable_away_mode
  enable_notifications: !input enable_notifications
  eco_mode_setpoint_offset: !input eco_mode_setpoint_offset
  # Fan speed settings
  fan_speed_max: !input fan_speed_max
  fan_speed_medium: !input fan_speed_medium
  fan_speed_eco: !input fan_speed_eco
  # Dynamic adaptation settings
  dynamic_enabled: !input enable_dynamic_adaptation
  effectiveness_check_mins: !input effectiveness_check_minutes
  stall_time_threshold: !input stall_escalation_time
  extended_stall_multiplier: !input extended_stall_multiplier
  min_progress_rate: !input minimum_progress_rate
  temp_tolerance: !input escalation_temp_tolerance
  deescalation_threshold: !input deescalation_approach_threshold
  enable_dynamic_target: !input enable_dynamic_target_adjustment
  escalation_offset: !input escalation_target_offset
  helper_temp_history: !input helper_temp_history
  helper_trend: !input helper_trend_direction
  helper_mode_time: !input helper_mode_start_time
  helper_effectiveness: !input helper_effectiveness_score
  last_mode: "{{ states(helper_mode) | default('off') }}"
  # Check actual AC state using hvac_action (compressor activity), not just HVAC mode
  # CRITICAL: An AC in "cool" mode at 18Â°C target with 28Â°C current = IDLE (not running)
  # We need to check if compressor is actually running, not just if mode is set
  actual_ac_state: >
    {% set ac_states = namespace(any_running=false) %}
    {% for entity in climate_list %}
      {% set hvac_action = state_attr(entity, 'hvac_action') | default('off') %}
      {% if hvac_action in ['cooling', 'heating', 'drying', 'fan'] %}
        {% set ac_states.any_running = true %}
      {% endif %}
    {% endfor %}
    {{ 'on' if ac_states.any_running else 'off' }}
  last_change: "{{ states(helper_change) | default(now()) }}"
  runtime_min: !input min_runtime_minutes
  offtime_min: !input min_off_time_minutes
  enforce_offtime: !input enforce_off_time_protection
  # Smart mode settings
  control_mode_helper: !input helper_control_mode
  presence_detected_helper: !input helper_presence_detected
  proximity_override_helper: !input helper_proximity_override
  presence_timeout: !input presence_timeout_minutes
  presence_confirmation_delay: !input presence_confirmation_delay
  home_zone_distance: !input home_zone_distance
  room_sensors: !input room_presence_sensors
  room_name: !input room_name
  room_ble_name: !input room_name
  adjacent_rooms_input: !input adjacent_room_names
  # Parse adjacent room names into a list for BLE detection
  adjacent_room_list: >
    {% if adjacent_rooms_input and adjacent_rooms_input != '' %}
      {% set rooms = [] %}
      {% for room in adjacent_rooms_input.split(',') %}
        {% set rooms = rooms + [room.strip()] %}
      {% endfor %}
      {{ rooms }}
    {% else %}
      []
    {% endif %}
  smart_behavior: !input smart_mode_behavior
  presence_validation: !input presence_validation_mode
  temp_stability_enabled: !input temp_stability_enabled
  stability_tolerance: !input stability_tolerance
  stability_duration: !input stability_duration
  stability_behavior: !input stability_behavior
  extreme_override: !input extreme_temp_override
  extreme_high: !input extreme_high_temp
  extreme_low: !input extreme_low_temp
  # New v2.1+ features - Scheduling
  enable_scheduling: !input enable_scheduling
  morning_temp: !input morning_temp
  day_temp: !input day_temp
  evening_temp: !input evening_temp
  night_temp: !input night_temp
  enable_weekend_schedule: !input enable_weekend_schedule
  weekend_morning_temp: !input weekend_morning_temp
  weekend_day_temp: !input weekend_day_temp
  weekend_night_temp: !input weekend_night_temp
  # New v2.1+ features - Window Detection
  enable_window_detection: !input enable_window_detection
  window_sensors: !input window_sensors
  window_open_delay: !input window_open_delay
  window_close_delay: !input window_close_delay
  # New v3.2.0 features - Outside Temperature Compensation (replaces old weather compensation)
  enable_outside_temp_compensation: !input enable_outside_temp_compensation
  weather_entity: !input weather_entity
  outdoor_temp_sensor: !input outdoor_temp_sensor
  outside_compensation_factor: !input outside_compensation_factor
  max_outside_compensation: !input max_outside_compensation
  outside_compensation_base_temp: !input outside_compensation_base_temp
  # New v2.1+ helpers - Stability and Hysteresis
  helper_temp_stable_since: !input helper_temp_stable_since
  helper_last_transition: !input helper_last_transition
  hysteresis_tolerance: !input hysteresis_tolerance
  overshoot_strategy: !input target_overshoot_strategy

  # v3.9.22: Calculate target overshoot based on strategy
  # v3.9.29: Added 'none' option for 0Â°C overshoot
  target_overshoot: >
    {% set strategy = overshoot_strategy | default('moderate') %}
    {% set zone_width = comfort_width | float(1.5) %}

    {% if strategy == 'none' %}
      0.0
    {% elif strategy == 'minimal' %}
      0.5
    {% elif strategy == 'moderate' %}
      {{ (zone_width / 2) | round(2) }}
    {% elif strategy == 'maximum' %}
      {{ zone_width | round(2) }}
    {% else %}
      0.75
    {% endif %}

  ac_minimum_temp: !input ac_minimum_temp
  ac_maximum_temp: !input ac_maximum_temp
  # Adaptive Control Mode variables
  adaptive_enabled: !input enable_adaptive_control
  adaptive_occupied_delay: !input adaptive_occupied_delay
  adaptive_vacant_delay: !input adaptive_vacant_delay
  adaptive_target_mode: !input adaptive_target_mode
  adaptive_override_timeout: !input adaptive_override_timeout
  adaptive_override_helper: !input adaptive_override_helper
  manual_mode_timeout: !input manual_mode_timeout

  # Convert timeout selection to hours for calculations
  manual_timeout_hours: >
    {% set timeout = manual_mode_timeout %}
    {% if timeout == 'never' %}
      0
    {% elif timeout == '1_hour' %}
      1
    {% elif timeout == '2_hours' %}
      2
    {% elif timeout == '4_hours' %}
      4
    {% elif timeout == '8_hours' %}
      8
    {% elif timeout == '12_hours' %}
      12
    {% elif timeout == '24_hours' %}
      24
    {% else %}
      4
    {% endif %}

trigger:
  - platform: state
    entity_id: !input climate_entities
    attribute: current_temperature
    id: temp_change
  
  - platform: state
    entity_id: !input temperature_sensor
    id: external_temp_change
  
  # Single time pattern trigger based on selected interval
  - platform: time_pattern
    minutes: "/1"
    id: periodic_check
  
  - platform: state
    entity_id: !input direction_sensor
    to: "towards"
    id: heading_home
  
  - platform: state
    entity_id: !input direction_sensor
    to: "arrived"
    id: arrived
  
  - platform: state
    entity_id: !input presence_persons
    id: presence_change
  
  - platform: state
    entity_id: !input presence_devices
    id: device_change

  # Fire immediately when room presence sensors change (motion, BLE, etc.)
  - platform: state
    entity_id: !input room_presence_sensors
    id: room_presence_change

  # Fire immediately when control mode changes (Manual/Smart/Auto)
  - platform: state
    entity_id: !input helper_control_mode
    id: mode_change

  # Fire immediately when manual override is cleared
  - platform: state
    entity_id: !input helper_override_active
    to: "off"
    id: override_cleared

condition: []

action:
  # Mode change detected - immediately clear helper BEFORE variables are calculated
  - if:
      - condition: template
        value_template: "{{ trigger.id == 'mode_change' and helper_mode not in [none, '', 'unavailable', 'unknown'] }}"
    then:
      - service: input_text.set_value
        target:
          entity_id: "{{ helper_mode }}"
        data:
          value: "off"
        continue_on_error: true

      # Update mode start time for off-time protection tracking
      - service: input_datetime.set_datetime
        target:
          entity_id: !input helper_mode_start_time
        data:
          datetime: "{{ now() }}"
        continue_on_error: true

  # Override cleared - update expected helpers to match current AC state
  # This prevents immediate re-detection of the same "manual" settings
  - if:
      - condition: template
        value_template: "{{ trigger.id == 'override_cleared' }}"
    then:
      - variables:
          climate_entities_list: !input climate_entities
          first_climate: "{{ (climate_entities_list | list)[0] }}"

      # Capture current temperature setpoint
      - service: input_number.set_value
        target:
          entity_id: !input helper_expected_temp
        data:
          value: "{{ state_attr(first_climate, 'temperature') | float(22) }}"
        continue_on_error: true

      # Capture current fan mode
      - service: input_text.set_value
        target:
          entity_id: !input helper_expected_fan
        data:
          value: "{{ state_attr(first_climate, 'fan_mode') | default('auto') }}"
        continue_on_error: true

      # Capture current swing mode
      - service: input_text.set_value
        target:
          entity_id: !input helper_expected_swing
        data:
          value: "{{ state_attr(first_climate, 'swing_mode') | default('off') }}"
        continue_on_error: true

      # Capture current HVAC mode
      - service: input_text.set_value
        target:
          entity_id: !input helper_expected_hvac
        data:
          value: "{{ states(first_climate) | default('off') }}"
        continue_on_error: true

      # Update last_change timestamp to reset detection timer
      - service: input_datetime.set_datetime
        target:
          entity_id: !input helper_last_change
        data:
          datetime: "{{ now() }}"
        continue_on_error: true

  # Store inputs as variables first
  - variables:
      check_interval: !input check_interval_minutes
      debug_enabled: !input enable_debug_logging
      proximity_sensor: >
        {% if proximity_sensor_input and proximity_sensor_input not in [none, '', 'unavailable', 'unknown'] and proximity_sensor_input is string and proximity_sensor_input != '' %}
          {{ proximity_sensor_input }}
        {% else %}
          none
        {% endif %}
      direction_sensor: >
        {% if direction_sensor_input and direction_sensor_input not in [none, '', 'unavailable', 'unknown'] and direction_sensor_input is string and direction_sensor_input != '' %}
          {{ direction_sensor_input }}
        {% else %}
          none
        {% endif %}
      # Dynamic adaptation variables
      previous_temp: >
        {% if helper_temp_history %}
          {{ states(helper_temp_history) | float(0) }}
        {% else %}
          0
        {% endif %}
      current_trend: >
        {% if helper_trend %}
          {{ states(helper_trend) | default('stable') }}
        {% else %}
          stable
        {% endif %}
      mode_start_time: >
        {% if helper_mode_time %}
          {{ states(helper_mode_time) | default(now()) | as_datetime }}
        {% else %}
          {{ now() }}
        {% endif %}
      should_proceed: >
        {% if trigger.id == 'periodic_check' %}
          {% set mins = now().minute %}
          {% set interval = check_interval | int(1) %}
          {% if interval > 0 %}
            {{ (mins % interval) == 0 }}
          {% else %}
            true
          {% endif %}
        {% else %}
          true
        {% endif %}
  
  # Continue with automation if conditions are met
  - condition: template
    value_template: "{{ should_proceed }}"
  
  # Debug: Log automation trigger
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ  {{ room_name | upper }} CLIMATE CONTROL ACTIVATED
            {% if trigger.id == 'temp_change' %}ğŸ“Š Temperature changed{% elif trigger.id == 'presence_change' %}ğŸ‘¤ Someone arrived/left{% elif trigger.id == 'periodic_check' %}â° Routine check{% elif trigger.id == 'mode_change' %}ğŸ® MODE CHANGED: {{ trigger.from_state.state }} â†’ {{ trigger.to_state.state }}{% else %}ğŸ”„ {{ trigger.id }}{% endif %}

            ğŸ“‹ Technical: {{ trigger.platform }}/{{ trigger.entity_id | default('timer') }}/{{ check_interval }}min
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

  # Mode change detected - immediately update helper and CLEAR Manual Override
  - if:
      - condition: template
        value_template: "{{ trigger.id == 'mode_change' and helper_change not in [none, '', 'unavailable', 'unknown'] }}"
    then:
      # Smart timestamp handling for mode changes:
      # - TO Manual mode: Set to NOW (starts fresh manual mode timeout timer)
      # - FROM Manual mode: Set to PAST (clears override for future periodic checks)
      # - Between Smart/Auto: Set to PAST (clears any lingering override)
      - service: input_datetime.set_datetime
        target:
          entity_id: "{{ helper_change }}"
        data:
          datetime: >
            {% if trigger.to_state.state == 'Manual' %}
              {{ now() }}
            {% else %}
              {{ now() - timedelta(hours=adaptive_override_timeout + 1) }}
            {% endif %}
        continue_on_error: true

      # Clear manual override flag on mode changes (user switching modes = intentional control)
      - service: input_boolean.turn_off
        target:
          entity_id: "{{ helper_override_flag }}"
        continue_on_error: true

      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                ğŸ® {{ room_name | upper }} MODE CHANGE DETECTED: Cleared for immediate mode switch
                â€¢ Mode Changed: {{ trigger.from_state.state }} â†’ {{ trigger.to_state.state }}
                â€¢ Helper cleared to "off" - {{ trigger.to_state.state }} mode will activate immediately
                â€¢ Manual Override disabled for mode changes
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
  
  - variables:
      current_temp: >
        {% if temp_sensor %}
          {# v3.9.0: Multi-sensor support for rooms cooled/heated by one AC unit #}
          {% if temp_sensor is string %}
            {# Single sensor (backward compatibility) #}
            {{ states(temp_sensor) | float(25) }}
          {% else %}
            {# Multiple sensors - use min/max/avg strategy based on HVAC mode #}
            {% set temps = namespace(values=[]) %}
            {% for sensor in temp_sensor %}
              {% set temp_value = states(sensor) | float(0) %}
              {% if temp_value > 0 %}
                {% set temps.values = temps.values + [temp_value] %}
              {% endif %}
            {% endfor %}

            {% if temps.values | length > 0 %}
              {% if enable_cooling and not enable_heating %}
                {# Cooling: Use MAX temp (warmest room drives cooling) #}
                {{ temps.values | max | round(1) }}
              {% elif enable_heating and not enable_cooling %}
                {# Heating: Use MIN temp (coldest room drives heating) #}
                {{ temps.values | min | round(1) }}
              {% else %}
                {# Both or neither: Use AVERAGE #}
                {{ (temps.values | sum / temps.values | length) | round(1) }}
              {% endif %}
            {% else %}
              25
            {% endif %}
          {% endif %}
        {% elif use_avg %}
          {% set temps = namespace(values=[]) %}
          {% for entity in climate_list %}
            {% set temp_value = state_attr(entity, 'current_temperature') | float(0) %}
            {% if temp_value > 0 %}
              {% set temps.values = temps.values + [temp_value] %}
            {% endif %}
          {% endfor %}
          {% if temps.values | length > 0 %}
            {{ (temps.values | sum / temps.values | length) | round(1) }}
          {% else %}
            25
          {% endif %}
        {% else %}
          {{ state_attr(climate_list[0], 'current_temperature') | float(25) }}
        {% endif %}
      
      # Calculate base target temperature with scheduling
      scheduled_target_temp: >
        {% if enable_scheduling %}
          {% set hour = now().hour %}
          {% set is_weekend = now().weekday() >= 5 %}
          {% if is_weekend and enable_weekend_schedule %}
            {% if 6 <= hour < 10 %}
              {{ weekend_morning_temp }}
            {% elif 10 <= hour < 22 %}
              {{ weekend_day_temp }}
            {% else %}
              {{ weekend_night_temp }}
            {% endif %}
          {% else %}
            {% if 6 <= hour < 9 %}
              {{ morning_temp }}
            {% elif 9 <= hour < 18 %}
              {{ day_temp }}
            {% elif 18 <= hour < 22 %}
              {{ evening_temp }}
            {% else %}
              {{ night_temp }}
            {% endif %}
          {% endif %}
        {% else %}
          {{ target_temp }}
        {% endif %}
      
      # Get outdoor temperature for outside temperature compensation
      outdoor_temperature: >
        {% if enable_outside_temp_compensation %}
          {% if outdoor_temp_sensor %}
            {{ states(outdoor_temp_sensor) | float(25) }}
          {% else %}
            {{ state_attr(weather_entity, 'temperature') | float(25) }}
          {% endif %}
        {% else %}
          25
        {% endif %}

      # Calculate outside temperature compensation (undershoot for cooling, overshoot for heating)
      # This makes AC work HARDER on extreme days to ACHIEVE the target, not change it
      outside_temp_compensation_amount: >
        {% if enable_outside_temp_compensation %}
          {% set outdoor = outdoor_temperature | float(25) %}
          {% set temp_delta = outdoor - outside_compensation_base_temp %}
          {% set raw_compensation = (temp_delta * outside_compensation_factor) | abs %}
          {{ [[0, raw_compensation] | max, max_outside_compensation] | min | round(1) }}
        {% else %}
          0
        {% endif %}

      # Comfort zones and thresholds - NO LONGER ADJUSTED (they stay at user's target)
      comfort_min_temp: "{{ base_comfort_min | round(1) }}"
      comfort_max_temp: "{{ base_comfort_max | round(1) }}"
      cooling_target_temp: "{{ base_cooling_target | round(1) }}"
      heating_target_temp: "{{ base_heating_target | round(1) }}"
      cooling_low_temp: "{{ base_cooling_low | round(1) }}"
      cooling_medium_temp: "{{ base_cooling_medium | round(1) }}"
      cooling_high_temp: "{{ base_cooling_high | round(1) }}"
      heating_low_temp: "{{ base_heating_low | round(1) }}"
      heating_medium_temp: "{{ base_heating_medium | round(1) }}"
      heating_high_temp: "{{ base_heating_high | round(1) }}"
      
      # Check window sensors
      window_open: >
        {% if enable_window_detection %}
          {% set open = namespace(value=false) %}
          {% for sensor in window_sensors %}
            {% if is_state(sensor, 'on') %}
              {% set open.value = true %}
            {% endif %}
          {% endfor %}
          {{ open.value }}
        {% else %}
          false
        {% endif %}
      
      anyone_home: >
        {% set home = namespace(value=false) %}
        {% for person in persons %}
          {% if is_state(person, 'home') %}
            {% set home.value = true %}
          {% endif %}
        {% endfor %}
        {% if not home.value %}
          {% for device in devices %}
            {% if is_state(device, 'on') or is_state(device, 'PowerOn') %}
              {% set home.value = true %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {{ home.value }}
      
      approaching_home: >
        {% if direction_sensor and proximity_sensor %}
          {{ (is_state(direction_sensor, 'towards') or is_state(direction_sensor, 'arrived')) and
             states(proximity_sensor) | float(10000) < home_zone_distance }}
        {% else %}
          false
        {% endif %}
      
      time_since_change: >
        {% if helper_change and states(helper_change) not in ['unknown', 'unavailable', ''] %}
          {% set change_timestamp = as_timestamp(states(helper_change)) %}
          {% if change_timestamp %}
            {{ (as_timestamp(now()) - change_timestamp) / 60 }}
          {% else %}
            999
          {% endif %}
        {% else %}
          999
        {% endif %}
      
      # Dynamic adaptation calculations
      time_in_current_mode: >
        {% set mode_time_val = states(helper_mode_time) if helper_mode_time else 'unknown' %}
        {% if mode_time_val not in ['unknown', 'unavailable', '', None] %}
          {% set mode_timestamp = as_timestamp(mode_time_val) %}
          {% if mode_timestamp %}
            {{ ((as_timestamp(now()) - mode_timestamp) / 60) | round(1) | abs }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}


      # Calculate actual temperature stability time (when temp last changed significantly)
      temp_stability_time: >
        {% if helper_temp_history and helper_temp_stable_since %}
          {% set temp_diff = (current_temp - previous_temp) | abs %}
          {% if temp_diff <= stability_tolerance %}
            {% set stable_since = states(helper_temp_stable_since) %}
            {% if stable_since not in ['unknown', 'unavailable', '', None] %}
              {% set stable_timestamp = as_timestamp(stable_since) %}
              {% if stable_timestamp %}
                {{ ((as_timestamp(now()) - stable_timestamp) / 60) | round(1) }}
              {% else %}
                0
              {% endif %}
            {% else %}
              {# Stable since not set, assume just became stable #}
              0
            {% endif %}
          {% else %}
            {# Temperature changed significantly, stability time is 0 #}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      
      temp_change_rate: >
        {% if previous_temp > 0 and current_temp != previous_temp and time_in_current_mode > 0 %}
          {% set actual_elapsed_time = time_in_current_mode | float(1) %}
          {% if actual_elapsed_time > 0 %}
            {{ ((current_temp - previous_temp) / actual_elapsed_time) | round(3) }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      
      calculated_trend: >
        {% if temp_change_rate > 0.2 %}
          rising
        {% elif temp_change_rate < -0.2 %}
          falling  
        {% else %}
          stable
        {% endif %}
      
      temp_stability_detected: >
        {% if temp_stability_enabled and helper_temp_history %}
          {% set temp_diff = (current_temp - previous_temp) | abs %}
          {% set time_threshold = stability_duration | float %}
          {# CRITICAL: Only consider stable if temp is stable AND within comfort zone #}
          {% set in_comfort_zone = current_temp >= comfort_min_temp and current_temp <= comfort_max_temp %}
          {# REMOVED close_to_target hardcoded check - use user-configured stability_tolerance instead #}
          {# REMOVED not_in_continue_mode check - other conditions are sufficient to prevent premature shutoff #}
          {% if temp_diff <= stability_tolerance and calculated_trend == 'stable' and in_comfort_zone %}
            {% if temp_stability_time >= time_threshold %}
              {% if last_mode not in ['off', 'stability_off', 'stability_eco', 'unavailable', 'unknown', none] %}
                true
              {% else %}
                false
              {% endif %}
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}
        {% else %}
          false
        {% endif %}
      
      distance_from_target: >
        {# v3.9.25 FIX: Calculate distance from OVERSHOOT target, not user target #}
        {# De-escalation must allow AC to reach overshoot target (e.g., 21.8Â°C) not just user target (22.5Â°C) #}
        {% set effective_target = target_temp %}
        {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
          {% set effective_target = target_temp - target_overshoot %}
        {% elif last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
          {% set effective_target = target_temp + target_overshoot %}
        {% endif %}
        {{ (current_temp - effective_target) | abs }}

      # Calculate current effectiveness based on temperature progress
      current_effectiveness: >
        {# Always calculate effectiveness automatically #}
        {% if time_in_current_mode < 2 %}
          50
        {% elif last_mode in ['cooling', 'cooling_low', 'cooling_medium', 'cooling_high', 'heating', 'heating_low', 'heating_medium', 'heating_high'] %}
          {% set target = target_temp %}
          {% set initial_distance = (previous_temp - target) | abs if previous_temp and previous_temp > 0 else distance_from_target %}
          {% set current_distance = distance_from_target | float(0) %}

          {% if initial_distance == 0 or current_distance >= initial_distance %}
            40  {# Active pursuit baseline - making effort even if not improving yet #}
          {% else %}
            {% set progress = ((initial_distance - current_distance) / initial_distance) * 100 %}
            {% set effectiveness = ([progress + 40, 95] | min) | round(0) %}
            {{ effectiveness }}
          {% endif %}
        {% else %}
          50  {# Default effectiveness #}
        {% endif %}

      # Enhanced escalation logic with multiple triggers and graduated response
      escalation_level: >
        {% if not dynamic_enabled %}
          0
        {% else %}
          {% set min_check_time = 3 %}  {# Minimum 3 minutes before any escalation #}
          {% set emergency_threshold = 4.0 %}  {# Degrees from target for emergency escalation #}
          {% set stall_threshold = 2.0 %}  {# Degrees for considering progress stalled #}

          {# Level 0: No escalation needed - minimum checks only #}
          {% if last_mode in ['off', 'eco'] or time_in_current_mode < min_check_time %}
            0  {# Too early to evaluate #}

          {# Level 4: EMERGENCY - Immediate maximum power #}
          {% elif distance_from_target > emergency_threshold and time_in_current_mode >= min_check_time %}
            4  {# Far from target - emergency escalation #}
          {% elif current_effectiveness <= 10 and time_in_current_mode >= 5 %}
            4  {# Completely ineffective after 5 minutes #}
          {% elif last_mode == 'cooling' and calculated_trend == 'rising' and current_temp > (comfort_max_temp + 1.0) %}
            4  {# Cooling but temperature rising above comfort zone #}
          {% elif last_mode == 'heating' and calculated_trend == 'falling' and current_temp < (comfort_min_temp - 1.0) %}
            4  {# Heating but temperature falling below comfort zone #}
          {% elif time_in_current_mode >= (stall_time_threshold * extended_stall_multiplier) and temp_change_rate | abs < min_progress_rate and distance_from_target > 1.5 %}
            4  {# EXTENDED STALL: Stuck for extended period with no progress AND far from target - emergency escalation (user-configurable) #}

          {# Level 0: VERY CLOSE TO TARGET - Don't escalate, maintain only #}
          {% elif distance_from_target <= 0.5 and current_effectiveness >= 85 %}
            0  {# Too close for escalation - high effectiveness means we're doing great #}

          {# Level 1: NEAR-TARGET STALL - Gentle push when close but stalling #}
          {% elif distance_from_target > 0.5 and distance_from_target <= 1.0 and time_in_current_mode >= 15 and (calculated_trend == 'stable' or temp_change_rate | abs < 0.05) %}
            1  {# NEAR-TARGET STALL: Close but stuck for extended time - gentle push needed #}

          {# Level 3: HIGH - Strong escalation needed #}
          {% elif distance_from_target > 3.0 and time_in_current_mode >= 5 %}
            3  {# Still far from target after 5 minutes #}
          {% elif current_effectiveness <= 25 and time_in_current_mode >= 7 %}
            3  {# Poor effectiveness after reasonable time #}
          {% elif distance_from_target > stall_threshold and calculated_trend == 'stable' and time_in_current_mode >= 8 %}
            3  {# Progress has stalled #}
          {% elif time_in_current_mode >= stall_time_threshold and temp_change_rate | abs < min_progress_rate and distance_from_target > (temp_tolerance / 2) %}
            3  {# TIME-BASED STALL: Running too long with terrible progress (user-configurable) #}

          {# Level 2: MEDIUM - Moderate escalation #}
          {% elif distance_from_target > 2.0 and time_in_current_mode >= 8 %}
            2  {# Moderate distance after longer time #}
          {% elif current_effectiveness <= 40 and time_in_current_mode >= 10 %}
            2  {# Below average effectiveness #}
          {% elif distance_from_target > 1.5 and time_in_current_mode >= effectiveness_check_mins %}
            2  {# Using original check time for moderate escalation #}
          {% elif time_in_current_mode >= (stall_time_threshold / 2) and temp_change_rate | abs < (min_progress_rate / 2) and distance_from_target > 0.3 %}
            2  {# EARLY TIME-BASED STALL WARNING: Half stall time with extremely poor progress (user-configurable) #}

          {# Level 1: LOW - Minor escalation #}
          {% elif distance_from_target > 1.0 and time_in_current_mode >= (effectiveness_check_mins + 2) %}
            1  {# Slight distance after extended time #}
          {% elif current_effectiveness <= 60 and time_in_current_mode >= (effectiveness_check_mins + 5) %}
            1  {# Mediocre effectiveness after extra time #}

          {% else %}
            0  {# No escalation needed #}
          {% endif %}
        {% endif %}

      # Stall & Wrong-direction incremental escalation (optional feature)
      # v3.8.0: Enhanced to detect BOTH wrong direction AND slow progress (stalling)
      wrong_direction_enabled: !input enable_wrong_direction_escalation
      wrong_direction_per_check: !input wrong_direction_escalation_per_check
      wrong_direction_min_rate: !input wrong_direction_min_rate

      # Detect stall or wrong direction
      # Wrong direction: temp moving opposite way (rising during cooling, falling during heating)
      # Stalling: temp moving right way but TOO slowly (slower than min_progress_rate)
      wrong_direction_detected: >
        {{
          (wrong_direction_enabled and wrong_direction_per_check > 0) and
          (
            (last_mode in ['cooling', 'cooling_low', 'cooling_medium', 'cooling_high'] and
             (temp_change_rate > wrong_direction_min_rate or (temp_change_rate < 0 and temp_change_rate > -min_progress_rate))) or
            (last_mode in ['heating', 'heating_low', 'heating_medium', 'heating_high'] and
             (temp_change_rate < -wrong_direction_min_rate or (temp_change_rate > 0 and temp_change_rate < min_progress_rate)))
          )
        }}

      # Helper to track consecutive stall/wrong-direction checks
      # NOTE: This needs a helper entity to persist between runs
      # For now, we'll use a simpler approach: add escalation based on current check only
      wrong_direction_escalation_add: >
        {% if wrong_direction_detected %}
          {{ wrong_direction_per_check | int(1) }}
        {% else %}
          0
        {% endif %}

      # Outside temperature escalation boost - start with higher fan speed on extreme days
      outside_temp_escalation_boost: >
        {% if enable_outside_temp_compensation %}
          {% set outdoor = outdoor_temperature | float(25) %}
          {% set outdoor_delta = outdoor - outside_compensation_base_temp %}
          {% set is_cooling = last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
          {% set is_heating = last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}

          {% if is_cooling and outdoor_delta > 0 %}
            {# Hot outside - boost fan speed for cooling #}
            {% if outdoor_delta >= 10 %}
              2  {# 35Â°C+ outside â†’ Start at Fan 3 (escalation +2) #}
            {% elif outdoor_delta >= 5 %}
              1  {# 30Â°C+ outside â†’ Start at Fan 2 (escalation +1) #}
            {% else %}
              0
            {% endif %}
          {% elif is_heating and outdoor_delta < 0 %}
            {# Cold outside - boost fan speed for heating #}
            {% if outdoor_delta <= -10 %}
              2  {# 15Â°C or colder outside â†’ Start at Fan 3 (escalation +2) #}
            {% elif outdoor_delta <= -5 %}
              1  {# 20Â°C or colder outside â†’ Start at Fan 2 (escalation +1) #}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}

      # Final escalation level includes: normal escalation + wrong-direction + outside temp boost
      # NOTE: All fan speed logic should reference final_escalation_level instead of escalation_level
      final_escalation_level: >
        {% set base_level = escalation_level | int(0) %}
        {% set wrong_dir_add = wrong_direction_escalation_add | int(0) %}
        {% set outside_boost = outside_temp_escalation_boost | int(0) %}
        {% set total_level = base_level + wrong_dir_add + outside_boost %}
        {{ [total_level, 4] | min }}

      # Combined AC setpoint adjustment:
      # 1. Outside Temperature Compensation (initial strategy based on outdoor conditions)
      # 2. Dynamic Escalation (performance monitoring adjustments)
      # This gives AC the best starting point AND adjusts based on actual performance
      adjusted_target: >
        {% set base = target_temp %}
        {# v3.9.19 FIX: Detect cooling/heating from current temp + last_mode, not just last_mode #}
        {# When OFF, use current temp to predict which mode will activate #}
        {% set mode_is_cooling = last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
        {% set mode_is_heating = last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
        {% set temp_needs_cooling = current_temp > comfort_max_temp %}
        {% set temp_needs_heating = current_temp < comfort_min_temp %}
        {% set is_cooling = mode_is_cooling or (not mode_is_heating and temp_needs_cooling) %}
        {% set is_heating = mode_is_heating or (not mode_is_cooling and temp_needs_heating) %}

        {# Step 1: Apply outside temperature compensation if enabled #}
        {% if enable_outside_temp_compensation and (is_cooling or is_heating) %}
          {% set outdoor = outdoor_temperature | float(25) %}
          {% set outdoor_delta = outdoor - outside_compensation_base_temp %}

          {% if is_cooling and outdoor_delta > 0 %}
            {# Hot outside - undershoot target to counteract heat influx #}
            {% set base = base - outside_temp_compensation_amount %}
          {% elif is_heating and outdoor_delta < 0 %}
            {# Cold outside - overshoot target to counteract cold influx #}
            {% set base = base + outside_temp_compensation_amount %}
          {% endif %}
        {% endif %}

        {# Step 2: Apply dynamic escalation adjustment if enabled #}
        {% if enable_dynamic_target and final_escalation_level > 0 and (is_cooling or is_heating) %}
          {% set escalation_adj = final_escalation_level * escalation_offset %}
          {% if is_cooling %}
            {% set base = base - escalation_adj %}
          {% elif is_heating %}
            {% set base = base + escalation_adj %}
          {% endif %}
        {% endif %}

        {# Get AC's actual temperature limits with smart fallbacks #}
        {% set user_min = ac_minimum_temp | float(0) %}
        {% set user_max = ac_maximum_temp | float(0) %}
        {% set reported_min = state_attr(climate_list[0], 'min_temp') | float(16) %}
        {% set reported_max = state_attr(climate_list[0], 'max_temp') | float(30) %}

        {# Priority: User override (if non-zero) â†’ Reported values â†’ Safe defaults #}
        {% set ac_min_temp = user_min if user_min > 0 else reported_min %}
        {% set ac_max_temp = user_max if user_max > 0 else reported_max %}

        {# Safety limits: Respect AC hardware limits while allowing escalation adjustments #}
        {% if is_cooling %}
          {# Allow cooling below target_temp when escalated, but respect AC minimum temp #}
          {{ [ac_min_temp, base] | max | round(1) }}
        {% elif is_heating %}
          {# Allow heating above target_temp when escalated, but respect AC maximum temp #}
          {{ [base, ac_max_temp] | min | round(1) }}
        {% else %}
          {{ target_temp }}
        {% endif %}

      # Hysteresis logic - prevent rapid switching at temperature boundaries
      last_transition: >
        {% if helper_last_transition %}
          {% set transition_state = states(helper_last_transition) | default('none') %}
          {{ 'none' if transition_state in ['unknown', 'unavailable', ''] else transition_state }}
        {% else %}
          none
        {% endif %}
      
      cooling_with_hysteresis: >
        {% if last_transition == 'heating' %}
          {# Coming from heating - need extra margin to switch to cooling #}
          {{ current_temp > (comfort_max_temp + hysteresis_tolerance) }}
        {% else %}
          {# Standard cooling threshold #}
          {{ current_temp > comfort_max_temp }}
        {% endif %}
      
      heating_with_hysteresis: >
        {% if last_transition == 'cooling' %}
          {# Coming from cooling - need extra margin to switch to heating #}
          {{ current_temp < (comfort_min_temp - hysteresis_tolerance) }}
        {% else %}
          {# Standard heating threshold #}
          {{ current_temp < comfort_min_temp }}
        {% endif %}
      
      # Enhanced escalation logic with multiple triggers and graduated response
      should_escalate: >
        {{ final_escalation_level > 0 }}
      
      # Smart mode calculations
      control_mode: >
        {% if control_mode_helper %}
          {{ states(control_mode_helper) | default('Auto') }}
        {% else %}
          Auto
        {% endif %}
      
      room_presence_detected: >
        {% set validation_mode = presence_validation | default('any') | lower %}
        {% set sensor_count = room_sensors | length %}
        
        {# If no sensors configured, always return false #}
        {% if sensor_count == 0 %}
          false
        {% else %}
          {# Categorize sensors and check their states #}
          {% set sensors_triggered = namespace(count=0) %}
          {% set ble_detected = namespace(value=false) %}
          {% set motion_detected = namespace(value=false) %}
          {% set other_detected = namespace(value=false) %}
          {% set motion_sensor_count = namespace(count=0) %}
          {% set ble_sensor_count = namespace(count=0) %}
          
          {% for sensor in room_sensors %}
            {% set sensor_state = states(sensor) | lower %}
            {% set is_triggered = false %}
            
            {# Check if this is a BLE/area sensor #}
            {% if sensor.startswith('sensor.') and room_ble_name %}
              {% set ble_sensor_count.count = ble_sensor_count.count + 1 %}
              {% if sensor_state == room_ble_name | lower %}
                {% set ble_detected.value = true %}
                {% set is_triggered = true %}
              {# Check if BLE detected in adjacent rooms #}
              {% elif adjacent_room_list | length > 0 %}
                {% for adjacent_room in adjacent_room_list %}
                  {% if sensor_state == adjacent_room | lower %}
                    {% set ble_detected.value = true %}
                    {% set is_triggered = true %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            
            {# Check if this is a motion/binary sensor #}
            {% elif sensor.startswith('binary_sensor.') %}
              {% set motion_sensor_count.count = motion_sensor_count.count + 1 %}
              {% if is_state(sensor, 'on') or is_state(sensor, 'detected') or is_state(sensor, 'occupied') %}
                {% set motion_detected.value = true %}
                {% set is_triggered = true %}
              {% endif %}
            
            {# Check other sensor types #}
            {% elif is_state(sensor, 'on') or sensor_state in ['home', 'present', 'detected', 'occupied'] %}
              {% set other_detected.value = true %}
              {% set is_triggered = true %}
            {% endif %}
            
            {# Count triggered sensors #}
            {% if is_triggered %}
              {% set sensors_triggered.count = sensors_triggered.count + 1 %}
            {% endif %}
          {% endfor %}
          
          {# Apply validation mode logic #}
          {% if validation_mode == 'all' %}
            {# ALL mode - all sensors must be triggered #}
            {{ sensors_triggered.count == sensor_count }}
            
          {% elif validation_mode == 'majority' %}
            {# MAJORITY mode - more than half must be triggered #}
            {{ sensors_triggered.count > (sensor_count / 2) }}
            
          {% elif validation_mode == 'smart' %}
            {# SMART mode - intelligent BLE + motion validation #}
            {% if ble_sensor_count.count > 0 and motion_sensor_count.count > 0 %}
              {# Both BLE and motion sensors exist - require both #}
              {{ ble_detected.value and motion_detected.value }}
            {% elif ble_sensor_count.count > 0 %}
              {# Only BLE sensors - use BLE detection #}
              {{ ble_detected.value }}
            {% elif motion_sensor_count.count > 0 %}
              {# Only motion sensors - use motion detection #}
              {{ motion_detected.value }}
            {% else %}
              {# Other sensors only - any triggered #}
              {{ other_detected.value }}
            {% endif %}

          {% elif validation_mode == 'ble_motion' %}
            {# BLE_MOTION mode - BOTH BLE and motion required (strict, no fallback) #}
            {# Prevents motion blips from triggering without you in room #}
            {# Prevents BLE in adjacent room from triggering without motion #}
            {{ ble_detected.value and motion_detected.value }}

          {% elif validation_mode == 'ble_bed' %}
            {# BLE_BED mode - BOTH BLE and bed sensor required (strict, no fallback) #}
            {# Perfect for bedrooms - only activates when you're in bed with phone #}
            {# Prevents motion blips and BLE-only false triggers #}
            {{ ble_detected.value and other_detected.value }}

          {% elif validation_mode == 'ble_smart' %}
            {# BLE_SMART mode - BLE required + (motion OR bed sensor) #}
            {# Intelligent: detects awake (BLE+motion) OR sleeping (BLE+bed) #}
            {# Still requires BLE to prevent false motion/bed triggers #}
            {{ ble_detected.value and (motion_detected.value or other_detected.value) }}

          {% elif validation_mode == 'motion_only' %}
            {# MOTION_ONLY mode - motion sensor only (WARNING: prone to false triggers) #}
            {# Use presence_confirmation_delay to reduce false positives #}
            {{ motion_detected.value }}

          {% elif validation_mode == 'ble_only' %}
            {# BLE_ONLY mode - BLE sensor only (WARNING: adjacent room detection) #}
            {# Will trigger if phone detected anywhere BLE reaches #}
            {{ ble_detected.value }}

          {% elif validation_mode == 'bed_only' %}
            {# BED_ONLY mode - bed/occupancy sensor only #}
            {# Reliable for weight-based bed sensors #}
            {# Only activates AC when actually in bed #}
            {{ other_detected.value }}

          {% elif validation_mode == 'ble_plus' %}
            {# BLE_PLUS mode - require BLE + at least one other sensor #}
            {% if ble_sensor_count.count > 0 %}
              {{ ble_detected.value and (motion_detected.value or other_detected.value) }}
            {% else %}
              {# No BLE sensors - fallback to ANY mode #}
              {{ sensors_triggered.count > 0 }}
            {% endif %}
            
          {% else %}
            {# ANY mode (default) - any sensor triggered #}
            {{ sensors_triggered.count > 0 }}
          {% endif %}
        {% endif %}
      
      last_presence_time: >
        {% if presence_detected_helper and states(presence_detected_helper) not in ['unknown', 'unavailable', ''] %}
          {{ states(presence_detected_helper) | as_datetime }}
        {% else %}
          {{ now() }}
        {% endif %}
      
      minutes_since_presence: >
        {% if room_presence_detected %}
          0
        {% else %}
          {% set presence_time_val = states(presence_detected_helper) if presence_detected_helper else 'unknown' %}
          {% if presence_time_val not in ['unknown', 'unavailable', '', None] %}
            {% set presence_timestamp = as_timestamp(presence_time_val) %}
            {% if presence_timestamp %}
              {{ ((as_timestamp(now()) - presence_timestamp) / 60) | round(0) | abs }}
            {% else %}
              999
            {% endif %}
          {% else %}
            999
          {% endif %}
        {% endif %}

      minutes_with_presence: >
        {% if room_presence_detected %}
          {% set presence_time_val = states(presence_detected_helper) if presence_detected_helper else 'unknown' %}
          {% if presence_time_val not in ['unknown', 'unavailable', '', None] %}
            {% set presence_timestamp = as_timestamp(presence_time_val) %}
            {% if presence_timestamp %}
              {{ ((as_timestamp(now()) - presence_timestamp) / 60) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      
      current_distance: >
        {% if proximity_sensor %}
          {{ states(proximity_sensor) | float(99999) }}
        {% else %}
          99999
        {% endif %}
      
      proximity_zone: >
        {% if current_distance < home_zone_distance %}
          home
        {% else %}
          away
        {% endif %}
      
      smart_presence_active: >
        {% if control_mode == 'Manual' %}
          false
        {% elif control_mode == 'Smart' %}
          {# Smart mode with grace period for short absences (bathroom trips, etc.) #}
          {% if room_presence_detected and minutes_with_presence >= presence_confirmation_delay %}
            true
          {% elif minutes_since_presence < presence_timeout %}
            {# Grace period applies when: #}
            {# 1. Instant activation (no confirmation delay) - always applies #}
            {# 2. Had prior confirmed presence - left after AC was already running #}
            {# v3.8.2 FIX: Check if last presence timer shows we HAD accumulated enough time #}
            {# This prevents grace period from keeping AC on if someone just walked in briefly #}
            {% set last_timer_val = states(presence_detected_helper) if presence_detected_helper else 'unknown' %}
            {% if last_timer_val not in ['unknown', 'unavailable', '', None] %}
              {% set time_when_left = as_timestamp(last_timer_val) %}
              {% set time_at_timeout = as_timestamp(now()) - (presence_timeout * 60) %}
              {# If timer was set more than (timeout + confirmation_delay) ago, we had confirmed presence #}
              {{ (presence_confirmation_delay == 0) or (time_when_left < time_at_timeout) }}
            {% else %}
              false
            {% endif %}
          {% elif approaching_home %}
            true
          {% else %}
            false
          {% endif %}
        {% elif control_mode == 'Auto' %}
          {# Auto mode - more permissive presence logic #}
          {% if room_presence_detected %}
            true
          {% elif minutes_since_presence < presence_timeout %}
            true
          {% elif proximity_zone == 'home' %}
            true
          {% elif anyone_home %}
            true
          {% else %}
            false
          {% endif %}
        {% else %}
          false
        {% endif %}
      
      extreme_temp_detected: >
        {% if not extreme_override %}
          false
        {% elif current_temp > extreme_high %}
          hot
        {% elif current_temp < extreme_low %}
          cold
        {% else %}
          false
        {% endif %}
      
      # Check if user manually changed AC settings (from HA or remote)
      # v3.3.0 SUPER ROBUST: Enhanced detection for temp, fan, swing, HVAC mode changes
      # v3.7.6 FIX: Removed unnecessary 15-second buffer - flag system handles persistence
      # v3.8.9 FIX: Skip detection if not periodic_check OR if automation just made changes
      manual_change_detected: >
        {% set result = false %}

        {# v3.8.9 FIX: ONLY check on periodic_check trigger - prevents race conditions #}
        {# When automation changes AC, climate entity state change triggers BEFORE helpers update #}
        {# This causes false detection: Expected=23Â°C, Actual=15Â°C (automation just set) #}
        {% set is_periodic_check = (trigger.id == 'periodic_check') %}
        {% if not is_periodic_check %}
          {% set result = false %}
        {% else %}

        {% set last_mode_state = states(helper_mode) | default('off') %}
        {% set actual_state = actual_ac_state %}

        {# v3.8.11 CRITICAL FIX: actual_ac_state returns 'on'/'off', not HVAC modes #}
        {# BUG: Was checking actual_state in ['cooling', 'heat', ...] but actual_state only ever = 'on' or 'off' #}
        {# This caused false positives: helper='off', actual='on' â†’ always triggered override #}

        {# v3.9.14 FIX: Don't flag as manual if helper was JUST updated (state sync ran recently) #}
        {# When automation turns ON AC, helper takes a moment to update. State sync fixes this. #}
        {# If state sync JUST ran (helper updated in last 3min), it's NOT a manual change! #}
        {% set helper_change_time = states(helper_change) %}
        {% set helper_recently_updated = false %}
        {% if helper_change_time and helper_change_time not in ['unknown', 'unavailable', ''] %}
          {% set minutes_since_helper_change = (as_timestamp(now()) - as_timestamp(helper_change_time)) / 60 %}
          {% set helper_recently_updated = minutes_since_helper_change < 3 %}
        {% endif %}

        {% set is_onoff_manual = (
          (last_mode_state in ['cooling_high', 'cooling_medium', 'cooling_low', 'heating_high', 'heating_medium', 'heating_low', 'eco'] and actual_state == 'off') or
          (last_mode_state == 'off' and actual_state == 'on' and not helper_recently_updated)
        ) %}

        {# v3.9.3 FIX: Skip detection if helpers look stale - prevents false positives after HA restart #}
        {# When HA restarts: helpers reset to initial values, but AC units stay in their physical state #}
        {# This mismatch causes false manual override detection #}

        {% set expected_temp = states(helper_expected_temp) | float(0) %}
        {% set helpers_temp_invalid = (expected_temp < 16 or expected_temp > 30) %}

        {# Check if helper hasn't been updated in a long time - suggests HA restart or stuck helper #}
        {% set helper_last_changed = state_attr(helper_mode, 'last_changed') %}
        {% set minutes_since_helper_update = ((as_timestamp(now()) - as_timestamp(helper_last_changed, 0)) / 60) if helper_last_changed else 9999 %}
        {% set helper_seems_stale = minutes_since_helper_update > 180 %}  {# 3+ hours = likely HA restart #}

        {# Also check: if last_mode is 'off' but hasn't changed in 2+ hours while AC is on = stale #}
        {% set mode_stuck_at_off = (last_mode_state == 'off' and minutes_since_helper_update > 120 and actual_state == 'on') %}

        {% if helpers_temp_invalid or helper_seems_stale or mode_stuck_at_off %}
          {% set result = false %}
        {% else %}
        {% set actual_temp = state_attr(climate_list[0], 'temperature') | float(0) %}
        {% set temp_tolerance = 0.5 %}
        {% set is_temp_manual = (
          actual_state != 'off' and
          expected_temp > 0 and
          actual_temp > 0 and
          (actual_temp - expected_temp) | abs > temp_tolerance
        ) %}

        {% set expected_fan = states(helper_expected_fan) | default('unknown') %}
        {% set actual_fan = state_attr(climate_list[0], 'fan_mode') | default('unknown') %}
        {% set expected_fan_lower = expected_fan | lower %}
        {% set actual_fan_lower = actual_fan | lower %}
        {% set is_fan_manual = (
          actual_state != 'off' and
          expected_fan not in ['unknown', 'unavailable', '', 'none'] and
          actual_fan not in ['unknown', 'unavailable', '', 'none'] and
          expected_fan_lower != actual_fan_lower
        ) %}

        {% set expected_swing = states(helper_expected_swing) | default('unknown') %}
        {% set actual_swing = state_attr(climate_list[0], 'swing_mode') | default('unknown') %}
        {% set expected_swing_lower = expected_swing | lower %}
        {% set actual_swing_lower = actual_swing | lower %}
        {% set expected_normalized = expected_swing_lower.replace('horizontal+vertical', 'both').replace('all', 'both') %}
        {% set actual_normalized = actual_swing_lower.replace('horizontal+vertical', 'both').replace('all', 'both') %}
        {% set is_swing_manual = (
          actual_state != 'off' and
          expected_swing not in ['unknown', 'unavailable', '', 'none'] and
          actual_swing not in ['unknown', 'unavailable', '', 'none'] and
          expected_normalized != actual_normalized
        ) %}

        {% set expected_hvac = states(helper_expected_hvac) | default('unknown') %}
        {% set actual_hvac = states(climate_list[0]) | default('unknown') %}
        {% set hvac_map = {
          'cool': 'cooling',
          'heat': 'heating',
          'heat_cool': 'auto',
          'fan_only': 'fan',
          'dry': 'dehumidify'
        } %}
        {% set expected_hvac_normalized = hvac_map.get(expected_hvac, expected_hvac) %}
        {% set actual_hvac_normalized = hvac_map.get(actual_hvac, actual_hvac) %}
        {% set is_hvac_manual = (
          expected_hvac not in ['unknown', 'unavailable', '', 'none', 'off'] and
          actual_hvac not in ['unknown', 'unavailable', '', 'none', 'off'] and
          expected_hvac_normalized != actual_hvac_normalized
        ) %}

        {% set result = is_onoff_manual or is_temp_manual or is_fan_manual or is_swing_manual or is_hvac_manual %}
        {% endif %}
        {% endif %}

        {{ result }}

      # Manual Override - Proper flag-based system with separate tracking
      # v3.1.9d CRITICAL FIX: Boolean type conversion - Jinja2 multiline templates return strings!
      # The string "false" is TRUTHY in Python/Jinja2, so "false" and control_mode != 'Manual' = TRUE!
      # MUST use | bool filter to convert string to actual boolean type
      manual_override_active: >
        {{
          (trigger.id != 'mode_change') and
          (control_mode != 'Manual') and
          (adaptive_override_timeout > 0) and
          (helper_override_flag and is_state(helper_override_flag, 'on')) and
          (
            helper_override_timestamp and
            states(helper_override_timestamp) not in ['unknown', 'unavailable', ''] and
            ((as_timestamp(now()) - as_timestamp(states(helper_override_timestamp))) / 3600) < adaptive_override_timeout
          )
        }}

      # DEBUG: Manual change detection values
      debug_manual_detection: >
        DEBUG: manual_change_detected={{ manual_change_detected }}, helper_mode={{ states(helper_mode) | default('off') }}, actual_ac_state={{ actual_ac_state }}


      should_activate: >
        {# v3.9.20 FIX: Runtime protection overrides ALL activation logic #}
        {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] and time_in_current_mode < runtime_min %}
          {# ABSOLUTE RUNTIME PROTECTION: AC must stay on for minimum runtime regardless of presence, temperature, or mode #}
          true
        {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime and time_in_current_mode <= offtime_min %}
          {# ABSOLUTE OFF-TIME PROTECTION: AC must stay off for minimum off-time regardless of presence or temperature #}
          false
        {% elif control_mode == 'Manual' %}
          {# In manual mode, only activate for extreme temperatures with presence #}
          {% if extreme_temp_detected not in [false, 'false'] and (room_presence_detected or approaching_home) %}
            true
          {% else %}
            false
          {% endif %}
        {% elif manual_override_active %}
          {# User manually changed settings - respect the override timeout #}
          false
        {% elif control_mode == 'Smart' %}
          {% if not room_presence_detected and smart_behavior == 'off' and not extreme_temp_detected %}
            {# No presence detected and smart behavior is OFF = turn off/stay off #}
            false
          {% elif room_presence_detected and last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] %}
            {# v3.9.23 FIX: Presence detected NOW + AC already running = keep running during confirmation delay #}
            {# This prevents AC from turning off during the presence_confirmation_delay period #}
            true
          {% else %}
            {# Either no presence or AC not running = require smart_presence_active confirmation #}
            {{ smart_presence_active }}
          {% endif %}
        {% else %}
          {{ anyone_home or approaching_home }}
        {% endif %}


  # Continue to next actions - variables calculated successfully
  - condition: template
    value_template: "{{ true }}"  # Always continue

  # DISABLED: No longer auto-switching to Manual mode when manual changes detected
  # The automation will continue to work normally even if user manually adjusts AC

  # Update presence helper only when room presence FIRST becomes detected after being away
  # v3.8.3 FIX: Never reset timer during active presence session
  # OLD LOGIC: Timer would reset after (timeout + 5) buffer even if someone still in room
  # Result: Multi-person rooms (Office with 2 people) would reset timer when one person left
  # NEW LOGIC: Timer only resets when truly away for extended period (timeout * 2 + 5) minutes
  # This provides buffer for continuous multi-person presence scenarios

  # Set timer when ENTERING room (starting new presence session)
  # v3.8.5 FIX: Simple logic - if timer is older than timeout, we're starting fresh
  # SET timer when ENTERING room (starting NEW presence session)
  # v3.8.7 FIX: Only set if timer shows you LEFT the room (expired state from reset block below)
  # v3.9.24 FIX: Don't reset timer if smart_presence_active (you've been here a while)
  # Timer is "expired" when it's set to (NOW - timeout - 1) by the reset block
  # This means: timer older than (timeout + 1) = you left and grace period expired = NEW session
  - if:
      - condition: template
        value_template: "{{ room_presence_detected and presence_detected_helper not in [none, '', 'unavailable', 'unknown'] }}"
      - condition: template
        value_template: >
          {% if presence_detected_helper and states(presence_detected_helper) not in ['unknown', 'unavailable', ''] %}
            {% set last_presence_timestamp = as_timestamp(states(presence_detected_helper)) %}
            {% set current_timestamp = as_timestamp(now()) %}
            {% set minutes_since_timer_set = (current_timestamp - last_presence_timestamp) / 60 %}
            {# Timer in "expired" state means you previously LEFT (reset block set it to NOW - timeout - 1) #}
            {# v3.9.24 FIX: Only reset if NOT already confirmed (smart_presence_active = False) #}
            {# If smart_presence_active = True, you've been here a while, don't reset! #}
            {{ (minutes_since_timer_set > (presence_timeout + 1) and not smart_presence_active) or minutes_since_timer_set > 120 }}
          {% else %}
            true
          {% endif %}
    then:
      - service: input_datetime.set_datetime
        target:
          entity_id: "{{ presence_detected_helper }}"
        data:
          datetime: "{{ now() }}"

  # Reset timer when presence LOST (so next entry starts fresh)
  # v3.8.5 FIX: Reset to (NOW - timeout - 1 min) = "expired" timer
  # This makes timer appear "old" so next detection triggers new session
  # Only reset if we recently had presence (prevents resetting already-expired timer repeatedly)
  - if:
      - condition: template
        value_template: "{{ not room_presence_detected and presence_detected_helper not in [none, '', 'unavailable', 'unknown'] }}"
      - condition: template
        value_template: >
          {% if presence_detected_helper and states(presence_detected_helper) not in ['unknown', 'unavailable', ''] %}
            {% set last_presence_timestamp = as_timestamp(states(presence_detected_helper)) %}
            {% set current_timestamp = as_timestamp(now()) %}
            {% set minutes_since_timer_set = (current_timestamp - last_presence_timestamp) / 60 %}
            {# Only reset if timer is recent (we just lost presence) - prevents unnecessary resets #}
            {{ minutes_since_timer_set <= (presence_timeout * 2) }}
          {% else %}
            false
          {% endif %}
    then:
      - service: input_datetime.set_datetime
        target:
          entity_id: "{{ presence_detected_helper }}"
        data:
          datetime: "{{ (now() - timedelta(minutes=presence_timeout + 1)).strftime('%Y-%m-%d %H:%M:%S') }}"

  # Manual Override Flag Management - SET flag when manual change detected
  # v3.1.9: Proper flag-based override system with separate tracking
  # v3.3.3: Added mode change buffer to prevent false detections from mode transitions
  - if:
      - condition: template
        value_template: "{{ manual_change_detected and not manual_override_active }}"
      - condition: template
        value_template: "{{ helper_override_flag not in [none, '', 'unavailable', 'unknown'] }}"
      - condition: template
        value_template: >
          {% set mode_change_buffer = 5 %}
          {% if helper_mode_time and states(helper_mode_time) not in ['unknown', 'unavailable', ''] %}
            {% set time_since_mode_change = (as_timestamp(now()) - as_timestamp(states(helper_mode_time))) / 60 %}
            {{ time_since_mode_change >= mode_change_buffer }}
          {% else %}
            true
          {% endif %}
    then:
      # SET the override flag
      - service: input_boolean.turn_on
        target:
          entity_id: "{{ helper_override_flag }}"
        continue_on_error: true

      # Record the timestamp when override was activated
      - service: input_datetime.set_datetime
        target:
          entity_id: "{{ helper_override_timestamp }}"
        data:
          datetime: "{{ now() }}"
        continue_on_error: true

      # Debug log
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                ğŸš¨ {{ room_name | upper }} MANUAL OVERRIDE ACTIVATED
                â€¢ Reason: Manual change detected (user intervention)
                â€¢ Helper state: {{ states(helper_mode) | default('off') }}
                â€¢ Actual AC state: {{ actual_ac_state }}
                â€¢ Override will block automation for {{ adaptive_override_timeout }} hour(s)
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

  # CLEAR override flag if timeout has expired
  - if:
      - condition: template
        value_template: >
          {% if is_state(helper_override_flag, 'on') and helper_override_timestamp and states(helper_override_timestamp) not in ['unknown', 'unavailable', ''] %}
            {% set override_time = as_timestamp(states(helper_override_timestamp)) %}
            {% if override_time %}
              {% set time_since_override = (as_timestamp(now()) - override_time) / 3600 %}
              {{ time_since_override >= adaptive_override_timeout }}
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}
      - condition: template
        value_template: "{{ helper_override_flag not in [none, '', 'unavailable', 'unknown'] }}"
    then:
      # Clear the override flag (timeout expired)
      - service: input_boolean.turn_off
        target:
          entity_id: "{{ helper_override_flag }}"
        continue_on_error: true

      # Debug log
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                âœ… {{ room_name | upper }} MANUAL OVERRIDE CLEARED
                â€¢ Reason: Timeout period expired ({{ adaptive_override_timeout }} hour(s))
                â€¢ Automation control resuming
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

  # Update temperature stability tracking - record when temp became stable
  - condition: template
    value_template: "{{ helper_temp_stable_since not in [none, '', 'unavailable', 'unknown'] and helper_temp_history not in [none, '', 'unavailable', 'unknown'] }}"
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set temp_diff = (current_temp - previous_temp) | abs %}
              {% set was_stable = states(helper_temp_stable_since) not in ['unknown', 'unavailable', '', None] %}
              {{ temp_diff <= stability_tolerance and not was_stable }}
        sequence:
          # Temperature just became stable - record the time
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_temp_stable_since }}"
            data:
              datetime: "{{ now() }}"
      
      - conditions:
          - condition: template
            value_template: >
              {% set temp_diff = (current_temp - previous_temp) | abs %}
              {{ temp_diff > stability_tolerance }}
        sequence:
          # Temperature is no longer stable - set to current time
          # This resets the stability timer without causing calculation issues
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_temp_stable_since }}"
            data:
              datetime: "{{ now() }}"
  
  # Exit immediately if windows are open (unless disabled)
  - condition: template
    value_template: "{{ not window_open or not enable_window_detection }}"
  
  - variables:
      # Enhanced predictive de-escalation with smooth transitions
      deescalation_level: >
        {% if not dynamic_enabled %}
          0
        {% else %}
          {% set approaching_threshold = deescalation_threshold %}  {# Distance to start de-escalating #}
          {% set close_threshold = approaching_threshold / 2 %}    {# Very close to target #}
          {% set rate_threshold = 0.3 %}  {# Â°C/min change rate for predictions #}
          
          {# Level 0: No de-escalation #}
          {% if distance_from_target > approaching_threshold %}
            0  {# Still far from target #}
          {% elif calculated_trend == 'stable' or calculated_trend == '' %}
            0  {# No clear trend to predict #}
          
          {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
          {% elif distance_from_target <= close_threshold and current_effectiveness >= 90 %}
            3  {# Very close and working exceptionally well - switch to maintenance #}
          {% elif distance_from_target <= 0.3 %}
            3  {# Extremely close to target - final approach mode #}
          {% elif last_mode == 'cooling' and calculated_trend == 'falling' and (current_temp - cooling_target_temp) <= 1.0 %}
            3  {# Cooling and approaching target closely #}
          {% elif last_mode == 'heating' and calculated_trend == 'rising' and (heating_target_temp - current_temp) <= 1.0 %}
            3  {# Heating and approaching target closely #}
          
          {# Level 2: HIGH de-escalation - Reduce to medium power #}
          {% elif distance_from_target <= 0.8 and current_effectiveness >= 80 %}
            2  {# Very close and highly effective - reduce power but not to minimum #}
          {% elif distance_from_target <= approaching_threshold and current_effectiveness >= 60 %}
            2  {# Approaching and working reasonably well #}
          {% elif distance_from_target <= 1.5 and calculated_trend != 'stable' %}
            2  {# Getting close with clear progress #}
          {% elif temp_change_rate | abs >= rate_threshold and distance_from_target <= 2.0 %}
            2  {# Fast progress toward target - predict overshoot #}
          
          {# Level 1: LOW de-escalation - Minor power reduction #}
          {% elif distance_from_target <= approaching_threshold and current_effectiveness >= 40 %}
            1  {# Approaching with moderate effectiveness #}
          {% elif distance_from_target <= 2.5 and time_in_current_mode >= 10 %}
            1  {# Moderate distance after sufficient time #}
          
          {% else %}
            0  {# Continue current power level #}
          {% endif %}
        {% endif %}
      
      should_deescalate: >
        {{ deescalation_level > 0 }}

      # Calculate expected fan speed for debug display
      calculated_fan_speed: >
        {% set fans = state_attr(climate_list[0], 'fan_modes') | list if climate_list | length > 0 else [] %}
        {% set current_mode = states(helper_mode) | default('off') %}

        {# Predict what mode will activate if currently off #}
        {% if current_mode == 'off' %}
          {% if current_temp >= cooling_high_temp %}
            {% set predicted_mode = 'cooling_high' %}
          {% elif current_temp >= cooling_medium_temp %}
            {% set predicted_mode = 'cooling_medium' %}
          {% elif current_temp >= cooling_low_temp %}
            {% set predicted_mode = 'cooling_low' %}
          {% elif current_temp <= heating_high_temp %}
            {% set predicted_mode = 'heating_high' %}
          {% elif current_temp <= heating_medium_temp %}
            {% set predicted_mode = 'heating_medium' %}
          {% elif current_temp <= heating_low_temp %}
            {% set predicted_mode = 'heating_low' %}
          {% else %}
            {% set predicted_mode = 'off' %}
          {% endif %}
        {% else %}
          {% set predicted_mode = current_mode %}
        {% endif %}

        {% if predicted_mode in ['cooling_high', 'heating_high'] %}
          {# HIGH mode fan selection logic #}
          {% if deescalation_level == 3 and final_escalation_level == 0 %}
            {% if 'quiet' in fans %}quiet{% elif 'Quiet' in fans %}Quiet{% elif 'silence' in fans %}silence{% elif 'Silence' in fans %}Silence{% elif '1' in fans %}1{% elif 'Level 1' in fans %}Level 1{% elif 'low' in fans %}low{% elif 'Low' in fans %}Low{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[0] if fans else 'Auto' }}{% endif %}
          {% elif deescalation_level == 2 and final_escalation_level == 0 %}
            {% if '3' in fans %}3{% elif 'Level 3' in fans %}Level 3{% elif 'medium' in fans %}medium{% elif 'Medium' in fans %}Medium{% elif 'low' in fans %}low{% elif 'Low' in fans %}Low{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}{% endif %}
          {% elif deescalation_level == 1 and final_escalation_level == 0 %}
            {% if '4' in fans %}4{% elif 'Level 4' in fans %}Level 4{% elif 'high' in fans %}high{% elif 'High' in fans %}High{% elif '3' in fans %}3{% elif 'Level 3' in fans %}Level 3{% elif 'medium' in fans %}medium{% elif 'Medium' in fans %}Medium{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[3] if fans|length > 3 else (fans[2] if fans|length > 2 else fans[-1]) }}{% endif %}
          {% else %}
            {% set desired_max_fan = fan_speed_max %}
            {% if desired_max_fan in fans %}{{ desired_max_fan }}{% elif '5' in fans %}5{% elif 'Level 5' in fans %}Level 5{% elif 'turbo' in fans %}turbo{% elif 'Turbo' in fans %}Turbo{% elif 'max' in fans %}max{% elif 'Max' in fans %}Max{% elif 'high' in fans %}high{% elif 'High' in fans %}High{% elif 'Auto' in fans %}Auto{% elif 'auto' in fans %}auto{% else %}{{ fans[-1] if fans else 'Auto' }}{% endif %}
          {% endif %}
        {% elif predicted_mode in ['cooling_medium', 'heating_medium'] %}
          {# MEDIUM mode fan selection logic #}
          {% if deescalation_level == 3 and final_escalation_level == 0 %}
            {% if 'quiet' in fans %}quiet{% elif 'Quiet' in fans %}Quiet{% elif 'silence' in fans %}silence{% elif 'Silence' in fans %}Silence{% elif '1' in fans %}1{% elif 'Level 1' in fans %}Level 1{% elif 'low' in fans %}low{% elif 'Low' in fans %}Low{% else %}{{ fans[0] if fans else 'Auto' }}{% endif %}
          {% elif deescalation_level == 2 and final_escalation_level == 0 %}
            {% if '2' in fans %}2{% elif 'Level 2' in fans %}Level 2{% elif 'low' in fans %}low{% elif 'Low' in fans %}Low{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[1] if fans|length > 1 else fans[0] }}{% endif %}
          {% elif deescalation_level == 1 and final_escalation_level == 0 %}
            {% if '3' in fans %}3{% elif 'Level 3' in fans %}Level 3{% elif 'medium' in fans %}medium{% elif 'Medium' in fans %}Medium{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[2] if fans|length > 2 else fans[-1] }}{% endif %}
          {% else %}
            {% if '4' in fans %}4{% elif 'Level 4' in fans %}Level 4{% elif 'high' in fans %}high{% elif 'High' in fans %}High{% elif '3' in fans %}3{% elif 'Level 3' in fans %}Level 3{% elif 'medium' in fans %}medium{% elif 'Medium' in fans %}Medium{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[-2] if fans|length > 1 else fans[0] }}{% endif %}
          {% endif %}
        {% elif predicted_mode in ['cooling_low', 'heating_low'] %}
          {# LOW mode fan selection logic #}
          {% if deescalation_level >= 2 and final_escalation_level == 0 %}
            {% if 'quiet' in fans %}quiet{% elif 'Quiet' in fans %}Quiet{% elif 'silence' in fans %}silence{% elif 'Silence' in fans %}Silence{% elif '1' in fans %}1{% elif 'Level 1' in fans %}Level 1{% elif 'low' in fans %}low{% elif 'Low' in fans %}Low{% else %}{{ fans[0] if fans else 'Auto' }}{% endif %}
          {% else %}
            {% if '2' in fans %}2{% elif 'Level 2' in fans %}Level 2{% elif 'low' in fans %}low{% elif 'Low' in fans %}Low{% elif 'auto' in fans %}auto{% elif 'Auto' in fans %}Auto{% else %}{{ fans[1] if fans|length > 1 else fans[0] }}{% endif %}
          {% endif %}
        {% else %}
          Auto
        {% endif %}
  
  # Debug: Log dynamic escalation timing configuration
  - if:
      - condition: template
        value_template: "{{ debug_enabled and dynamic_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} DYNAMIC ESCALATION TIMING DEBUG

            ğŸ“Š User Configuration:
                â€¢ Effectiveness Check Interval: {{ effectiveness_check_mins }} minutes
                â€¢ Runtime: {{ time_in_current_mode | round(1) }} min ({{ (time_in_current_mode - effectiveness_check_mins) | round(1) }} min {{ 'over' if time_in_current_mode >= effectiveness_check_mins else 'under' }} threshold)

            â° Escalation Time Thresholds:
                â€¢ Level 2 (1.5Â°C distance): {{ effectiveness_check_mins }}min â†’ {{ 'READY' if time_in_current_mode >= effectiveness_check_mins else 'WAITING' }}
                â€¢ Level 1 (1.0Â°C distance): {{ effectiveness_check_mins + 2 }}min â†’ {{ 'READY' if time_in_current_mode >= (effectiveness_check_mins + 2) else 'WAITING' }}
                â€¢ Level 1 (â‰¤60% effectiveness): {{ effectiveness_check_mins + 5 }}min â†’ {{ 'READY' if time_in_current_mode >= (effectiveness_check_mins + 5) else 'WAITING' }}

            ğŸ“ˆ Current Status:
                â€¢ Distance from target: {{ distance_from_target | round(1) }}Â°C
                â€¢ Current effectiveness: {{ current_effectiveness }}%
                â€¢ Escalation level: {{ final_escalation_level }}/4
                â€¢ Should escalate: {{ should_escalate }}
          level: debug
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}.dynamic"

  # Debug: Log presence validation details
  - if:
      - condition: template
        value_template: "{{ debug_enabled and room_sensors | length > 0 }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} PRESENCE VALIDATION DEBUG
            
            ğŸ“Š Sensor Analysis:
            {% set validation_mode = presence_validation | default('any') | lower %}
            {% set sensors_triggered = namespace(count=0, list=[]) %}
            {% set ble_detected = namespace(value=false, sensors=[]) %}
            {% set motion_detected = namespace(value=false, sensors=[]) %}
            {% set other_detected = namespace(value=false, sensors=[]) %}
            
            {% for sensor in room_sensors %}
              {% set sensor_state = states(sensor) | lower %}
              {% set is_triggered = false %}
              
              {% if sensor.startswith('sensor.') and room_ble_name %}
                {% set detected_room = '' %}
                {% if sensor_state == room_ble_name | lower %}
                  {% set ble_detected.value = true %}
                  {% set ble_detected.sensors = ble_detected.sensors + [sensor] %}
                  {% set is_triggered = true %}
                  {% set detected_room = room_ble_name %}
                {% elif adjacent_room_list | length > 0 %}
                  {% for adjacent_room in adjacent_room_list %}
                    {% if sensor_state == adjacent_room | lower %}
                      {% set ble_detected.value = true %}
                      {% set ble_detected.sensors = ble_detected.sensors + [sensor] %}
                      {% set is_triggered = true %}
                      {% set detected_room = adjacent_room ~ ' (adjacent)' %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                â€¢ BLE: {{ sensor }} = "{{ sensor_state }}" ({{ 'TRIGGERED - ' ~ detected_room if is_triggered else 'not detected' }})
              {% elif sensor.startswith('binary_sensor.') %}
                {% if is_state(sensor, 'on') or is_state(sensor, 'detected') or is_state(sensor, 'occupied') %}
                  {% set motion_detected.value = true %}
                  {% set motion_detected.sensors = motion_detected.sensors + [sensor] %}
                  {% set is_triggered = true %}
                {% endif %}
                â€¢ Motion: {{ sensor }} = {{ states(sensor) }} ({{ 'TRIGGERED' if is_triggered else 'clear' }})
              {% else %}
                {% if is_state(sensor, 'on') or sensor_state in ['home', 'present', 'detected', 'occupied'] %}
                  {% set other_detected.value = true %}
                  {% set other_detected.sensors = other_detected.sensors + [sensor] %}
                  {% set is_triggered = true %}
                {% endif %}
                â€¢ Other: {{ sensor }} = {{ states(sensor) }} ({{ 'TRIGGERED' if is_triggered else 'inactive' }})
              {% endif %}
              
              {% if is_triggered %}
                {% set sensors_triggered.count = sensors_triggered.count + 1 %}
                {% set sensors_triggered.list = sensors_triggered.list + [sensor] %}
              {% endif %}
            {% endfor %}
            
            ğŸ¯ Validation Summary:
                â€¢ Mode: {{ validation_mode | upper }}
                â€¢ Total Sensors: {{ room_sensors | length }}
                â€¢ Triggered: {{ sensors_triggered.count }} ({{ sensors_triggered.list | join(', ') if sensors_triggered.list else 'none' }})
            
            ğŸ“Š Detection Results:
                â€¢ BLE Detected: {{ ble_detected.value }} ({{ ble_detected.sensors | join(', ') if ble_detected.sensors else 'none' }})
                â€¢ Motion Detected: {{ motion_detected.value }} ({{ motion_detected.sensors | join(', ') if motion_detected.sensors else 'none' }})
                â€¢ Other Detected: {{ other_detected.value }} ({{ other_detected.sensors | join(', ') if other_detected.sensors else 'none' }})
            
            âœ… Room Presence Result: {{ room_presence_detected }}
            {% if validation_mode == 'smart' and ble_detected.sensors | length > 0 and motion_detected.sensors | length == 0 %}
            âš ï¸ BLE detected but no motion - likely false trigger from adjacent room
            {% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}.presence"

  # Debug: Log current conditions
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ“Š {{ room_name | upper }} CLIMATE CONTROL STATUS
            
            ğŸŒ¡ï¸ Current Conditions:
                â€¢ Temperature: {{ current_temp }}Â°C {% if calculated_trend == 'rising' %}â†—ï¸ Rising{% elif calculated_trend == 'falling' %}â†˜ï¸ Falling{% else %}â¡ï¸ Stable{% endif %}
                â€¢ People: {% if room_presence_detected %}Room occupied{% elif anyone_home %}Home (elsewhere){% elif approaching_home %}Approaching{% else %}Away{% endif %}
                â€¢ Room Presence: {{ 'DETECTED' if room_presence_detected else 'Empty' }} (Mode: {{ presence_validation | default('any') | upper }})
                â€¢ Current Mode: {% if should_activate and last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] %}{{ last_mode|title }}{% if dynamic_enabled and final_escalation_level > 0 %} - ESCALATING L{{ final_escalation_level }} ğŸ”¼{% elif dynamic_enabled and deescalation_level > 0 %} - DE-ESCALATING L{{ deescalation_level }} ğŸ”½{% elif dynamic_enabled and current_effectiveness >= 80 %} - EFFECTIVE ({{ current_effectiveness }}%) âš–ï¸{% endif %} (running {{ time_in_current_mode | round(0) }} min){% elif actual_ac_state == 'off' %}OFF âš«{% elif current_temp >= comfort_min_temp and current_temp <= comfort_max_temp %}IDLE - COMFORT ZONE{% if dynamic_enabled and deescalation_level > 0 %} (DE-ESCALATED L{{ deescalation_level }}) ğŸ”½{% endif %} âœ…{% elif should_activate %}MONITORING - CONDITIONS NOT MET â¸ï¸{% else %}STANDBY - LAST: {{ last_mode|title }} ({{ time_in_current_mode | round(0) }} min ago){% endif %}
                â€¢ Fan Speed: {{ state_attr(climate_list[0], 'fan_mode') | default('Unknown') | title }}
                â€¢ Swing: {{ state_attr(climate_list[0], 'swing_mode') | default('Unknown') | title }}
                â€¢ Control Mode: {{ control_mode }} (from: {{ control_mode_helper if control_mode_helper else 'NO HELPER' }})
            
            ğŸ¯ System Status:
                {% if temp_stability_enabled and temp_stability_detected and last_mode not in ['stability_off', 'stability_eco'] %}â€¢ Temperature stable for {{ temp_stability_time | round(0) }} min - ready for auto-off{% elif temp_stability_enabled and last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] %}â€¢ Continue mode active - pursuing {{ target_temp }}Â°C target ({{ (current_temp - target_temp) | round(1) }}Â°C to go){% elif last_mode in ['stability_off', 'stability_eco'] %}â€¢ AC off due to temperature stability{% elif current_temp < comfort_min_temp %}â€¢ Too cold - needs heating{% elif current_temp > comfort_max_temp %}â€¢ Too hot - needs cooling{% else %}â€¢ Perfect temperature{% endif %}
            
            ğŸ“‹ Technical Details:
                â€¢ Comfort Zone: {{ comfort_min_temp }}-{{ comfort_max_temp }}Â°C
                â€¢ Cooling Triggers: {{ cooling_low_temp }}Â°C (low), {{ cooling_medium_temp }}Â°C (medium), {{ cooling_high_temp }}Â°C (high)
                â€¢ Heating Triggers: {{ heating_low_temp }}Â°C (low), {{ heating_medium_temp }}Â°C (medium), {{ heating_high_temp }}Â°C (high)
            {% if temp_stability_enabled %}    â€¢ Stability: {{ 'ACTIVE - AC OFF' if last_mode in ['stability_off', 'stability_eco'] else 'DETECTED' if temp_stability_detected else 'Continue mode - pursuing target' if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] else 'Monitoring - Outside comfort zone' if current_temp < comfort_min_temp or current_temp > comfort_max_temp else 'Monitoring' }} (Â±{{ stability_tolerance }}Â°C for {{ stability_duration }}min, target Â±0.5Â°C){% endif %}
                â€¢ Trend: {{ temp_change_rate }}Â°C/min, Distance: {{ distance_from_target | round(1) }}Â°C, Effectiveness: {{ current_effectiveness }}%
            {% if dynamic_enabled %}    â€¢ Dynamic: Escalation Level {{ final_escalation_level }}/4, De-escalation Level {{ deescalation_level }}/3 (Check Interval: {{ effectiveness_check_mins }}min)
                â€¢ Stall Check: distance={{ distance_from_target | round(1) }}â‰¤0.8? time={{ time_in_current_mode | round(1) }}â‰¥15min? trend={{ calculated_trend }} rate={{ temp_change_rate | round(2) }}Â°C/min{% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
  
  # Update effectiveness score helper
  - if:
      - condition: template
        value_template: "{{ dynamic_enabled and helper_effectiveness not in [none, '', 'unavailable', 'unknown'] }}"
    then:
      - service: input_number.set_value
        target:
          entity_id: "{{ helper_effectiveness }}"
        data:
          value: "{{ current_effectiveness }}"

  - if:
      - condition: template
        value_template: "{{ dynamic_enabled and helper_trend not in [none, '', 'unavailable', 'unknown'] }}"
    then:
      - service: input_text.set_value
        target:
          entity_id: "{{ helper_trend }}"
        data:
          value: "{{ calculated_trend }}"

  # Debug: Log the actual last_mode value to see what's happening
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} DEBUG Part 1: Basic conditions

            ğŸ“Š Core Variables:
                â€¢ last_mode (internal): "{{ last_mode }}"
                â€¢ actual_ac_state: "{{ actual_ac_state }}"
                â€¢ should_activate: {{ should_activate }}
                â€¢ current_temp: {{ current_temp }}Â°C
                â€¢ cooling_high: {{ cooling_high_temp }}Â°C
                â€¢ cooling_medium: {{ cooling_medium_temp }}Â°C
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  - if:
      - condition: template
        value_template: "{{ debug_enabled and dynamic_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} ESCALATION DEBUG

            ğŸ“Š Escalation Conditions:
                â€¢ distance_from_target: {{ distance_from_target | round(1) }}Â°C
                â€¢ time_in_current_mode: {{ time_in_current_mode | round(1) }}min
                â€¢ current_effectiveness: {{ current_effectiveness }}%
                â€¢ calculated_trend: {{ calculated_trend }}
                â€¢ temp_change_rate: {{ temp_change_rate | round(3) }}Â°C/min

            ğŸ¯ Near-Target Stall Detection (Level 1):
                â€¢ Distance â‰¤ {{ temp_tolerance }}Â°C: {{ distance_from_target <= temp_tolerance }}
                â€¢ Time â‰¥ 15min: {{ time_in_current_mode >= 15 }}
                â€¢ Stable/slow: {{ calculated_trend == 'stable' or temp_change_rate | abs < 0.1 }}
                â€¢ SHOULD TRIGGER: {{ distance_from_target <= temp_tolerance and time_in_current_mode >= 15 and (calculated_trend == 'stable' or temp_change_rate | abs < 0.1) }}

            â±ï¸ Time-Based Stall Detection (Level 3):
                â€¢ Time â‰¥ {{ stall_time_threshold }}min: {{ time_in_current_mode >= stall_time_threshold }}
                â€¢ Progress rate < {{ min_progress_rate }}Â°C/min: {{ temp_change_rate | abs < min_progress_rate }} (current: {{ temp_change_rate | abs | round(3) }}Â°C/min)
                â€¢ Distance > {{ (temp_tolerance / 2) | round(1) }}Â°C: {{ distance_from_target > (temp_tolerance / 2) }}
                â€¢ SHOULD TRIGGER: {{ time_in_current_mode >= stall_time_threshold and temp_change_rate | abs < min_progress_rate and distance_from_target > (temp_tolerance / 2) }}

            ğŸš¨ Extended Stall Detection (Level 4 Emergency):
                â€¢ Extended threshold: {{ (stall_time_threshold * extended_stall_multiplier) | round(0) }}min ({{ stall_time_threshold }}min Ã— {{ extended_stall_multiplier }})
                â€¢ Time in mode: {{ time_in_current_mode | round(1) }}min
                â€¢ Time â‰¥ threshold: {{ time_in_current_mode >= (stall_time_threshold * extended_stall_multiplier) }}
                â€¢ Progress rate < {{ min_progress_rate }}Â°C/min: {{ temp_change_rate | abs < min_progress_rate }} (current: {{ temp_change_rate | abs | round(3) }}Â°C/min)
                â€¢ Distance > 1.5Â°C: {{ distance_from_target > 1.5 }} (current: {{ distance_from_target | round(1) }}Â°C)
                â€¢ SHOULD TRIGGER EMERGENCY: {{ time_in_current_mode >= (stall_time_threshold * extended_stall_multiplier) and temp_change_rate | abs < min_progress_rate and distance_from_target > 1.5 }}

            âš¡ Result: Base Escalation Level = {{ escalation_level }}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  - if:
      - condition: template
        value_template: "{{ debug_enabled and dynamic_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ”½ {{ room_name | upper }} DE-ESCALATION DEBUG

            ğŸ“Š De-escalation Conditions:
                â€¢ distance_from_target: {{ distance_from_target | round(1) }}Â°C
                â€¢ deescalation_threshold: {{ deescalation_threshold }}Â°C (start reducing power within this distance)
                â€¢ close_threshold: {{ deescalation_threshold / 2 }}Â°C (very close to target)
                â€¢ current_effectiveness: {{ current_effectiveness }}%
                â€¢ calculated_trend: {{ calculated_trend }}
                â€¢ temp_change_rate: {{ temp_change_rate | round(3) }}Â°C/min
                â€¢ time_in_current_mode: {{ time_in_current_mode | round(1) }}min

            ğŸ¯ De-escalation Level Analysis:
                {% if not dynamic_enabled %}
                â€¢ Dynamic Escalation DISABLED - no de-escalation
                {% elif distance_from_target > deescalation_threshold %}
                â€¢ Level 0: Too far from target ({{ distance_from_target | round(1) }}Â°C > {{ deescalation_threshold }}Â°C)
                â€¢ NO de-escalation - maintain current power
                {% elif calculated_trend == 'stable' or calculated_trend == '' %}
                â€¢ Level 0: No clear temperature trend detected
                â€¢ Cannot predict if we'll overshoot - maintain current power
                {% elif distance_from_target <= (deescalation_threshold / 2) and current_effectiveness >= 90 %}
                â€¢ Level 3: MAXIMUM de-escalation
                â€¢ Very close ({{ distance_from_target | round(1) }}Â°C) AND highly effective ({{ current_effectiveness }}%)
                â€¢ Action: Switch to maintenance/eco mode to prevent overshoot
                {% elif distance_from_target <= 0.3 %}
                â€¢ Level 3: MAXIMUM de-escalation
                â€¢ Extremely close to target ({{ distance_from_target | round(1) }}Â°C â‰¤ 0.3Â°C)
                â€¢ Action: Final approach - minimal power
                {% elif distance_from_target <= 0.8 and current_effectiveness >= 80 %}
                â€¢ Level 2: HIGH de-escalation
                â€¢ Close to target ({{ distance_from_target | round(1) }}Â°C â‰¤ 0.8Â°C) with good effectiveness ({{ current_effectiveness }}%)
                â€¢ Action: Reduce to medium power
                {% elif distance_from_target <= 1.5 and calculated_trend != 'stable' %}
                â€¢ Level 2: HIGH de-escalation
                â€¢ Getting close ({{ distance_from_target | round(1) }}Â°C â‰¤ 1.5Â°C) with clear progress
                â€¢ Action: Preventive reduction to avoid overshoot
                {% elif distance_from_target <= deescalation_threshold and current_effectiveness >= 40 %}
                â€¢ Level 1: LOW de-escalation
                â€¢ Approaching target ({{ distance_from_target | round(1) }}Â°C â‰¤ {{ deescalation_threshold }}Â°C)
                â€¢ Action: Minor power reduction
                {% else %}
                â€¢ Level 0: Continue current power level
                â€¢ Not yet close enough or effectiveness too low
                {% endif %}

            âš¡ Result: De-escalation Level = {{ deescalation_level }}

            ğŸ¯ Office Specific Settings:
                â€¢ Your de-escalation threshold: {{ deescalation_threshold }}Â°C (0.8Â°C = very aggressive)
                â€¢ Current distance: {{ distance_from_target | round(1) }}Â°C
                â€¢ Will de-escalate when: {{ distance_from_target | round(1) }}Â°C â‰¤ {{ deescalation_threshold }}Â°C
                {% if distance_from_target > deescalation_threshold %}
                â€¢ âš ï¸ Still {{ (distance_from_target - deescalation_threshold) | round(1) }}Â°C away from de-escalation range
                {% else %}
                â€¢ âœ… In de-escalation range - reducing power!
                {% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}.deescalation"

  - if:
      - condition: template
        value_template: "{{ debug_enabled and dynamic_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} STALL & WRONG-DIRECTION ESCALATION DEBUG

            ğŸ“Š Feature Status:
                â€¢ Stall & Wrong-Direction Escalation Enabled: {{ wrong_direction_enabled }}
                â€¢ Escalation Per Check: +{{ wrong_direction_per_check }} levels

            ğŸŒ¡ï¸ Temperature Trend Analysis:
                â€¢ Current Mode: {{ last_mode }}
                â€¢ Temperature Trend: {{ calculated_trend }}
                â€¢ Time in Current Mode: {{ time_in_current_mode | round(1) }} min
                â€¢ Effectiveness Check Interval: {{ effectiveness_check_mins }} min

            ğŸš¨ Stall & Wrong Direction Detection:
                {% if last_mode in ['cooling', 'cooling_low', 'cooling_medium', 'cooling_high'] %}
                â€¢ Mode: Cooling
                â€¢ Expected: Temperature FALLING at rate > {{ min_progress_rate }}Â°C/min
                â€¢ Actual Rate: {{ temp_change_rate | round(3) }}Â°C/min
                â€¢ Wrong Direction (rising): {{ temp_change_rate > wrong_direction_min_rate }} (rate > +{{ wrong_direction_min_rate }}Â°C/min)
                â€¢ Stalling (cooling too slowly): {{ temp_change_rate < 0 and temp_change_rate > -min_progress_rate }} (rate between 0 and -{{ min_progress_rate }}Â°C/min)
                {% elif last_mode in ['heating', 'heating_low', 'heating_medium', 'heating_high'] %}
                â€¢ Mode: Heating
                â€¢ Expected: Temperature RISING at rate > {{ min_progress_rate }}Â°C/min
                â€¢ Actual Rate: {{ temp_change_rate | round(3) }}Â°C/min
                â€¢ Wrong Direction (falling): {{ temp_change_rate < -wrong_direction_min_rate }} (rate < -{{ wrong_direction_min_rate }}Â°C/min)
                â€¢ Stalling (heating too slowly): {{ temp_change_rate > 0 and temp_change_rate < min_progress_rate }} (rate between 0 and +{{ min_progress_rate }}Â°C/min)
                {% else %}
                â€¢ Mode: {{ last_mode }} (not cooling/heating)
                â€¢ Stall/Wrong Direction: Not Applicable
                {% endif %}

            âš¡ Incremental Escalation Calculation:
                â€¢ Stall or Wrong Direction Detected: {{ wrong_direction_detected }}
                â€¢ Wrong Direction Threshold: {{ wrong_direction_min_rate }}Â°C/min
                â€¢ Minimum Progress Rate: {{ min_progress_rate }}Â°C/min
                â€¢ Current Rate: {{ temp_change_rate | round(3) }}Â°C/min
                â€¢ Escalation Add (This Check): +{{ wrong_direction_escalation_add }} levels
                â€¢ Base Escalation: Level {{ escalation_level }}
                â€¢ Final Escalation: Level {{ final_escalation_level }} (base + stall_add, capped at 4)

            ğŸ’¡ How Incremental Escalation Works:
                {% if not wrong_direction_enabled %}
                â€¢ Feature DISABLED - using base escalation only
                {% elif wrong_direction_per_check == 0 %}
                â€¢ Feature enabled but set to +0 - no escalation added
                {% elif not wrong_direction_detected %}
                â€¢ Temperature progressing well - no additional escalation needed
                {% else %}
                â€¢ Stall or wrong direction detected! Adding +{{ wrong_direction_per_check }} level(s) this check
                â€¢ At next effectiveness check (in ~{{ effectiveness_check_mins }} min), if still stalling/wrong: +{{ wrong_direction_per_check }} more
                â€¢ Escalation builds up: Check 1: +{{ wrong_direction_per_check }}, Check 2: +{{ wrong_direction_per_check * 2 }}, Check 3: +{{ wrong_direction_per_check * 3 }}, etc.
                â€¢ Stops escalating when temp progresses faster or reaches Level 4 (Fan 5 maximum)
                {% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}.wrong_direction"

  # DEBUG: Dynamic target adjustment
  - if:
      - condition: template
        value_template: "{{ debug_enabled and enable_dynamic_target and final_escalation_level > 0 }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ¯ {{ room_name | upper }} DEBUG: Dynamic Target Adjustment

            ğŸ”§ Smart Escalation Boost Active:
            â€¢ Feature Enabled: {{ enable_dynamic_target }}
            â€¢ User Desired Temperature: {{ target_temp }}Â°C
            â€¢ Final Escalation Level: {{ final_escalation_level }}
            â€¢ Offset Per Level: {{ escalation_offset }}Â°C
            â€¢ Total Adjustment: {{ (final_escalation_level * escalation_offset) | round(1) }}Â°C

            ğŸŒ¡ï¸ Target Calculation:
                â€¢ Current Mode: {{ last_mode }}
                {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                â€¢ Cooling Mode: LOWERING target to make AC work harder
                â€¢ Formula: {{ target_temp }}Â°C - ({{ final_escalation_level }} Ã— {{ escalation_offset }}Â°C) = {{ adjusted_target }}Â°C
                â€¢ AC will cool to {{ adjusted_target }}Â°C instead of {{ target_temp }}Â°C
                â€¢ Creates {{ (target_temp - adjusted_target) | round(1) }}Â°C buffer zone below user target
                {% elif last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
                â€¢ Heating Mode: RAISING target to make AC work harder
                â€¢ Formula: {{ target_temp }}Â°C + ({{ final_escalation_level }} Ã— {{ escalation_offset }}Â°C) = {{ adjusted_target }}Â°C
                â€¢ AC will heat to {{ adjusted_target }}Â°C instead of {{ target_temp }}Â°C
                â€¢ Creates {{ (adjusted_target - target_temp) | round(1) }}Â°C buffer zone above user target
                {% endif %}

            ğŸ’¡ Why This Helps:
                â€¢ AC compressor works harder with more aggressive target
                â€¢ Combined with Fan Level {{ final_escalation_level }} = maximum effectiveness
                â€¢ Buffer zone prevents immediate drift back when escalation reduces
                â€¢ Auto-reverts to {{ target_temp }}Â°C once temperature stable

            âš™ï¸ Behavior:
                â€¢ Target sent to AC: {{ adjusted_target }}Â°C ({{ "%.1f" | format(adjusted_target - target_temp) }}Â°C {% if adjusted_target > target_temp %}above{% else %}below{% endif %} user target)
                â€¢ Once stable and escalation drops to 0: Returns to {{ target_temp }}Â°C
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}.target_adjustment"

  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} DEBUG Part 2: Cooling checks

            ğŸŒ¡ï¸ Temperature Logic:
                â€¢ last_transition: "{{ last_transition }}"
                â€¢ hysteresis: {{ hysteresis_tolerance }}Â°C
                â€¢ temp >= high: {{ current_temp >= cooling_high_temp }}
                â€¢ time_since_change: {{ time_since_change | round(1) }}min
                â€¢ runtime_min: {{ runtime_min }}min
                â€¢ time_check: {{ time_since_change > runtime_min }}
                â€¢ mode_check: {{ last_mode != 'cooling' }}
                â€¢ actual_ac_off: {{ actual_ac_state == 'off' }}
                â€¢ HIGH cooling conditions: {% if last_mode == 'cooling_high' %}{{ current_temp > target_temp }} (continue until target){% else %}{{ should_activate and current_temp >= cooling_high_temp and actual_ac_state == 'off' }} (start condition){% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} DEBUG Part 3: Heating & Cooling checks

            ğŸ”¥ Heating Logic:
                â€¢ heating_low: {{ heating_low_temp }}Â°C
                â€¢ heating_medium: {{ heating_medium_temp }}Â°C
                â€¢ heating_high: {{ heating_high_temp }}Â°C
                â€¢ temp <= low: {{ current_temp <= heating_low_temp }}
                â€¢ temp <= medium: {{ current_temp <= heating_medium_temp }}
                â€¢ temp <= high: {{ current_temp <= heating_high_temp }}
                â€¢ time_check: {{ time_since_change > runtime_min }} ({{ time_since_change | round(1) }}min > {{ runtime_min }}min)
                â€¢ mode_check: {{ last_mode != 'heating' }} (last_mode: {{ last_mode }})
                â€¢ runtime_lockout: {{ 'ACTIVE - preventing activation' if time_since_change <= runtime_min and last_mode == 'heating' else 'inactive' }}
                â€¢ actual_ac_off: {{ actual_ac_state == 'off' }}
                â€¢ Heating Mode: {{ 'ENABLED' if enable_heating else 'DISABLED' }}
                â€¢ LOW heating conditions: {% if not enable_heating %}DISABLED{% elif last_mode == 'heating_low' %}{{ current_temp < target_temp and current_temp > heating_medium_temp }} (continue until target){% else %}{{ should_activate and enable_heating and current_temp <= heating_low_temp and current_temp > heating_medium_temp and (time_since_change > runtime_min or last_mode != 'heating_low') }} (start condition){% endif %}
                â€¢ MEDIUM heating conditions: {% if not enable_heating %}DISABLED{% elif last_mode == 'heating_medium' %}{{ current_temp < target_temp and current_temp > heating_high_temp }} (continue until target){% else %}{{ should_activate and enable_heating and current_temp <= heating_medium_temp and current_temp > heating_high_temp and (time_since_change > runtime_min or last_mode != 'heating_medium') }} (start condition){% endif %}
                â€¢ HIGH heating conditions: {% if not enable_heating %}DISABLED{% elif last_mode == 'heating_high' %}{{ current_temp < target_temp }} (continue until target){% else %}{{ should_activate and enable_heating and current_temp <= heating_high_temp and (time_since_change > runtime_min or last_mode != 'heating_high') }} (start condition){% endif %}

            â„ï¸ Cooling Logic:
                â€¢ cooling_low: {{ cooling_low_temp }}Â°C
                â€¢ cooling_medium: {{ cooling_medium_temp }}Â°C
                â€¢ cooling_high: {{ cooling_high_temp }}Â°C
                â€¢ temp >= low: {{ current_temp >= cooling_low_temp }}
                â€¢ temp >= medium: {{ current_temp >= cooling_medium_temp }}
                â€¢ temp >= high: {{ current_temp >= cooling_high_temp }}
                â€¢ time_check: {{ time_since_change > runtime_min }} ({{ time_since_change | round(1) }}min > {{ runtime_min }}min)
                â€¢ mode_check: {{ last_mode != 'cooling' }} (last_mode: {{ last_mode }})
                â€¢ runtime_lockout: {{ 'ACTIVE - preventing activation' if time_since_change <= runtime_min and last_mode == 'cooling' else 'inactive' }}
                â€¢ actual_ac_off: {{ actual_ac_state == 'off' }}
                â€¢ Cooling Mode: {{ 'ENABLED' if enable_cooling else 'DISABLED' }}
                â€¢ LOW cooling conditions: {% if not enable_cooling %}DISABLED{% elif last_mode == 'cooling_low' %}{{ current_temp > target_temp and current_temp < cooling_medium_temp }} (continue until target){% else %}{{ should_activate and enable_cooling and current_temp >= cooling_low_temp and current_temp < cooling_medium_temp and (time_since_change > runtime_min or last_mode != 'cooling_low') }} (start condition){% endif %}
                â€¢ MEDIUM cooling conditions: {% if not enable_cooling %}DISABLED{% elif last_mode == 'cooling_medium' %}{{ current_temp > target_temp and current_temp < cooling_high_temp }} (continue until target){% else %}{{ should_activate and enable_cooling and current_temp >= cooling_medium_temp and current_temp < cooling_high_temp and (time_since_change > runtime_min or last_mode != 'cooling_medium') }} (start condition){% endif %}
                â€¢ HIGH cooling conditions: {% if not enable_cooling %}DISABLED{% elif last_mode == 'cooling_high' %}{{ current_temp > target_temp }} (continue until target){% else %}{{ should_activate and enable_cooling and current_temp >= cooling_high_temp and actual_ac_state == 'off' }} (start condition){% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  # Manual Override Debug Logging - v3.3.0 Enhanced Detection
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ”’ {{ room_name | upper }} MANUAL OVERRIDE DEBUG (v3.3.0 SUPER ROBUST)

            â° Timing Requirements:
                â€¢ Trigger type: {{ trigger.id }}
                â€¢ Check interval: {{ check_interval }}min
                â€¢ Time since automation action: {{ time_since_change | round(1) }}min
                â€¢ Minimum wait required: {{ check_interval }}min
                â€¢ Detection window open: {{ trigger.id == 'periodic_check' and time_since_change >= check_interval }}
                â€¢ Mode change buffer: 5 min (prevents false detection after mode switches)
                â€¢ Time since mode change: {% if helper_mode_time and states(helper_mode_time) not in ['unknown', 'unavailable', ''] %}{{ ((as_timestamp(now()) - as_timestamp(states(helper_mode_time))) / 60) | round(1) }}min{% else %}unknown{% endif %}

            {% if trigger.id == 'periodic_check' and time_since_change >= check_interval %}

            ğŸ”› ON/OFF Detection:
                â€¢ Helper mode: {{ states(helper_mode) | default('off') }}
                â€¢ Actual AC state: {{ actual_ac_state }}
                â€¢ âœ… Manual ON/OFF detected: {% if (states(helper_mode) in ['cooling_high', 'cooling_medium', 'cooling_low', 'heating_high', 'heating_medium', 'heating_low', 'eco'] and actual_ac_state == 'off') or (states(helper_mode) == 'off' and actual_ac_state == 'on') %}YES{% else %}No{% endif %}

            ğŸŒ¡ï¸ Temperature Detection (Â±0.5Â°C tolerance):
                â€¢ Expected: {{ states(helper_expected_temp) }}Â°C
                â€¢ Actual: {{ state_attr(climate_list[0], 'temperature') }}Â°C
                â€¢ Difference: {{ (state_attr(climate_list[0], 'temperature') | float(0) - states(helper_expected_temp) | float(0)) | abs | round(2) }}Â°C
                â€¢ Tolerance: 0.5Â°C
                â€¢ âœ… Manual temp change detected: {% if actual_ac_state != 'off' and states(helper_expected_temp) | float(0) > 0 and state_attr(climate_list[0], 'temperature') | float(0) > 0 and ((state_attr(climate_list[0], 'temperature') | float(0) - states(helper_expected_temp) | float(0)) | abs > 0.5) %}YES{% else %}No{% endif %}

            ğŸ’¨ Fan Mode Detection (case-insensitive):
                â€¢ Expected: "{{ states(helper_expected_fan) }}"
                â€¢ Actual: "{{ state_attr(climate_list[0], 'fan_mode') }}"
                â€¢ âœ… Manual fan change detected: {% if actual_ac_state != 'off' and states(helper_expected_fan) not in ['unknown', 'unavailable', '', 'none'] and state_attr(climate_list[0], 'fan_mode') | default('unknown') not in ['unknown', 'unavailable', '', 'none'] and (states(helper_expected_fan) | lower) != (state_attr(climate_list[0], 'fan_mode') | default('unknown') | lower) %}YES{% else %}No{% endif %}

            ğŸŒŠ Swing Mode Detection (normalized):
                â€¢ Expected: "{{ states(helper_expected_swing) }}"
                â€¢ Actual: "{{ state_attr(climate_list[0], 'swing_mode') }}"
                â€¢ âœ… Manual swing change detected: {% if actual_ac_state != 'off' and states(helper_expected_swing) not in ['unknown', 'unavailable', '', 'none'] and state_attr(climate_list[0], 'swing_mode') | default('unknown') not in ['unknown', 'unavailable', '', 'none'] %}{% set exp_norm = (states(helper_expected_swing) | lower).replace('horizontal+vertical', 'both').replace('all', 'both') %}{% set act_norm = (state_attr(climate_list[0], 'swing_mode') | default('unknown') | lower).replace('horizontal+vertical', 'both').replace('all', 'both') %}{{ 'YES' if exp_norm != act_norm else 'No' }}{% else %}No{% endif %}

            ğŸ”§ HVAC Mode Detection:
                â€¢ Expected: "{{ states(helper_expected_hvac) }}"
                â€¢ Actual: "{{ states(climate_list[0]) }}"
                â€¢ âœ… Manual HVAC change detected: {% if states(helper_expected_hvac) not in ['unknown', 'unavailable', '', 'none', 'off'] and states(climate_list[0]) not in ['unknown', 'unavailable', '', 'none', 'off'] %}{% set hvac_map = {'cool': 'cooling', 'heat': 'heating', 'heat_cool': 'auto', 'fan_only': 'fan', 'dry': 'dehumidify'} %}{% set exp_norm = hvac_map.get(states(helper_expected_hvac), states(helper_expected_hvac)) %}{% set act_norm = hvac_map.get(states(climate_list[0]), states(climate_list[0])) %}{{ 'YES' if exp_norm != act_norm else 'No' }}{% else %}No{% endif %}

            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ¯ DETECTION RESULT: {{ 'YES - Manual change detected' if manual_change_detected else 'NO - No manual changes detected' }}

            {% if manual_change_detected %}
            ğŸ›¡ï¸ OVERRIDE ACTIVATION CHECK:
                â€¢ Manual change detected: YES
                â€¢ Mode change buffer satisfied: {% if helper_mode_time and states(helper_mode_time) not in ['unknown', 'unavailable', ''] %}{{ 'YES' if ((as_timestamp(now()) - as_timestamp(states(helper_mode_time))) / 60) >= 5 else 'NO - Within 5 min of mode change' }}{% else %}YES{% endif %}
                â€¢ Will activate override: {% if helper_mode_time and states(helper_mode_time) not in ['unknown', 'unavailable', ''] %}{{ 'YES' if ((as_timestamp(now()) - as_timestamp(states(helper_mode_time))) / 60) >= 5 else 'NO' }}{% else %}YES{% endif %}
            {% endif %}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

            {% else %}

            â¸ï¸ Detection skipped - waiting for periodic check with sufficient time buffer
                â€¢ Current trigger: {{ trigger.id }}
                â€¢ Time remaining: {{ (check_interval - time_since_change) | round(1) }}min until detection check

            {% endif %}

            {% if manual_override_active %}
            ğŸš« MANUAL OVERRIDE ACTIVE:
                â€¢ Override Flag: {{ states(helper_override_flag) if helper_override_flag else 'not configured' }}
                â€¢ Override Since: {{ states(helper_override_timestamp) if helper_override_timestamp else 'unknown' }}
                â€¢ Timeout: {{ adaptive_override_timeout }} hour(s)
                â€¢ should_activate: {{ should_activate }} (forced to FALSE by override)
                â€¢ Action: Automation is PAUSED - respecting user's manual changes
            {% else %}
            âœ… Override INACTIVE - automation free to operate normally
            {% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}.manual_override"

  # Presence Confirmation Delay Debug Logging (Smart Mode)
  - if:
      - condition: template
        value_template: "{{ debug_enabled and control_mode == 'Smart' }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ‘¤ {{ room_name | upper }} PRESENCE CONFIRMATION DEBUG

            â±ï¸ Delay Configuration:
                â€¢ presence_confirmation_delay: {{ presence_confirmation_delay }} minutes
                â€¢ presence_timeout (grace period): {{ presence_timeout }} minutes

            ğŸ” Current Status:
                â€¢ room_presence_detected: {{ room_presence_detected }}
                â€¢ minutes_with_presence: {{ minutes_with_presence | round(1) }} min
                â€¢ minutes_since_presence: {{ minutes_since_presence | round(0) }} min
                â€¢ smart_presence_active: {{ smart_presence_active }}

            {% if presence_confirmation_delay > 0 %}
            ğŸ“‹ Confirmation Delay Logic:
                {% if room_presence_detected %}
                âœ… Presence detected NOW:
                    â€¢ Time with presence: {{ minutes_with_presence | round(1) }} minutes
                    â€¢ Required delay: {{ presence_confirmation_delay }} minutes
                    â€¢ Status: {% if minutes_with_presence >= presence_confirmation_delay %}âœ… CONFIRMED - Can activate AC{% else %}â³ WAITING - {{ (presence_confirmation_delay - minutes_with_presence) | round(1) }} min until activation{% endif %}
                {% else %}
                âŒ No presence detected:
                    â€¢ Last seen: {{ minutes_since_presence | round(0) }} minutes ago
                    â€¢ Grace period: {{ presence_timeout }} minutes
                    â€¢ Status: {% if minutes_since_presence < presence_timeout %}â³ GRACE PERIOD ACTIVE - AC will stay on{% else %}âŒ GRACE PERIOD EXPIRED - AC will turn off{% endif %}
                {% endif %}
            {% else %}
            â„¹ï¸ Instant activation enabled (no confirmation delay)
            {% endif %}

            ğŸ¯ Final Decision:
                â€¢ smart_presence_active: {{ smart_presence_active }}
                â€¢ AC will: {% if smart_presence_active %}âœ… STAY ON / ACTIVATE{% else %}âŒ TURN OFF / STAY OFF{% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}.presence_delay"

  # ADAPTIVE CONTROL REACTIVATION: Clear adaptive_off when room is occupied and heating/cooling needed
  - if:
      - condition: template
        value_template: "{{ last_mode == 'adaptive_off' and adaptive_enabled and control_mode == 'Smart' }}"
      - condition: template
        value_template: "{{ room_presence_detected }}"
      - condition: template
        value_template: >
          {% if presence_detected_helper and states(presence_detected_helper) not in ['unknown', 'unavailable', ''] %}
            {% set presence_time = (as_timestamp(now()) - as_timestamp(states(presence_detected_helper))) / 60 %}
            {{ presence_time >= adaptive_occupied_delay }}
          {% else %}
            false
          {% endif %}
      - condition: template
        value_template: "{{ actual_ac_state == 'off' }}"
      - condition: template
        value_template: "{{ current_temp <= heating_medium_temp or current_temp >= cooling_medium_temp }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ”„ {{ room_name | upper }} ADAPTIVE REACTIVATION
            
            âœ… Conditions Met:
                â€¢ Was in adaptive_off mode
                â€¢ Room occupied for {{ ((as_timestamp(now()) - as_timestamp(states(presence_detected_helper))) / 60) | round(1) }}+ minutes
                â€¢ Temperature {{ current_temp }}Â°C requires action ({{ 'heating' if current_temp <= heating_medium_temp else 'cooling' }})
            
            ğŸ¯ Resuming normal Smart mode climate control
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
      
      # Clear adaptive_off mode - allow normal logic to proceed
      - service: input_text.set_value
        target:
          entity_id: !input helper_last_mode
        data:
          value: "off"

      # Update mode start time for off-time protection tracking (always update when going to OFF)
      - if:
          - condition: template
            value_template: "{{ helper_mode_time not in [none, '', 'unavailable', 'unknown'] }}"
        then:
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"

  # GLOBAL MANUAL OVERRIDE CHECK - Exit before choose blocks if override is active
  # This prevents automation from turning AC back on when user manually turned it off

  # DEBUG: Log all values IMMEDIATELY before condition evaluation
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} PRE-CONDITION EVALUATION DEBUG

            ğŸ“Š Variable States (at condition check time):
                â€¢ manual_override_active: {{ manual_override_active }}
                â€¢ control_mode: {{ control_mode }}
                â€¢ control_mode != 'Manual': {{ control_mode != 'Manual' }}
                â€¢ FULL CONDITION: {{ manual_override_active and control_mode != 'Manual' }}

            ğŸ” Helper Entity States:
                â€¢ helper_override_flag: {{ helper_override_flag if helper_override_flag else 'NOT CONFIGURED' }}
                â€¢ Flag state: {{ states(helper_override_flag) if helper_override_flag else 'N/A' }}
                â€¢ helper_override_timestamp: {{ helper_override_timestamp if helper_override_timestamp else 'NOT CONFIGURED' }}
                â€¢ Timestamp state: {{ states(helper_override_timestamp) if helper_override_timestamp else 'N/A' }}

            â±ï¸ Time Calculations:
                {% if helper_override_timestamp and states(helper_override_timestamp) not in ['unknown', 'unavailable', ''] %}
                {% set override_time = as_timestamp(states(helper_override_timestamp)) %}
                {% if override_time %}
                {% set time_since_override = (as_timestamp(now()) - override_time) / 3600 %}
                â€¢ Time since override: {{ time_since_override | round(2) }} hours
                â€¢ Timeout threshold: {{ adaptive_override_timeout }} hours
                â€¢ Time >= timeout: {{ time_since_override >= adaptive_override_timeout }}
                {% else %}
                â€¢ override_time calculation: FAILED (timestamp conversion)
                {% endif %}
                {% else %}
                â€¢ override_time calculation: SKIPPED (helper not available)
                {% endif %}

            ğŸ§® Condition Logic Breakdown:
                â€¢ IF manual_override_active = {{ manual_override_active }} ({{ 'TRUE' if manual_override_active else 'FALSE' }})
                â€¢ AND control_mode != 'Manual' = {{ control_mode != 'Manual' }} ({{ 'TRUE' if control_mode != 'Manual' else 'FALSE' }})
                â€¢ RESULT = {{ 'TRUE - WILL BLOCK' if (manual_override_active and control_mode != 'Manual') else 'FALSE - WILL NOT BLOCK' }}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

  - if:
      - condition: template
        value_template: "{{ manual_override_active and control_mode != 'Manual' }}"
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                ğŸš« {{ room_name | upper }} MANUAL OVERRIDE - BLOCKING AUTOMATION

                â¸ï¸ Automation Paused:
                    â€¢ User manually changed AC settings
                    â€¢ Override Flag: {{ states(helper_override_flag) if helper_override_flag else 'not configured' }}
                    â€¢ Override Since: {{ states(helper_override_timestamp) if helper_override_timestamp else 'unknown' }}
                    â€¢ Timeout: {{ adaptive_override_timeout }} hour(s)
                    â€¢ Control mode: {{ control_mode }}

                ğŸ”’ Respecting User Control:
                    â€¢ Last mode (helper): {{ states(helper_mode) | default('off') }}
                    â€¢ Actual AC state: {{ actual_ac_state }}
                    â€¢ All automation actions blocked until override expires

                â„¹ï¸ Override will clear automatically after {{ adaptive_override_timeout }} hour(s)
                   or immediately if you switch to Manual mode
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}.manual_override_block"
      # Exit immediately - don't process any choose blocks
      - stop: "Manual override active - respecting user's manual changes"

  - choose:
      # Handle Manual mode - True manual control with optional timeout
      - conditions:
          - condition: template
            value_template: "{{ control_mode == 'Manual' }}"
        sequence:
          # Check if Manual mode timeout has been reached
          - if:
              - condition: template
                value_template: "{{ manual_timeout_hours > 0 }}"
              - condition: template
                value_template: >
                  {% if helper_change and states(helper_change) not in ['unknown', 'unavailable', ''] %}
                    {% set change_timestamp = as_timestamp(states(helper_change)) %}
                    {% if change_timestamp %}
                      {% set time_in_manual = (as_timestamp(now()) - change_timestamp) / 3600 %}
                      {{ time_in_manual >= manual_timeout_hours }}
                    {% else %}
                      false
                    {% endif %}
                  {% else %}
                    false
                  {% endif %}
            then:
              - service: system_log.write
                data:
                  message: >
                    {% set change_timestamp = as_timestamp(states(helper_change)) %}
                    â° {{ room_name | upper }} MANUAL MODE TIMEOUT: Returning to automation
                    â€¢ Manual timeout reached: {{ manual_timeout_hours }} hours
                    â€¢ Time in manual: {{ ((as_timestamp(now()) - change_timestamp) / 3600) | round(1) if change_timestamp else 'N/A' }}h
                    â€¢ Switching back to Smart mode - automation will resume
                    â€¢ AC will continue running under normal automation control
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

              # Switch back to Smart mode (don't turn off AC)
              - condition: template
                value_template: "{{ control_mode_helper not in [none, '', 'unavailable', 'unknown'] }}"
              - service: input_select.select_option
                target:
                  entity_id: "{{ control_mode_helper }}"
                data:
                  option: "Smart"
                continue_on_error: true

              - service: input_text.set_value
                target:
                  entity_id: !input helper_last_mode
                data:
                  value: "manual_timeout_return_to_smart"
                continue_on_error: true

              - condition: template
                value_template: "{{ enable_notifications }}"
              - service: !input notification_service
                data:
                  title: "{{ room_name }} Climate Control"
                  message: "Manual timeout ({{ manual_timeout_hours }}h) - switched back to Smart mode"
              - stop: "Manual mode timeout - returned to Smart mode"
            else:
              # Manual mode continues - complete user control
              - condition: template
                value_template: "{{ debug_enabled }}"
              - service: system_log.write
                data:
                  message: >
                    {% set change_timestamp = as_timestamp(states(helper_change)) %}
                    ğŸ® {{ room_name | upper }} MANUAL MODE: Full user control active
                    â€¢ Temperature: {{ current_temp }}Â°C
                    â€¢ Timeout setting: {{ manual_mode_timeout }} ({{ manual_timeout_hours }}h)
                    {% if manual_timeout_hours > 0 %}
                    â€¢ Time remaining: {{ (manual_timeout_hours - ((as_timestamp(now()) - change_timestamp) / 3600)) | round(1) if change_timestamp else 'N/A' }}h
                    {% else %}
                    â€¢ No timeout - manual until you change it
                    {% endif %}
                    â€¢ FULL CONTROL: Set any temp/fan remotely - NO automation interference
                    â€¢ Perfect for pre-conditioning rooms before arrival!
                  level: debug
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
              - stop: "Manual mode active - user has complete control"

      # Skip if manual override is active (user changed AC while in Auto/Smart) - NEVER for mode changes
      - conditions:
          - condition: template
            value_template: "{{ manual_override_active and manual_change_detected }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    {% set change_timestamp = as_timestamp(states(helper_change)) %}
                    ğŸ”’ {{ room_name | upper }} MANUAL OVERRIDE: Respecting user changes
                    â€¢ Manual change detected: {{ manual_change_detected }}
                    â€¢ Last mode state: "{{ states(helper_mode) | default('off') }}"
                    â€¢ Actual AC state: "{{ actual_ac_state }}"
                    â€¢ Override timeout: {{ adaptive_override_timeout }} hours
                    â€¢ Time remaining: {{ (adaptive_override_timeout - ((as_timestamp(now()) - change_timestamp) / 3600)) | round(1) if change_timestamp else 'N/A' }} hours
                    â€¢ AC will maintain user settings until timeout expires
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # STOP HERE - Respect user's manual changes
          - stop: "Manual override active - respecting user changes"

      # HIGH HEATING: Smart hysteresis with direct helper reads
      - conditions:
          - condition: template
            value_template: >
              {% set current_mode = states(helper_mode) | default('off') %}
              {% if current_mode == 'heating_high' %}
                {# Continue HIGH only if AC running AND temp needs adjustment #}
                {% if time_in_current_mode < runtime_min %}
                  True  {# RUNTIME PROTECTION: Stay on for minimum runtime regardless of conditions #}
                {% elif current_temp >= (target_temp + target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - heated to {{ (target_temp + target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% elif control_mode == 'Smart' and not smart_presence_active %}
                  False  {# EXIT: Smart mode requires presence to continue #}
                {% elif actual_ac_state == 'off' %}
                  False  {# EXIT: AC is already off - don't restart from continue logic #}
                {% elif current_temp > heating_high_temp and (target_temp - current_temp) > 1.0 %}
                  False  {# EXIT: Temp rose above HIGH threshold and still >1Â°C from target - let MEDIUM tier take over #}
                {% else %}
                  {{ should_activate and enable_heating and current_temp < target_temp }}
                {% endif %}
              {% else %}
                {# Not heating high - start ONLY if threshold exceeded (escalation CANNOT start HIGH from OFF) #}
                {{ should_activate and enable_heating and current_temp <= heating_high_temp and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
                {# Same heating tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from cooling/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (target_temp - current_temp) | round(1) %}
                {% set temp_gap_adjusted = (adjusted_target - current_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 75 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}
                {% set esc_display = 'L' ~ escalation if escalation > 0 else ('DE-L' ~ deescalation if deescalation > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ AC Target: ' ~ adjusted_target ~ 'Â°C (User: ' ~ target_temp ~ 'Â°C' ~ (' | Escalation: +' ~ (adjusted_target - target_temp) | round(1) ~ 'Â°C)' if adjusted_target > target_temp else ')') if adjusted_target != target_temp else '' %}

                {% if current_mode == 'heating_high' %}
                  {% if temp_gap <= 0.5 %}
                    ğŸ¯ {{ room_name | upper }} HIGH HEATING - FINAL APPROACH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C almost at {{ adjusted_target }}Â°C target ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 90 %}| ğŸ”¥ MAXIMUM INTENSITY{% elif effectiveness >= 70 %}| âš¡ HIGH EFFECTIVENESS ({{ effectiveness }}%){% else %}| ğŸ”§ STRUGGLING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 2.0 %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - CRUISING TO TARGET
                    ğŸ“Š CONTINUE MODE: Heating {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - EMERGENCY MODE
                    ğŸ“Š CONTINUE MODE: Large gap {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C deficit!)
                    âš¡ Full power until comfortable | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 5.0 %}
                    ğŸš¨ {{ room_name | upper }} HIGH HEATING - EMERGENCY START
                    ğŸš€ START MODE: EXTREME cold {{ current_temp }}Â°C â‰¤ {{ heating_high_temp }}Â°C ({{ temp_gap_adjusted }}Â°C deficit!)
                    ğŸ”¥ Maximum heating power engaged | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 2.0 %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - RAPID WARM-UP
                    ğŸš€ START MODE: Cold {{ current_temp }}Â°C â‰¤ {{ heating_high_temp }}Â°C threshold
                    âš¡ High-power heating â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - PRECISION MODE
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¤ {{ heating_high_temp }}Â°C
                    ğŸ¯ Gentle approach to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: "heat"
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: "heat"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ adjusted_target }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan mode BEFORE turning on AC to prevent full-blast startup
          # HIGH heating always uses maximum fan speed (no escalation beyond this tier)
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"

                    # HIGH heating adaptive fan selection with de-escalation support
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {# Escalation always takes priority over de-escalation when system is stalled #}
                      {% if deescalation_level == 3 and final_escalation_level == 0 %}
                        {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 2 and final_escalation_level == 0 %}
                        {# Level 2: HIGH de-escalation - Reduce to medium power #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif deescalation_level == 1 and final_escalation_level == 0 %}
                        {# Level 1: LOW de-escalation - Reduce to high-medium power #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[3] if fans|length > 3 else (fans[2] if fans|length > 2 else fans[-1]) }}
                        {% endif %}
                        {% elif final_escalation_level == 0 %}
                        {# Escalation Level 0: Start gentle - Fan 1 #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif 'auto' in fans %}
                          auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Escalation Level 1: Small boost - Fan 2 #}
                        {% if '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Escalation Level 2: Moderate boost - Fan 3 #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Escalation Level 3: Strong boost - Fan 4 #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-2] if fans|length > 1 else fans[-1] }}
                        {% endif %}
                        {% else %}
                        {# Escalation Level 4: Emergency maximum - Fan 5 #}
                        {% set desired_max_fan = fan_speed_max %}
                        {% if '5' in fans %}
                          5
                        {% elif 'Level 5' in fans %}
                        Level 5
                        {% elif '4' in fans %}
                        4
                        {% elif 'Level 4' in fans %}
                        Level 4
                        {% elif 'turbo' in fans %}
                        turbo
                        {% elif 'Turbo' in fans %}
                        Turbo
                        {% elif 'max' in fans %}
                        max
                        {% elif 'Max' in fans %}
                        Max
                        {% elif 'high' in fans %}
                        high
                        {% elif 'High' in fans %}
                        High
                        {% elif 'Auto' in fans %}
                        Auto
                        {% elif 'auto' in fans %}
                        auto
                        {% else %}
                        {{ fans[-1] if fans else 'Auto' }}
                      {% endif %}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” HIGH HEAT MAXIMUM FAN: {{ repeat.item }}
                      â€¢ Escalation Level: {{ final_escalation_level }}/4 (max tier - Level 5 always)
                      â€¢ Fan Selection: {{ selected_fan_mode }} (maximum power)
                      â€¢ Effectiveness: {{ current_effectiveness }}% after {{ time_in_current_mode | round(1) }}min
                      â€¢ Distance from Target: {{ distance_from_target | round(1) }}Â°C
                      â€¢ Tier Reason: HIGH tier = emergency response, no escalation beyond Level 5
                      â€¢ Available Fans: {{ available_fans | join(', ') }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # v3.9.13: Wait for fan commands to complete (fan controllers can be slow)
          - delay:
              milliseconds: 2000

          # v3.9.13: NOW turn on AC with correct fan mode already set
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ adjusted_target }}"

          # Update helper entities on every activation (needed for rapid triggers to maintain state)
          # Update temperature history BEFORE updating mode (captures initial temp for effectiveness calculation)
          - if:
              - condition: template
                value_template: "{{ helper_temp_history not in [none, '', 'unavailable', 'unknown'] and states(helper_mode) | default('off') != 'heating_high' }}"
            then:
              - service: input_number.set_value
                target:
                  entity_id: "{{ helper_temp_history }}"
                data:
                  value: "{{ current_temp }}"
          # Always update mode helper to ensure state persistence despite rapid retriggering
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "heating_high"

          # v3.9.18 FIX: Update helper_last_change ONLY when mode changes (for runtime protection)
          - if:
              - condition: template
                value_template: "{{ states(helper_mode) | default('off') != 'heating_high' }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_last_change
                data:
                  datetime: "{{ now() }}"

      # MEDIUM HEATING: Smart hysteresis with direct helper reads
      - conditions:
          - condition: template
            value_template: >
              {% set current_mode = states(helper_mode) | default('off') %}
              {% if current_mode == 'heating_medium' %}
                {# Already heating medium - continue only if AC running AND temp needs adjustment #}
                {% if time_in_current_mode < runtime_min %}
                  True  {# RUNTIME PROTECTION: Stay on for minimum runtime regardless of conditions #}
                {% elif current_temp >= (target_temp + target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - heated to {{ (target_temp + target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% elif control_mode == 'Smart' and not smart_presence_active %}
                  False  {# EXIT: Smart mode requires presence to continue #}
                {% elif actual_ac_state == 'off' %}
                  False  {# EXIT: AC is already off - don't restart from continue logic #}
                {% elif current_temp > heating_medium_temp and (target_temp - current_temp) > 1.0 %}
                  False  {# EXIT: Temp rose above MEDIUM threshold and still >1Â°C from target - let LOW tier take over #}
                {% else %}
                  {{ should_activate and enable_heating and current_temp < target_temp }}
                {% endif %}
              {% else %}
                {# Not heating medium - start ONLY if in medium range (escalation CANNOT start MEDIUM from OFF) #}
                {% set time_protection_met = (last_mode in ['heating_low', 'heating_medium', 'heating_high'] and time_in_current_mode > runtime_min) or ((last_mode == 'off' or actual_ac_state == 'off') and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['heating_low', 'heating_medium', 'heating_high', 'off', 'smart_off']) %}
                {{ should_activate and enable_heating and current_temp <= heating_medium_temp and current_temp > heating_high_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
                {# Same heating tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from cooling/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (target_temp - current_temp) | round(1) %}
                {% set temp_gap_adjusted = (adjusted_target - current_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 75 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}
                {% set esc_display = 'L' ~ escalation if escalation > 0 else ('DE-L' ~ deescalation if deescalation > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ AC Target: ' ~ adjusted_target ~ 'Â°C (User: ' ~ target_temp ~ 'Â°C' ~ (' | Escalation: +' ~ (adjusted_target - target_temp) | round(1) ~ 'Â°C)' if adjusted_target > target_temp else ')') if adjusted_target != target_temp else '' %}

                {% if current_mode == 'heating_medium' %}
                  {% if temp_gap <= 0.5 %}
                    ğŸ¯ {{ room_name | upper }} MEDIUM HEATING - FINAL APPROACH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C nearly at {{ adjusted_target }}Â°C target ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 85 %}| ğŸ”¥ OPTIMAL EFFICIENCY{% elif effectiveness >= 65 %}| âš¡ GOOD EFFECTIVENESS ({{ effectiveness }}%){% else %}| ğŸ”§ ADJUSTING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 2.0 %}
                    ğŸ”¥ {{ room_name | upper }} MEDIUM HEATING - STEADY PROGRESS
                    ğŸ“Š CONTINUE MODE: Heating {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} MEDIUM HEATING - SUSTAINED MODE
                    ğŸ“Š CONTINUE MODE: Working gap {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat)
                    âš™ï¸ Balanced power until target | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 4.0 %}
                    ğŸ”¥ {{ room_name | upper }} MEDIUM HEATING - INTENSIVE START
                    ğŸš€ START MODE: Significant cold {{ current_temp }}Â°C â‰¤ {{ heating_medium_temp }}Â°C ({{ temp_gap_adjusted }}Â°C deficit)
                    âš¡ Steady heating power engaged | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 1.5 %}
                    ğŸ”¥ {{ room_name | upper }} MEDIUM HEATING - STANDARD WARM-UP
                    ğŸš€ START MODE: Moderate cold {{ current_temp }}Â°C â‰¤ {{ heating_medium_temp }}Â°C threshold
                    âš™ï¸ Balanced heating â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} MEDIUM HEATING - GENTLE MODE
                    ğŸš€ START MODE: Minor adjustment {{ current_temp }}Â°C â‰¤ {{ heating_medium_temp }}Â°C
                    ğŸ¯ Comfort warming to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: "heat"
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: "heat"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ adjusted_target }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan BEFORE temperature
          # Progressive fan speed for MEDIUM heating based on escalation level
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"

                    # MEDIUM heating adaptive fan selection with de-escalation support
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {# Escalation always takes priority over de-escalation when system is stalled #}
                      {% if deescalation_level == 3 and final_escalation_level == 0 %}
                        {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 2 and final_escalation_level == 0 %}
                        {# Level 2: HIGH de-escalation - Let AC auto-adjust for optimal efficiency #}
                        {% if 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif deescalation_level == 1 and final_escalation_level == 0 %}
                        {# Level 1: LOW de-escalation - Minor power reduction #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 0 %}
                        {# Escalation Level 0: Start gentle - Fan 1 #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif 'auto' in fans %}
                          auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Escalation Level 1: Small boost - Fan 2 #}
                        {% if '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Escalation Level 2: Moderate boost - Fan 3 #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Escalation Level 3: Strong boost - Fan 4 #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-2] if fans|length > 1 else fans[-1] }}
                        {% endif %}
                        {% else %}
                        {# Escalation Level 4: Emergency maximum - Fan 5 #}
                        {% set desired_max_fan = fan_speed_max %}
                        {% if '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'turbo' in fans %}
                          turbo
                          {% elif 'Turbo' in fans %}
                          Turbo
                          {% elif 'max' in fans %}
                          max
                          {% elif 'Max' in fans %}
                          Max
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” MEDIUM HEAT ADAPTIVE FAN: {{ repeat.item }}
                      â€¢ Escalation Level: {{ final_escalation_level }}/4
                      â€¢ Fan Selection: {{ selected_fan_mode }}
                      â€¢ Effectiveness: {{ current_effectiveness }}% after {{ time_in_current_mode | round(1) }}min
                      â€¢ Distance from Target: {{ distance_from_target | round(1) }}Â°C
                      â€¢ Escalation Reason: {% if final_escalation_level == 0 %}Working well - no escalation needed{% elif final_escalation_level == 1 %}Moderate effectiveness - escalate to Level 4{% elif final_escalation_level == 2 %}Poor effectiveness or distance - escalate to Level 5{% else %}Emergency - maximum escalation{% endif %}
                      â€¢ Available Fans: {{ available_fans | join(', ') }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          # Update helper entities on every activation (needed for rapid triggers to maintain state)
          # Update temperature history BEFORE updating mode (captures initial temp for effectiveness calculation)
          - if:
              - condition: template
                value_template: "{{ helper_temp_history not in [none, '', 'unavailable', 'unknown'] and states(helper_mode) | default('off') != 'heating_medium' }}"
            then:
              - service: input_number.set_value
                target:
                  entity_id: "{{ helper_temp_history }}"
                data:
                  value: "{{ current_temp }}"
          # Always update mode helper to ensure state persistence despite rapid retriggering
          # v3.9.13: Wait + set temperature
          - delay:
              milliseconds: 2000
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ adjusted_target }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "heating_medium"

          # v3.9.18 FIX: Update helper_last_change ONLY when mode changes (for runtime protection)
          - if:
              - condition: template
                value_template: "{{ states(helper_mode) | default('off') != 'heating_medium' }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_last_change
                data:
                  datetime: "{{ now() }}"

      # LOW HEATING: Smart hysteresis with direct helper reads
      - conditions:
          - condition: template
            value_template: >
              {% set current_mode = states(helper_mode) | default('off') %}
              {% if current_mode == 'heating_low' %}
                {# Already heating low - continue only if AC running AND temp needs adjustment #}
                {% if time_in_current_mode < runtime_min %}
                  True  {# RUNTIME PROTECTION: Stay on for minimum runtime regardless of conditions #}
                {% elif current_temp >= (target_temp + target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - heated to {{ (target_temp + target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% elif control_mode == 'Smart' and not smart_presence_active %}
                  False  {# EXIT: Smart mode requires presence to continue #}
                {% elif actual_ac_state == 'off' %}
                  False  {# EXIT: AC is already off - don't restart from continue logic #}
                {% else %}
                  {{ should_activate and enable_heating and current_temp < target_temp }}
                {% endif %}
              {% else %}
                {# Not heating low - start ONLY if in low range (escalation CANNOT start LOW from OFF) #}
                {% set time_protection_met = (last_mode in ['heating_low', 'heating_medium', 'heating_high'] and time_in_current_mode > runtime_min) or ((last_mode == 'off' or actual_ac_state == 'off') and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['heating_low', 'heating_medium', 'heating_high', 'off', 'smart_off']) %}
                {{ should_activate and enable_heating and current_temp <= heating_low_temp and current_temp > heating_medium_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
                {# Same heating tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from cooling/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set overshoot_turnoff = (target_temp + target_overshoot) | round(1) %}
                {% set temp_gap = (overshoot_turnoff - current_temp) | round(1) %}
                {% set temp_gap_adjusted = (adjusted_target - current_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 65 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}
                {% set esc_display = 'L' ~ escalation if escalation > 0 else ('DE-L' ~ deescalation if deescalation > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: +' ~ target_overshoot ~ 'Â°C | AC Setpoint: ' ~ adjusted_target ~ 'Â°C' if adjusted_target != target_temp else 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: +' ~ target_overshoot ~ 'Â°C' %}

                {% if current_mode == 'heating_low' %}
                  {% if temp_gap <= 0.3 %}
                    ğŸ¯ {{ room_name | upper }} LOW HEATING - PRECISION FINISH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C fine-tuning to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 80 %}| ğŸ¯ PRECISE CONTROL{% elif effectiveness >= 60 %}| âš™ï¸ GOOD EFFICIENCY ({{ effectiveness }}%){% else %}| ğŸ”§ FINE-TUNING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 1.5 %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - GENTLE APPROACH
                    ğŸ“Š CONTINUE MODE: Gradually warming {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - PATIENT MODE
                    ğŸ“Š CONTINUE MODE: Steady warming {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat)
                    ğŸŒ¡ï¸ Gentle power until comfort | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 3.0 %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - CAUTIOUS START
                    ğŸš€ START MODE: Moderate cold {{ current_temp }}Â°C â‰¤ {{ heating_low_temp }}Â°C ({{ temp_gap_adjusted }}Â°C deficit)
                    ğŸŒ¡ï¸ Gentle heating approach | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 1.0 %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - COMFORT ADJUSTMENT
                    ğŸš€ START MODE: Slight cold {{ current_temp }}Â°C â‰¤ {{ heating_low_temp }}Â°C threshold
                    âš™ï¸ Gentle warming â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - MICRO-ADJUST
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¤ {{ heating_low_temp }}Â°C
                    ğŸ¯ Minimal warming to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: "heat"
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: "heat"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ adjusted_target }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan BEFORE temperature
          # Progressive fan speed for LOW heating based on escalation level
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"

                    # LOW heating adaptive fan selection with de-escalation support
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {# Escalation always takes priority over de-escalation when system is stalled #}
                      {% if deescalation_level == 3 and final_escalation_level == 0 %}
                        {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 2 %}
                        {# Level 2: HIGH de-escalation - Reduce to quiet/low power #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 1 %}
                        {# Level 1: LOW de-escalation - Minimal reduction #}
                        {% if 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 0 %}
                        {# Escalation Level 0: Start gentle - Fan 1 #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif 'auto' in fans %}
                          auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Escalation Level 1: Small boost - Fan 2 #}
                        {% if '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Escalation Level 2: Moderate boost - Fan 3 #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Escalation Level 3: Strong boost - Fan 4 #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-2] if fans|length > 1 else fans[-1] }}
                        {% endif %}
                        {% else %}
                        {# Escalation Level 4: Emergency maximum - Fan 5 #}
                        {% if '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” LOW HEAT ADAPTIVE FAN: {{ repeat.item }}
                      â€¢ Escalation Level: {{ final_escalation_level }}/4
                      â€¢ Fan Selection: {{ selected_fan_mode }}
                      â€¢ Effectiveness: {{ current_effectiveness }}% after {{ time_in_current_mode | round(1) }}min
                      â€¢ Distance from Target: {{ distance_from_target | round(1) }}Â°C
                      â€¢ Escalation Reason: {% if final_escalation_level == 0 %}Working well - no escalation needed{% elif final_escalation_level == 1 %}Moderate effectiveness - minor escalation{% elif final_escalation_level == 2 %}Poor effectiveness or distance - moderate escalation{% elif final_escalation_level == 3 %}Stalled progress - high escalation{% elif final_escalation_level == 4 %}Emergency - maximum escalation{% else %}Unknown level{% endif %}
                      â€¢ Available Fans: {{ available_fans | join(', ') }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          # Update helper entities on every activation (needed for rapid triggers to maintain state)
          # Update temperature history BEFORE updating mode (captures initial temp for effectiveness calculation)
          - if:
              - condition: template
                value_template: "{{ helper_temp_history not in [none, '', 'unavailable', 'unknown'] and states(helper_mode) | default('off') != 'heating_low' }}"
            then:
              - service: input_number.set_value
                target:
                  entity_id: "{{ helper_temp_history }}"
                data:
                  value: "{{ current_temp }}"
          # Always update mode helper to ensure state persistence despite rapid retriggering
          # v3.9.13: Wait + set temperature
          - delay:
              milliseconds: 2000
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ adjusted_target }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "heating_low"

          # v3.9.18 FIX: Update helper_last_change ONLY when mode changes (for runtime protection)
          - if:
              - condition: template
                value_template: "{{ states(helper_mode) | default('off') != 'heating_low' }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_last_change
                data:
                  datetime: "{{ now() }}"

      # HIGH COOLING: Smart hysteresis with direct helper reads
      - conditions:
          - condition: template
            value_template: >
              {% set current_mode = states(helper_mode) | default('off') %}
              {% if current_mode == 'cooling_high' %}
                {# Continue HIGH only if AC is actually running AND temp needs adjustment #}
                {% if time_in_current_mode < runtime_min %}
                  True  {# RUNTIME PROTECTION: Stay on for minimum runtime regardless of conditions #}
                {% elif current_temp <= (target_temp - target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - cooled to {{ (target_temp - target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% elif control_mode == 'Smart' and not smart_presence_active %}
                  False  {# EXIT: Smart mode requires presence to continue #}
                {% elif actual_ac_state == 'off' %}
                  False  {# EXIT: AC is already off - don't restart from continue logic #}
                {% elif current_temp < cooling_high_temp and (current_temp - target_temp) > 1.0 %}
                  False  {# EXIT: Temp dropped below HIGH threshold and still >1Â°C from target - let MEDIUM tier take over #}
                {% else %}
                  {{ should_activate and enable_cooling and current_temp > target_temp }}
                {% endif %}
              {% else %}
                {# Not cooling high - start ONLY if threshold exceeded (escalation CANNOT start HIGH from OFF) #}
                {{ should_activate and enable_cooling and current_temp >= cooling_high_temp and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                {# Same cooling tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from heating/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set overshoot_turnoff = (target_temp - target_overshoot) | round(1) %}
                {% set distance = (current_temp - overshoot_turnoff) | round(1) %}
                {% set distance_adjusted = (current_temp - adjusted_target) | round(1) %}
                {% set abs_rate = (temp_change_rate | abs) %}
                {% set eta_minutes = (distance / abs_rate) | round(0) if abs_rate > 0.001 else 999 %}
                {% set esc_display = 'L' ~ escalation_level if final_escalation_level > 0 else ('DE-L' ~ deescalation_level if deescalation_level > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: -' ~ target_overshoot ~ 'Â°C | AC Setpoint: ' ~ adjusted_target ~ 'Â°C' if adjusted_target != target_temp else 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: -' ~ target_overshoot ~ 'Â°C' %}

                {% if current_mode == 'cooling_high' %}
                  {% if distance <= 0.5 %}
                â„ï¸ {{ room_name | upper }} HIGH COOLING - FINAL APPROACH ğŸ¯
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C remaining){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if deescalation_level > 0 %} (DE-ESCALATED L{{ deescalation_level }} - {{ current_effectiveness }}% effective){% endif %}
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min{% if eta_minutes < 999 %} - arriving in ~{{ eta_minutes }} min{% endif %}
                  {% elif current_effectiveness < 40 and final_escalation_level > 0 %}
                â„ï¸ {{ room_name | upper }} HIGH COOLING - STRUGGLING âš ï¸
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (ESCALATING L{{ final_escalation_level }} - only {{ current_effectiveness }}% effective)
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min{% if eta_minutes < 999 and eta_minutes > 20 %} - may need {{ eta_minutes }}+ minutes{% endif %}
                  {% elif final_escalation_level == 4 %}
                â„ï¸ {{ room_name | upper }} HIGH COOLING - EMERGENCY MODE ğŸ†˜
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (MAXIMUM ESCALATION - {{ current_effectiveness }}% effective)
                âš ï¸ System at maximum capacity - consider manual intervention
                  {% elif current_effectiveness >= 80 %}
                â„ï¸ {{ room_name | upper }} HIGH COOLING - CRUISING âœ…
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (STABLE - {{ current_effectiveness }}% effective)
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min{% if eta_minutes < 999 %} - arriving in ~{{ eta_minutes }} min{% endif %}
                  {% else %}
                â„ï¸ {{ room_name | upper }} HIGH COOLING - ACTIVE
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if final_escalation_level > 0 %} (ESCALATING L{{ final_escalation_level }}){% elif deescalation_level > 0 %} (DE-ESCALATING L{{ deescalation_level }}){% endif %} - {{ current_effectiveness }}% effective
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min{% if eta_minutes < 999 %} - ETA ~{{ eta_minutes }} min{% endif %}
                  {% endif %}
                {% else %}
                â„ï¸ {{ room_name | upper }} HIGH COOLING - INITIATED ğŸš€
                ğŸ“Š {{ current_temp }}Â°C exceeds {{ cooling_high_temp }}Â°C threshold
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (FULL POWER)
                ğŸ¯ Target: {{ adjusted_target }}Â°C ({{ distance_adjusted }}Â°C to cool){% if target_info %}
                {{ target_info }}{% endif %}
                {% endif %}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: "cool"
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: "cool"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ adjusted_target }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan BEFORE temperature
          # HIGH cooling always uses maximum fan speed (no escalation beyond this tier)
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"

                    # HIGH cooling adaptive fan selection with de-escalation support
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {# Escalation always takes priority over de-escalation when system is stalled #}
                      {% if deescalation_level == 3 and final_escalation_level == 0 %}
                        {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 2 and final_escalation_level == 0 %}
                        {# Level 2: HIGH de-escalation - Reduce to medium power #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif deescalation_level == 1 and final_escalation_level == 0 %}
                        {# Level 1: LOW de-escalation - Reduce to high-medium power #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[3] if fans|length > 3 else (fans[2] if fans|length > 2 else fans[-1]) }}
                        {% endif %}
                        {% elif final_escalation_level == 0 %}
                        {# Escalation Level 0: Start gentle - Fan 1 #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif 'auto' in fans %}
                          auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Escalation Level 1: Small boost - Fan 2 #}
                        {% if '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Escalation Level 2: Moderate boost - Fan 3 #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Escalation Level 3: Strong boost - Fan 4 #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-2] if fans|length > 1 else fans[-1] }}
                        {% endif %}
                        {% else %}
                        {# Escalation Level 4: Emergency maximum - Fan 5 #}
                        {% set desired_max_fan = fan_speed_max %}
                        {% if '5' in fans %}
                          5
                        {% elif 'Level 5' in fans %}
                        Level 5
                        {% elif '4' in fans %}
                        4
                        {% elif 'Level 4' in fans %}
                        Level 4
                        {% elif 'turbo' in fans %}
                        turbo
                        {% elif 'Turbo' in fans %}
                        Turbo
                        {% elif 'max' in fans %}
                        max
                        {% elif 'Max' in fans %}
                        Max
                        {% elif 'high' in fans %}
                        high
                        {% elif 'High' in fans %}
                        High
                        {% elif 'Auto' in fans %}
                        Auto
                        {% elif 'auto' in fans %}
                        auto
                        {% else %}
                        {{ fans[-1] if fans else 'Auto' }}
                      {% endif %}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” HIGH COOL ADAPTIVE FAN: {{ repeat.item }}
                      {% if deescalation_level > 0 %}
                      â€¢ De-escalation Level: {{ deescalation_level }}/3 (reducing power)
                        {% else %}
                      â€¢ Escalation Level: {{ final_escalation_level }}/4
                      {% endif %}
                      â€¢ Selected Fan: {{ selected_fan_mode }}
                      â€¢ Current Fan: {{ state_attr(repeat.item, 'fan_mode') | default('Unknown') }}
                      â€¢ Available Fans: {{ available_fans | join(', ') }}
                      â€¢ Effectiveness: {{ current_effectiveness }}% after {{ time_in_current_mode | round(1) }}min
                      â€¢ Distance from Target: {{ distance_from_target | round(1) }}Â°C
                      {% if deescalation_level > 0 %}
                      â€¢ Reason: {{ 'Excellent performance - switching to eco mode' if deescalation_level == 3 else 'Good performance - reducing to medium power' if deescalation_level == 2 else 'Approaching target - minor reduction' }}
                      {% endif %}
                      â€¢ Escalation Reason: {% if final_escalation_level == 0 %}Working well - no escalation needed{% elif final_escalation_level == 1 %}Moderate effectiveness - escalate to Fan 2{% elif final_escalation_level == 2 %}Poor effectiveness or distance - escalate to Fan 3{% elif final_escalation_level == 3 %}Strong escalation to Fan 4{% else %}Emergency - maximum escalation to Fan 5{% endif %}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          # Update helper entities on every activation (needed for rapid triggers to maintain state)
          # Update temperature history BEFORE updating mode (captures initial temp for effectiveness calculation)
          - if:
              - condition: template
                value_template: "{{ helper_temp_history not in [none, '', 'unavailable', 'unknown'] and states(helper_mode) | default('off') != 'cooling_high' }}"
            then:
              - service: input_number.set_value
                target:
                  entity_id: "{{ helper_temp_history }}"
                data:
                  value: "{{ current_temp }}"
          # Always update mode helper to ensure state persistence despite rapid retriggering
          # v3.9.13: Wait + set temperature
          - delay:
              milliseconds: 2000
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ adjusted_target }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling_high"

          # v3.9.18 FIX: Update helper_last_change ONLY when mode changes (for runtime protection)
          - if:
              - condition: template
                value_template: "{{ states(helper_mode) | default('off') != 'cooling_high' }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_last_change
                data:
                  datetime: "{{ now() }}"

      # MEDIUM COOLING: Smart hysteresis with direct helper reads
      - conditions:
          - condition: template
            value_template: >
              {% set current_mode = states(helper_mode) | default('off') %}
              {% if current_mode == 'cooling_medium' %}
                {# Already cooling medium - continue only if AC running AND temp needs adjustment #}
                {% if time_in_current_mode < runtime_min %}
                  True  {# RUNTIME PROTECTION: Stay on for minimum runtime regardless of conditions #}
                {% elif current_temp <= (target_temp - target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - cooled to {{ (target_temp - target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% elif control_mode == 'Smart' and not smart_presence_active %}
                  False  {# EXIT: Smart mode requires presence to continue #}
                {% elif actual_ac_state == 'off' %}
                  False  {# EXIT: AC is already off - don't restart from continue logic #}
                {% elif current_temp < cooling_medium_temp and (current_temp - target_temp) > 1.0 %}
                  False  {# EXIT: Temp dropped below MEDIUM threshold and still >1Â°C from target - let LOW tier take over #}
                {% else %}
                  {{ should_activate and enable_cooling and current_temp > target_temp }}
                {% endif %}
              {% else %}
                {# Not cooling medium - start ONLY if in medium range (escalation CANNOT start MEDIUM from OFF) #}
                {% set time_protection_met = (last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] and time_in_current_mode > runtime_min) or ((last_mode == 'off' or actual_ac_state == 'off') and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['cooling_low', 'cooling_medium', 'cooling_high', 'off', 'smart_off']) %}
                {{ should_activate and enable_cooling and current_temp >= cooling_medium_temp and current_temp < cooling_high_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                {# Same cooling tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from heating/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set overshoot_turnoff = (target_temp - target_overshoot) | round(1) %}
                {% set distance = (current_temp - overshoot_turnoff) | round(1) %}
                {% set distance_adjusted = (current_temp - adjusted_target) | round(1) %}
                {% set abs_rate = (temp_change_rate | abs) %}
                {% set eta_minutes = (distance / abs_rate) | round(0) if abs_rate > 0.001 else 999 %}
                {% set esc_display = 'L' ~ escalation_level if final_escalation_level > 0 else ('DE-L' ~ deescalation_level if deescalation_level > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: -' ~ target_overshoot ~ 'Â°C | AC Setpoint: ' ~ adjusted_target ~ 'Â°C' if adjusted_target != target_temp else 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: -' ~ target_overshoot ~ 'Â°C' %}

                {% if current_mode == 'cooling_medium' %}
                  {% if distance <= 0.3 %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - TARGET ACHIEVED ğŸ
                ğŸ“Š {{ current_temp }}Â°C â‰ˆ {{ adjusted_target }}Â°C (within {{ distance_adjusted }}Â°C){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if deescalation_level == 3 %} (ECO MODE - minimal power){% endif %}
                âœ… Success! Temperature stabilized
                  {% elif deescalation_level == 3 %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - ECO MODE ğŸƒ
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (MAXIMUM DE-ESCALATION - {{ current_effectiveness }}% effective)
                ğŸ“ˆ Ultra-efficient mode - saving energy while maintaining comfort
                  {% elif current_effectiveness >= 85 and deescalation_level > 0 %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - OPTIMAL EFFICIENCY ğŸ’š
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (DE-ESCALATED L{{ deescalation_level }} - {{ current_effectiveness }}% effective)
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min - Perfect balance of power & efficiency
                  {% elif final_escalation_level >= 2 %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - BOOSTED âš¡
                ğŸ“Š Current: {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go)
                {{ target_info }}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (ESCALATION L{{ final_escalation_level }} - {{ current_effectiveness }}% effective)
                âš ï¸ Increased fan power for faster cooling
                  {% elif current_effectiveness < 50 %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - UNDERPERFORMING âš ï¸
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if final_escalation_level > 0 %} (ESCALATING L{{ final_escalation_level }}){% endif %} - Only {{ current_effectiveness }}% effective
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min - System struggling{% if eta_minutes > 15 %}, may take {{ eta_minutes }}+ min{% endif %}
                  {% else %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - STEADY PROGRESS ğŸ“Š
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} - {{ current_effectiveness }}% effective
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min{% if eta_minutes < 999 %} - ETA ~{{ eta_minutes }} min{% endif %}
                  {% endif %}
                {% else %}
                ğŸŒŠ {{ room_name | upper }} MEDIUM COOLING - ENGAGED ğŸ¯
                ğŸ“Š {{ current_temp }}Â°C in medium range ({{ cooling_medium_temp }}-{{ cooling_high_temp }}Â°C)
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (MEDIUM INTENSITY)
                ğŸ¯ Target: {{ adjusted_target }}Â°C ({{ distance_adjusted }}Â°C to cool){% if target_info %}
                {{ target_info }}{% endif %}
                {% endif %}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: "cool"
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: "cool"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ adjusted_target }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan BEFORE temperature
          # Progressive fan speed for MEDIUM cooling based on escalation level
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"

                    # MEDIUM cooling adaptive fan selection with de-escalation support
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {# Escalation always takes priority over de-escalation when system is stalled #}
                      {% if deescalation_level == 3 and final_escalation_level == 0 %}
                        {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 2 and final_escalation_level == 0 %}
                        {# Level 2: HIGH de-escalation - Let AC auto-adjust for optimal efficiency #}
                        {% if 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif deescalation_level == 1 and final_escalation_level == 0 %}
                        {# Level 1: LOW de-escalation - Minor power reduction #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 0 %}
                        {# Escalation Level 0: Start gentle - Fan 1 #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'Auto' in fans %}
                          Auto
                          {% elif 'auto' in fans %}
                          auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Escalation Level 1: Small boost - Fan 2 #}
                        {% if '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Escalation Level 2: Moderate boost - Fan 3 #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else (fans[1] if fans|length > 1 else fans[0]) }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Escalation Level 3: Strong boost - Fan 4 #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-2] if fans|length > 1 else fans[-1] }}
                        {% endif %}
                        {% else %}
                        {# Escalation Level 4: Emergency maximum - Fan 5 #}
                        {% set desired_max_fan = fan_speed_max %}
                        {% if '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'turbo' in fans %}
                          turbo
                          {% elif 'Turbo' in fans %}
                          Turbo
                          {% elif 'max' in fans %}
                          max
                          {% elif 'Max' in fans %}
                          Max
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” MEDIUM COOL ADAPTIVE FAN: {{ repeat.item }}
                      {% if deescalation_level > 0 %}
                      â€¢ De-escalation Level: {{ deescalation_level }}/3 (reducing power)
                        {% else %}
                      â€¢ Escalation Level: {{ final_escalation_level }}/4
                      {% endif %}
                      â€¢ Selected Fan: {{ selected_fan_mode }}
                      â€¢ Current Fan: {{ state_attr(repeat.item, 'fan_mode') | default('Unknown') }}
                      â€¢ Available Fans: {{ available_fans | join(', ') }}
                      â€¢ Effectiveness: {{ current_effectiveness }}% after {{ time_in_current_mode | round(1) }}min
                      â€¢ Distance from Target: {{ distance_from_target | round(1) }}Â°C
                      {% if deescalation_level > 0 %}
                      â€¢ Reason: {{ 'Excellent performance - switching to eco mode' if deescalation_level == 3 else 'Good performance - reducing to low power' if deescalation_level == 2 else 'Approaching target - minor reduction' }}
                      {% endif %}
                      â€¢ Escalation Reason: {% if final_escalation_level == 0 %}Working well - no escalation needed{% elif final_escalation_level == 1 %}Moderate effectiveness - escalate to Fan 2{% elif final_escalation_level == 2 %}Poor effectiveness or distance - escalate to Fan 3{% elif final_escalation_level == 3 %}Strong escalation to Fan 4{% else %}Emergency - maximum escalation to Fan 5{% endif %}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # v3.9.13: Wait + set temperature
          - delay:
              milliseconds: 2000
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ adjusted_target }}"

          # Update helper entities on every activation (needed for rapid triggers to maintain state)
          # Update temperature history BEFORE updating mode (captures initial temp for effectiveness calculation)
          - if:
              - condition: template
                value_template: "{{ helper_temp_history not in [none, '', 'unavailable', 'unknown'] and states(helper_mode) | default('off') != 'cooling_medium' }}"
            then:
              - service: input_number.set_value
                target:
                  entity_id: "{{ helper_temp_history }}"
                data:
                  value: "{{ current_temp }}"
          # Always update mode helper to ensure state persistence despite rapid retriggering
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling_medium"

          # v3.9.18 FIX: Update helper_last_change ONLY when mode changes (for runtime protection)
          # This prevents false manual override detection while maintaining runtime protection
          - if:
              - condition: template
                value_template: "{{ states(helper_mode) | default('off') != 'cooling_medium' }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_last_change
                data:
                  datetime: "{{ now() }}"

      # LOW COOLING: Smart hysteresis with direct helper reads
      - conditions:
          - condition: template
            value_template: >
              {% set current_mode = states(helper_mode) | default('off') %}
              {% if current_mode == 'cooling_low' %}
                {# Already cooling low - continue only if AC running AND temp needs adjustment #}
                {% if time_in_current_mode < runtime_min %}
                  True  {# RUNTIME PROTECTION: Stay on for minimum runtime regardless of conditions #}
                {% elif current_temp <= (target_temp - target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - cooled to {{ (target_temp - target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% elif control_mode == 'Smart' and not smart_presence_active %}
                  False  {# EXIT: Smart mode requires presence to continue #}
                {% elif actual_ac_state == 'off' %}
                  False  {# EXIT: AC is already off - don't restart from continue logic #}
                {% else %}
                  {{ should_activate and enable_cooling and current_temp > target_temp }}
                {% endif %}
              {% else %}
                {# Not cooling low - start ONLY if in low range (escalation CANNOT start LOW from OFF) #}
                {% set time_protection_met = (last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] and time_in_current_mode > runtime_min) or ((last_mode == 'off' or actual_ac_state == 'off') and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['cooling_low', 'cooling_medium', 'cooling_high', 'off', 'smart_off']) %}
                {{ should_activate and enable_cooling and current_temp >= cooling_low_temp and current_temp < cooling_medium_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set overshoot_turnoff = (target_temp - target_overshoot) | round(1) %}
                {% set distance = (current_temp - overshoot_turnoff) | round(1) %}
                {% set distance_adjusted = (current_temp - adjusted_target) | round(1) %}
                {% set abs_rate = (temp_change_rate | abs) %}
                {% set eta_minutes = (distance / abs_rate) | round(0) if abs_rate > 0.001 else 999 %}
                {% set esc_display = 'L' ~ escalation_level if final_escalation_level > 0 else ('DE-L' ~ deescalation_level if deescalation_level > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: -' ~ target_overshoot ~ 'Â°C | AC Setpoint: ' ~ adjusted_target ~ 'Â°C' if adjusted_target != target_temp else 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: -' ~ target_overshoot ~ 'Â°C' %}

                {% if current_mode == 'cooling_low' %}
                  {% if distance <= 0.2 %}
                ğŸŒ¬ï¸ {{ room_name | upper }} LOW COOLING - PRECISION MODE ğŸ¯
                ğŸ“Š {{ current_temp }}Â°C â‰ˆ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C away){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (GENTLE)
                âœ¨ Maintaining perfect comfort with minimal energy
                  {% elif current_effectiveness >= 90 %}
                ğŸŒ¬ï¸ {{ room_name | upper }} LOW COOLING - PERFECT EFFICIENCY ğŸ’
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} - {{ current_effectiveness }}% effective
                ğŸŒ¿ Ideal conditions - minimal power, maximum comfort
                  {% elif final_escalation_level > 0 %}
                ğŸŒ¬ï¸ {{ room_name | upper }} LOW COOLING - ASSISTED ğŸ“ˆ
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (ESCALATED L{{ final_escalation_level }} for minor boost)
                ğŸ“Š Temporarily increased for quicker response
                  {% elif distance < 1.0 %}
                ğŸŒ¬ï¸ {{ room_name | upper }} LOW COOLING - FINE TUNING ğŸšï¸
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C (just {{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} - {{ current_effectiveness }}% effective
                ğŸ“ˆ Nearly there{% if eta_minutes < 5 %} - ~{{ eta_minutes }} min remaining{% endif %}
                  {% else %}
                ğŸŒ¬ï¸ {{ room_name | upper }} LOW COOLING - GENTLE PROGRESS ğŸƒ
                ğŸ“Š {{ current_temp }}Â°C â†’ {{ overshoot_turnoff }}Â°C ({{ distance }}Â°C to go){% if target_info %}
                {{ target_info }}{% endif %}
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} - {{ current_effectiveness }}% effective
                ğŸ“ˆ Trend: {{ temp_change_rate }}Â°C/min{% if eta_minutes < 999 %} - ETA ~{{ eta_minutes }} min{% endif %}
                  {% endif %}
                {% else %}
                ğŸŒ¬ï¸ {{ room_name | upper }} LOW COOLING - INITIALIZED ğŸŒ±
                ğŸ“Š {{ current_temp }}Â°C slightly above comfort (â‰¥{{ cooling_low_temp }}Â°C)
                âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} (GENTLE START)
                ğŸ¯ Target: {{ adjusted_target }}Â°C ({{ distance_adjusted }}Â°C to cool){% if target_info %}
                {{ target_info }}{% endif %}
                {% endif %}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: "cool"
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: "cool"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ adjusted_target }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan mode BEFORE turning on AC
          # Progressive fan speed for LOW cooling based on escalation level
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"

                    # LOW cooling adaptive fan selection with full 5-speed escalation
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {# De-escalation takes priority when no stall detected #}
                      {% if deescalation_level == 3 and final_escalation_level == 0 %}
                        {# Level 3: MAXIMUM de-escalation - Switch to eco/maintenance mode #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif 'silence' in fans %}
                          silence
                          {% elif 'Silence' in fans %}
                          Silence
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 2 %}
                        {# Level 2: HIGH de-escalation - Reduce to quiet/low power #}
                        {% if 'quiet' in fans %}
                          quiet
                          {% elif 'Quiet' in fans %}
                          Quiet
                          {% elif '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif deescalation_level == 1 %}
                        {# Level 1: LOW de-escalation - Minimal reduction #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 0 %}
                        {# Escalation Level 0: Start gentle - Fan 1 #}
                        {% if '1' in fans %}
                          1
                          {% elif 'Level 1' in fans %}
                          Level 1
                          {% elif 'low' in fans %}
                          low
                          {% elif 'Low' in fans %}
                          Low
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Escalation Level 1: Small boost - Fan 2 #}
                        {% if '2' in fans %}
                          2
                          {% elif 'Level 2' in fans %}
                          Level 2
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '3' in fans %}
                          3
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[1] if fans|length > 1 else fans[0] }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Escalation Level 2: Moderate boost - Fan 3 #}
                        {% if '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif '4' in fans %}
                          4
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[2] if fans|length > 2 else fans[-1] }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Escalation Level 3: Strong boost - Fan 4 #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif '3' in fans %}
                          3
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[3] if fans|length > 3 else fans[-1] }}
                        {% endif %}
                        {% else %}
                        {# Escalation Level 4: Emergency maximum - Fan 5 #}
                        {% if '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif '4' in fans %}
                          4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” LOW COOL ADAPTIVE FAN: {{ repeat.item }}
                      â€¢ Escalation Level: {{ final_escalation_level }}/4
                      â€¢ Fan Selection: {{ selected_fan_mode }}
                      â€¢ Effectiveness: {{ current_effectiveness }}% after {{ time_in_current_mode | round(1) }}min
                      â€¢ Distance from Target: {{ distance_from_target | round(1) }}Â°C
                      â€¢ Escalation Reason: {% if final_escalation_level == 0 %}Working well - no escalation needed{% elif final_escalation_level == 1 %}Moderate effectiveness - minor escalation{% elif final_escalation_level == 2 %}Poor effectiveness or distance - moderate escalation{% elif final_escalation_level == 3 %}Stalled progress - high escalation{% elif final_escalation_level == 4 %}Emergency - maximum escalation{% else %}Unknown level{% endif %}
                      â€¢ Available Fans: {{ available_fans | join(', ') }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # v3.9.13: Wait for fan commands
          - delay:
              milliseconds: 2000

          # v3.9.13: Set temperature with correct fan
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ adjusted_target }}"

          # Update helper entities on every activation (needed for rapid triggers to maintain state)
          # Update temperature history BEFORE updating mode (captures initial temp for effectiveness calculation)
          - if:
              - condition: template
                value_template: "{{ helper_temp_history not in [none, '', 'unavailable', 'unknown'] and states(helper_mode) | default('off') != 'cooling_low' }}"
            then:
              - service: input_number.set_value
                target:
                  entity_id: "{{ helper_temp_history }}"
                data:
                  value: "{{ current_temp }}"
          # Always update mode helper to ensure state persistence despite rapid retriggering
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling_low"

          # v3.9.18 FIX: Update helper_last_change ONLY when mode changes (for runtime protection)
          - if:
              - condition: template
                value_template: "{{ states(helper_mode) | default('off') != 'cooling_low' }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_last_change
                data:
                  datetime: "{{ now() }}"

      # PRIORITY: Check for high temperature first when AC is off
      - conditions:
          - condition: template
            value_template: "{{ current_temp >= cooling_high_temp and should_activate and actual_ac_state == 'off' and (control_mode != 'Smart' or smart_presence_active) }}"
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (current_temp - target_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 85 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}

                {% if current_mode == 'cooling_high' %}
                  {% if temp_gap <= 0.5 %}
                    ğŸ¯ {{ room_name | upper }} HIGH COOLING - FINAL APPROACH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C almost at {{ adjusted_target }}Â°C target ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 90 %}| â„ï¸ MAXIMUM INTENSITY{% elif effectiveness >= 70 %}| âš¡ HIGH EFFECTIVENESS ({{ effectiveness }}%){% else %}| ğŸ”§ STRUGGLING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 2.0 %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - CRUISING TO TARGET
                    ğŸ“Š CONTINUE MODE: Cooling {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - EMERGENCY MODE
                    ğŸ“Š CONTINUE MODE: Large gap {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C excess!)
                    âš¡ Full power until comfortable | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 5.0 %}
                    ğŸš¨ {{ room_name | upper }} HIGH COOLING - EMERGENCY START
                    ğŸš€ START MODE: EXTREME heat {{ current_temp }}Â°C â‰¥ {{ cooling_high_temp }}Â°C ({{ distance_adjusted }}Â°C excess!)
                    â„ï¸ Maximum cooling power engaged | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 2.0 %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - RAPID COOL-DOWN
                    ğŸš€ START MODE: Hot {{ current_temp }}Â°C â‰¥ {{ cooling_high_temp }}Â°C threshold
                    âš¡ High-power cooling â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to cool)
                  {% else %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - PRECISION MODE
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¥ {{ cooling_high_temp }}Â°C
                    ğŸ¯ Gentle approach to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "cool"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: >
                      {% if 'cool' in available_modes %}
                        cool
                        {% elif 'Cool' in available_modes %}
                        Cool
                        {% elif 'auto' in available_modes %}
                        auto
                        {% elif 'Auto' in available_modes %}
                        Auto
                        {% elif 'heat_cool' in available_modes %}
                        heat_cool
                        {% elif 'Heat/Cool' in available_modes %}
                        Heat/Cool
                        {% else %}
                        {{ available_modes[0] if available_modes else 'off' }}
                      {% endif %}

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ cooling_target_temp }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan BEFORE temperature
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    desired_max_fan: "{{ fan_speed_max }}"
                    
                    # Smart fan mode selection - finds the best match for "maximum" speed
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {% set desired = fan_speed_max %}
                      
                      {# First try the exact user selection #}
                      {% if desired in fans %}
                        {{ desired }}
                      {# Then try maximum speed equivalents in order of preference #}
                        {% elif 'high' in fans %}
                        high
                        {% elif 'High' in fans %}
                        High
                        {% elif '5' in fans %}
                        5
                        {% elif 'Level 5' in fans %}
                        Level 5
                        {% elif 'turbo' in fans %}
                        turbo
                        {% elif 'Turbo' in fans %}
                        Turbo
                        {% elif 'max' in fans %}
                        max
                        {% elif 'Max' in fans %}
                        Max
                      {# Fallback to highest available numeric #}
                        {% elif '4' in fans %}
                        4
                        {% elif 'Level 4' in fans %}
                        Level 4
                        {% elif '3' in fans %}
                        3
                        {% elif 'Level 3' in fans %}
                        Level 3
                      {# Last resort - Auto or highest available #}
                        {% elif 'Auto' in fans %}
                        Auto
                        {% elif 'auto' in fans %}
                        auto
                        {% else %}
                        {{ fans[-1] if fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
                
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” {{ room_name | upper }} SMART FAN: {{ repeat.item }}
                      â€¢ Desired: {{ desired_max_fan }}
                      â€¢ Available: {{ available_fans | join(', ') }}
                      â€¢ Selected: {{ selected_fan_mode }}
                      â€¢ Reason: {{ 'Exact match' if desired_max_fan in available_fans else 'Best equivalent for maximum cooling' }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # v3.9.13: Wait + set temperature
          - delay:
              milliseconds: 2000
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ cooling_target_temp }}"
            continue_on_error: true

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling"

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true

      # CRITICAL: Clear stability mode when temperature exits comfort zone
      # This MUST be the FIRST condition to prevent getting stuck
      - conditions:
          - condition: template
            value_template: "{{ last_mode in ['stability_off', 'stability_eco'] }}"
          - condition: template
            value_template: "{{ current_temp < comfort_min_temp or current_temp > comfort_max_temp }}"
        sequence:
          # Always log this critical reset
          - service: system_log.write
            data:
              message: >
                ğŸ”„ Stability Mode Reset: Temperature outside comfort zone!
                â€¢ Current: {{ current_temp }}Â°C
                â€¢ Comfort Zone: {{ comfort_min_temp }}-{{ comfort_max_temp }}Â°C
                â€¢ Was in mode: {{ last_mode }}
                â€¢ Clearing stability mode to allow normal operation
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Don't set to "off" - set directly to cooling/heating (but respect Smart mode presence)
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: >
                {% if control_mode == 'Smart' and not smart_presence_active %}
                  off
                {% elif current_temp >= cooling_medium_temp %}
                  cooling
                {% elif current_temp <= heating_medium_temp %}
                  heating
                {% else %}
                  off
                {% endif %}

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and last_mode not in ['cooling', 'heating', 'off'] }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          # Clear the stability timestamp to reset the feature
          # Don't use 1970 as it causes calculation issues - use current time instead
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ helper_temp_stable_since not in [none, '', 'unavailable', 'unknown'] }}"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ helper_temp_stable_since }}"
                    data:
                      datetime: "{{ now() }}"
          
          # Now activate cooling/heating as needed since we're outside comfort zone or at trigger point
          - choose:
              # Need cooling
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp >= cooling_medium_temp and (control_mode != 'Smart' or smart_presence_active) }}"
                sequence:
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                            
                            # Smart cooling mode selection
                            selected_hvac_mode: >
                              {% set modes = state_attr(repeat.item, 'hvac_modes') | list %}
                              {# For cooling, try cooling-capable modes #}
                              {% if 'cool' in modes %}
                                cool
                                {% elif 'Cool' in modes %}
                                Cool
                                {% elif 'auto' in modes %}
                                auto
                                {% elif 'Auto' in modes %}
                                Auto
                                {% elif 'heat_cool' in modes %}
                                heat_cool
                                {% elif 'Heat/Cool' in modes %}
                                Heat/Cool
                                {% else %}
                                {{ modes[0] if modes else 'off' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_hvac }}"
                          data:
                            value: "cool"
                          continue_on_error: true

                        - service: climate.set_hvac_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            hvac_mode: >
                              {% set available = state_attr(current_entity, 'hvac_modes') | list %}
                              {{ selected_hvac_mode if selected_hvac_mode in available else (available[0] if available else 'off') }}

                        - condition: template
                          value_template: "{{ debug_enabled }}"
                        - service: system_log.write
                          data:
                            message: >
                              ğŸ” SMART COOL MODE: {{ repeat.item }}
                              â€¢ Available: {{ available_modes | join(', ') }}
                              â€¢ Selected: {{ selected_hvac_mode }}
                              â€¢ Reason: Best cooling mode for this AC unit
                            level: debug
                            logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: "{{ cooling_target_temp }}"
                    continue_on_error: true

                  # v3.9.13 FIX: Set fan BEFORE temperature
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                            desired_max_fan: !input fan_speed_max
                            selected_fan_mode: >
                              {% if desired_max_fan in available_fans %}
                                {{ desired_max_fan }}
                                {% elif '5' in available_fans %}
                                5
                                {% elif 'Level 5' in available_fans %}
                                Level 5
                                {% elif 'high' in available_fans %}
                                high
                                {% elif 'Auto' in available_fans %}
                                Auto
                                {% elif 'auto' in available_fans %}
                                auto
                                {% else %}
                                {{ available_fans[-1] if available_fans else 'Auto' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_fan }}"
                          data:
                            value: "{{ selected_fan_mode }}"
                          continue_on_error: true

                        - service: climate.set_fan_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            fan_mode: "{{ selected_fan_mode }}"

                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_mode
                    data:
                      value: "cooling"

                  # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
                  - condition: template
                    value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ helper_mode_time }}"
                    data:
                      datetime: "{{ now() }}"

                  - service: system_log.write
                    data:
                      message: >
                        â„ï¸ Cooling activated after stability reset
                        â€¢ Temperature: {{ current_temp }}Â°C
                        â€¢ Target: {{ cooling_target_temp }}Â°C
                        â€¢ Mode: {{ 'High' if current_temp >= cooling_high_temp else 'Medium' }}
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
              
              # Need heating
              - conditions:
                  - condition: template
                    value_template: >
                      {% set time_protection_met = (last_mode in ['heating_low', 'heating_medium', 'heating_high'] and (final_escalation_level > 0 or time_in_current_mode > runtime_min)) or ((last_mode == 'off' or actual_ac_state == 'off') and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['heating_low', 'heating_medium', 'heating_high', 'off']) %}
                      {{ should_activate and current_temp <= heating_medium_temp and current_temp > heating_high_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
                sequence:
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                            
                            # Smart heating mode selection
                            selected_hvac_mode: >
                              {% set modes = state_attr(repeat.item, 'hvac_modes') | list %}
                              {# For heating, try heating-capable modes #}
                              {% if 'heat' in modes %}
                                heat
                                {% elif 'Heat' in modes %}
                                Heat
                                {% elif 'auto' in modes %}
                                auto
                                {% elif 'Auto' in modes %}
                                Auto
                                {% elif 'heat_cool' in modes %}
                                heat_cool
                                {% elif 'Heat/Cool' in modes %}
                                Heat/Cool
                                {% else %}
                                {{ modes[0] if modes else 'off' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_hvac }}"
                          data:
                            value: "{{ selected_hvac_mode }}"
                          continue_on_error: true

                        - service: climate.set_hvac_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            hvac_mode: >
                              {% set available = state_attr(current_entity, 'hvac_modes') | list %}
                              {{ selected_hvac_mode if selected_hvac_mode in available else (available[0] if available else 'off') }}
                        
                        - condition: template
                          value_template: "{{ debug_enabled }}"
                        - service: system_log.write
                          data:
                            message: >
                              ğŸ” SMART HEAT MODE: {{ repeat.item }}
                              â€¢ Available: {{ available_modes | join(', ') }}
                              â€¢ Selected: {{ selected_hvac_mode }}
                              â€¢ Reason: Best heating mode for this AC unit
                            level: debug
                            logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: "{{ heating_target_temp }}"
                    continue_on_error: true

                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entities
                    data:
                      temperature: "{{ heating_target_temp }}"
                  
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                            desired_max_fan: !input fan_speed_max
                            selected_fan_mode: >
                              {% if desired_max_fan in available_fans %}
                                {{ desired_max_fan }}
                                {% elif '5' in available_fans %}
                                5
                                {% elif 'Level 5' in available_fans %}
                                Level 5
                                {% elif 'high' in available_fans %}
                                high
                                {% elif 'Auto' in available_fans %}
                                Auto
                                {% elif 'auto' in available_fans %}
                                auto
                                {% else %}
                                {{ available_fans[-1] if available_fans else 'Auto' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_fan }}"
                          data:
                            value: "{{ selected_fan_mode }}"
                          continue_on_error: true

                        - service: climate.set_fan_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            fan_mode: "{{ selected_fan_mode | trim }}"
                  
                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_mode
                    data:
                      value: "heating"

                  # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
                  - condition: template
                    value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'heating' or actual_ac_state == 'off') }}"
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ helper_mode_time }}"
                    data:
                      datetime: "{{ now() }}"

                  - service: system_log.write
                    data:
                      message: >
                        ğŸ”¥ Heating activated after stability reset
                        â€¢ Temperature: {{ current_temp }}Â°C
                        â€¢ Target: {{ heating_target_temp }}Â°C
                        â€¢ Mode: {{ 'High' if current_temp <= heating_low_temp else 'Medium' }}
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

      # Pre-conditioning when approaching
      - conditions:
          - condition: template
            value_template: "{{ enable_pre_conditioning }}"
          - condition: template
            value_template: "{{ should_activate }}"
          - condition: template
            value_template: "{{ approaching_home }}"
          - condition: template
            value_template: "{{ current_temp > cooling_medium_temp or current_temp < heating_medium_temp }}"
        sequence:
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: Pre-conditioning activated
                Reason: Approaching home
                {% if proximity_sensor %}Distance: {{ states(proximity_sensor) }}m{% endif %}
                Temperature: {{ current_temp }}Â°C needs adjustment
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: >
                {% if current_temp > comfort_max_temp %}
                  cool
                {% elif current_temp < comfort_min_temp %}
                  heat
                {% else %}
                  heat_cool
                {% endif %}
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: >
                {% if current_temp > comfort_max_temp %}
                  cool
                {% elif current_temp < comfort_min_temp %}
                  heat
                {% else %}
                  heat_cool
                {% endif %}

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ weather_adjusted_target }}"
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ weather_adjusted_target }}"

          - service: system_log.write
            data:
              message: >
                ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Pre-conditioning
                Set AC to: {{ weather_adjusted_target | round(0) }}Â°C (rounded for AC compatibility)
                Actual value: {{ weather_adjusted_target | round(1) }}Â°C
                Reason: Pre-conditioning target temperature (approaching home)
                Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ weather_adjusted_target | round(1) }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - variables:
              selected_fan_mode: >
                {% set available_fans = state_attr(climate_list[0], 'fan_modes') | list %}
                {% set desired_medium_fan = fan_speed_medium %}
                {% if desired_medium_fan in available_fans %}
                  {{ desired_medium_fan }}
                {% elif '3' in available_fans %}
                  3
                {% elif 'Level 3' in available_fans %}
                  Level 3
                {% elif 'medium' in available_fans %}
                  medium
                {% elif 'Auto' in available_fans %}
                  Auto
                {% elif 'auto' in available_fans %}
                  auto
                {% else %}
                  {{ available_fans[-1] if available_fans else 'Auto' }}
                {% endif %}

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_fan }}"
            data:
              value: "{{ selected_fan_mode }}"
            continue_on_error: true

          - service: climate.set_fan_mode
            target:
              entity_id: !input climate_entities
            data:
              fan_mode: "{{ selected_fan_mode | trim }}"
          
          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "Climate Pre-conditioning"
              message: >
                Pre-conditioning started - approaching home.
                Current: {{ current_temp }}Â°C
      
      # Low cooling - Gentle cooling mode when temperature just exceeds comfort zone
      # Activates at cooling_low_temp (e.g., 24.1Â°C) but continues until target reached
      # Uses low fan speed for maximum efficiency with minimal power consumption
      # NEW: Prevents short cycling by using target-based hysteresis logic
      # IMPORTANT: Only for pre-conditioning - not when already home in Smart mode
      - conditions:
          - condition: template
            value_template: "{{ should_activate and approaching_home }}"
          - condition: template
            value_template: >
              {% if last_mode == 'cooling' %}
                {# Already cooling - continue until target reached or moved to higher tier #}
                {% if current_temp <= (target_temp - target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - cooled to {{ (target_temp - target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% else %}
                  {{ should_activate and enable_cooling and current_temp > target_temp and current_temp < cooling_medium_temp }}
                {% endif %}
              {% else %}
                {# Not cooling - start if low threshold exceeded and below medium #}
                {{ should_activate and enable_cooling and current_temp >= cooling_low_temp and current_temp < cooling_medium_temp }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                {# Same cooling tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from heating/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (current_temp - target_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 70 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}

                {% if current_mode == 'cooling_low' %}
                  {% if temp_gap <= 0.3 %}
                    ğŸ¯ {{ room_name | upper }} LOW COOLING - PRECISION FINISH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C fine-tuning to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 85 %}| â„ï¸ OPTIMAL EFFICIENCY{% elif effectiveness >= 65 %}| âš™ï¸ GOOD CONTROL ({{ effectiveness }}%){% else %}| ğŸ”§ ADJUSTING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 1.5 %}
                    â„ï¸ {{ room_name | upper }} LOW COOLING - GENTLE APPROACH
                    ğŸ“Š CONTINUE MODE: Gradually cooling {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} LOW COOLING - PATIENT MODE
                    ğŸ“Š CONTINUE MODE: Steady cooling {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to cool)
                    ğŸŒ¡ï¸ Gentle power until comfort | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 3.0 %}
                    â„ï¸ {{ room_name | upper }} LOW COOLING - CAUTIOUS START
                    ğŸš€ START MODE: Moderate heat {{ current_temp }}Â°C â‰¥ {{ cooling_low_temp }}Â°C ({{ distance_adjusted }}Â°C excess)
                    ğŸŒ¡ï¸ Gentle cooling approach | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 1.0 %}
                    â„ï¸ {{ room_name | upper }} LOW COOLING - COMFORT ADJUSTMENT
                    ğŸš€ START MODE: Slight warmth {{ current_temp }}Â°C â‰¥ {{ cooling_low_temp }}Â°C threshold
                    âš™ï¸ Gentle cooling â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to cool) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} LOW COOLING - MICRO-ADJUST
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¥ {{ cooling_low_temp }}Â°C
                    ğŸ¯ Minimal cooling to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                    
                    # Smart cooling mode selection
                    selected_hvac_mode: >
                      {% set modes = state_attr(repeat.item, 'hvac_modes') | list %}
                      {# For cooling, try cooling-capable modes #}
                      {% if 'cool' in modes %}
                        cool
                        {% elif 'Cool' in modes %}
                        Cool
                        {% elif 'auto' in modes %}
                        auto
                        {% elif 'Auto' in modes %}
                        Auto
                        {% elif 'heat_cool' in modes %}
                        heat_cool
                        {% elif 'Heat/Cool' in modes %}
                        Heat/Cool
                        {% else %}
                        {{ modes[0] if modes else 'off' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "{{ selected_hvac_mode }}"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: "{{ selected_hvac_mode }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART LOW COOL MODE: {{ repeat.item }}
                      â€¢ Available: {{ available_modes | join(', ') }}
                      â€¢ Selected: {{ selected_hvac_mode }}
                      â€¢ Reason: Low cooling mode for gentle temperature control
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ cooling_target_temp }}"
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ cooling_target_temp }}"
            continue_on_error: true

          # Use low fan speed for gentle cooling
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    
                    # Smart low fan mode selection
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      
                      {# Try low speed equivalents in order of preference #}
                      {% if 'low' in fans %}
                        low
                        {% elif 'Low' in fans %}
                        Low
                        {% elif '1' in fans %}
                        1
                        {% elif 'Level 1' in fans %}
                        Level 1
                        {% elif 'quiet' in fans %}
                        quiet
                        {% elif 'Quiet' in fans %}
                        Quiet
                        {% elif 'eco' in fans %}
                        eco
                        {% elif 'Eco' in fans %}
                        Eco
                        {% elif 'auto' in fans %}
                        auto
                        {% elif 'Auto' in fans %}
                        Auto
                      {# Fallback to available options #}
                        {% elif '2' in fans %}
                        2
                        {% elif 'Level 2' in fans %}
                        Level 2
                        {% else %}
                        {{ fans[0] if fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART LOW FAN: {{ repeat.item }}
                      â€¢ Available: {{ available_fans | join(', ') }}
                      â€¢ Selected: {{ selected_fan_mode }}
                      â€¢ Reason: Low fan speed for gentle cooling
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling"

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true

      # Medium cooling - Normal cooling mode when temperature exceeds comfort zone
      # Activates at cooling_medium_temp (e.g., 25Â°C) but continues until target reached
      # Uses medium fan speed for efficient cooling without excessive power consumption
      # NEW: Prevents short cycling by using target-based hysteresis logic
      - conditions:
          - condition: template
            value_template: "{{ should_activate }}"
          - condition: template
            value_template: >
              {% if last_mode == 'cooling' %}
                {# Already cooling - continue until target reached or moved to higher tier #}
                {% if current_temp <= (target_temp - target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - cooled to {{ (target_temp - target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% else %}
                  {{ should_activate and enable_cooling and current_temp > target_temp and current_temp < cooling_high_temp }}
                {% endif %}
              {% else %}
                {# Not cooling - start if medium threshold exceeded and below high #}
                {{ should_activate and current_temp >= cooling_medium_temp and current_temp < cooling_high_temp }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                {# Same cooling tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from heating/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (current_temp - target_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 75 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}

                {% if current_mode == 'cooling_medium' %}
                  {% if temp_gap <= 0.5 %}
                    ğŸ¯ {{ room_name | upper }} MEDIUM COOLING - FINAL APPROACH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C nearly at {{ adjusted_target }}Â°C target ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 85 %}| â„ï¸ OPTIMAL EFFICIENCY{% elif effectiveness >= 65 %}| âš¡ GOOD EFFECTIVENESS ({{ effectiveness }}%){% else %}| ğŸ”§ ADJUSTING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 2.0 %}
                    â„ï¸ {{ room_name | upper }} MEDIUM COOLING - STEADY PROGRESS
                    ğŸ“Š CONTINUE MODE: Cooling {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} MEDIUM COOLING - SUSTAINED MODE
                    ğŸ“Š CONTINUE MODE: Working gap {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to cool)
                    âš™ï¸ Balanced power until target | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 4.0 %}
                    â„ï¸ {{ room_name | upper }} MEDIUM COOLING - INTENSIVE START
                    ğŸš€ START MODE: Significant heat {{ current_temp }}Â°C â‰¥ {{ cooling_medium_temp }}Â°C ({{ distance_adjusted }}Â°C excess)
                    âš¡ Steady cooling power engaged | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 1.5 %}
                    â„ï¸ {{ room_name | upper }} MEDIUM COOLING - STANDARD COOL-DOWN
                    ğŸš€ START MODE: Moderate heat {{ current_temp }}Â°C â‰¥ {{ cooling_medium_temp }}Â°C threshold
                    âš™ï¸ Balanced cooling â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to cool) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} MEDIUM COOLING - GENTLE MODE
                    ğŸš€ START MODE: Minor adjustment {{ current_temp }}Â°C â‰¥ {{ cooling_medium_temp }}Â°C
                    ğŸ¯ Comfort cooling to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                    
                    # Smart cooling mode selection
                    selected_hvac_mode: >
                      {% set modes = state_attr(repeat.item, 'hvac_modes') | list %}
                      {# For cooling, try cooling-capable modes #}
                      {% if 'cool' in modes %}
                        cool
                        {% elif 'Cool' in modes %}
                        Cool
                        {% elif 'auto' in modes %}
                        auto
                        {% elif 'Auto' in modes %}
                        Auto
                        {% elif 'heat_cool' in modes %}
                        heat_cool
                        {% elif 'Heat/Cool' in modes %}
                        Heat/Cool
                        {% else %}
                        {{ modes[0] if modes else 'off' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "{{ selected_hvac_mode }}"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: "{{ selected_hvac_mode }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART MEDIUM COOL MODE: {{ repeat.item }}
                      â€¢ Available: {{ available_modes | join(', ') }}
                      â€¢ Selected: {{ selected_hvac_mode }}
                      â€¢ Reason: Medium cooling mode for balanced temperature control
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ cooling_target_temp }}"
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ cooling_target_temp }}"
            continue_on_error: true

          # Use medium fan speed for balanced cooling
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    desired_medium_fan: "{{ fan_speed_medium }}"
                    
                    # Smart medium fan mode selection
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {% set desired = fan_speed_medium %}
                      
                      {# First try the exact user selection #}
                      {% if desired in fans %}
                        {{ desired }}
                      {# Then try medium speed equivalents in order of preference #}
                        {% elif 'medium' in fans %}
                        medium
                        {% elif 'Medium' in fans %}
                        Medium
                        {% elif '3' in fans %}
                        3
                        {% elif 'Level 3' in fans %}
                        Level 3
                        {% elif 'auto' in fans %}
                        auto
                        {% elif 'Auto' in fans %}
                        Auto
                      {# Fallback to available options #}
                        {% elif '2' in fans %}
                        2
                        {% elif 'Level 2' in fans %}
                        Level 2
                        {% elif 'low' in fans %}
                        low
                        {% elif 'high' in fans %}
                        high
                        {% else %}
                        {{ fans[0] if fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"

                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART MEDIUM FAN: {{ repeat.item }}
                      â€¢ Desired: {{ desired_medium_fan }}
                      â€¢ Available: {{ available_fans | join(', ') }}
                      â€¢ Selected: {{ selected_fan_mode }}
                      â€¢ Reason: {{ 'Exact match' if desired_medium_fan in available_fans else 'Best equivalent for medium cooling' }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling"

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true

      # Comfort zone - Eco mode or OFF mode (Power Saving)
      # When temperature is within acceptable range (e.g., 21-25Â°C with Â±2Â°C tolerance)
      # OFF mode saves 40-60% more energy vs eco mode but allows temperature drift
      - conditions:
          - condition: template
            value_template: "{{ should_activate }}"
          - condition: template
            value_template: "{{ current_temp >= comfort_min_temp and current_temp <= comfort_max_temp }}"
          - condition: template
            value_template: "{{ time_since_change > runtime_min }}"
        sequence:
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: Comfort Zone Action Triggered
                
                ğŸ›ï¸ Control Status:
                    â€¢ Control Mode: {{ control_mode }}
                    â€¢ Should Activate: {{ should_activate }}
                    â€¢ Extreme Temp Detected: {{ extreme_temp_detected }}
                    â€¢ Current Temp: {{ current_temp }}Â°C
                    â€¢ Extreme High: {{ extreme_high }}Â°C
                    â€¢ Extreme Low: {{ extreme_low }}Â°C
                    â€¢ Room Presence: {{ room_presence_detected }}
                    â€¢ Approaching Home: {{ approaching_home }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ eco_enabled }}"
                sequence:
                  # Eco mode - maintain with reduced fan and wider setpoint (uses ~150-250W)
                  # Set HVAC mode to auto for maximum efficiency in comfort zone
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                            expected_hvac_mode: >
                              {% if 'auto' in available_modes %}
                                auto
                                {% elif 'Auto' in available_modes %}
                                Auto
                                {% elif 'heat_cool' in available_modes %}
                                heat_cool
                                {% elif 'Heat/Cool' in available_modes %}
                                heat_cool
                                {% else %}
                                {{ available_modes[0] if available_modes else 'off' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_hvac }}"
                          data:
                            value: "{{ expected_hvac_mode }}"
                          continue_on_error: true

                        - service: climate.set_hvac_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            hvac_mode: "{{ expected_hvac_mode }}"

                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: "{{ adjusted_target }}"
                    continue_on_error: true

                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entities
                    data:
                      temperature: "{{ adjusted_target }}"

                  - service: system_log.write
                    data:
                      message: >
                        ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Comfort Zone Maintenance
                        Set AC to: {{ target_temp | round(0) }}Â°C (rounded for AC compatibility)
                        Actual value: {{ target_temp | round(1) }}Â°C
                        Reason: Maintaining target temperature within comfort zone
                        Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ target_temp | round(1) }}Â°C
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
                  
                  # Set eco fan mode for maximum efficiency in comfort zone
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                            desired_eco_fan: "{{ fan_speed_eco }}"
                            expected_fan_mode: >
                              {% if desired_eco_fan in available_fans %}
                                {{ desired_eco_fan }}
                                {% elif 'Auto' in available_fans %}
                                Auto
                                {% elif 'auto' in available_fans %}
                                auto
                                {% elif 'Quiet' in available_fans %}
                                Quiet
                                {% elif 'quiet' in available_fans %}
                                quiet
                                {% elif 'Silence' in available_fans %}
                                Silence
                                {% elif 'silence' in available_fans %}
                                silence
                                {% elif 'Level 1' in available_fans %}
                                Level 1
                                {% elif '1' in available_fans %}
                                1
                                {% elif 'low' in available_fans %}
                                low
                                {% elif 'Low' in available_fans %}
                                Low
                                {% else %}
                                {{ available_fans[0] if available_fans else 'Auto' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_fan }}"
                          data:
                            value: "{{ expected_fan_mode }}"
                          continue_on_error: true

                        - service: climate.set_fan_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            fan_mode: "{{ expected_fan_mode }}"

                  # Set swing mode with compatibility check for eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_swings: "{{ state_attr(repeat.item, 'swing_modes') | list }}"
                            desired_swing: !input swing_mode_active
                            selected_swing_mode: >
                              {% if desired_swing in available_swings %}
                                {{ desired_swing }}
                                {% elif desired_swing == 'both' and '3D' in available_swings %}
                                3D
                                {% elif desired_swing == 'both' and 'Both' in available_swings %}
                                Both
                                {% elif desired_swing == 'vertical' and 'Vertical' in available_swings %}
                                Vertical
                                {% elif desired_swing == 'Vertical' and 'vertical' in available_swings %}
                                vertical
                                {% elif desired_swing == 'horizontal' and 'Horizontal' in available_swings %}
                                Horizontal
                                {% elif desired_swing == 'Horizontal' and 'horizontal' in available_swings %}
                                horizontal
                                {% elif 'both' in available_swings %}
                                both
                                {% elif 'Both' in available_swings %}
                                Both
                                {% elif '3D' in available_swings %}
                                3D
                                {% elif 'Vertical' in available_swings %}
                                Vertical
                                {% elif 'vertical' in available_swings %}
                                vertical
                                {% else %}
                                {{ available_swings[0] if available_swings else 'Off' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_swing }}"
                          data:
                            value: "{{ selected_swing_mode | trim }}"
                          continue_on_error: true

                        - service: climate.set_swing_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            swing_mode: "{{ selected_swing_mode | trim }}"
                  
                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_mode
                    data:
                      value: "eco"

                  # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
                  - condition: template
                    value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'eco' or actual_ac_state == 'off') }}"
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ helper_mode_time }}"
                    data:
                      datetime: "{{ now() }}"
                  
                  - condition: template
                    value_template: "{{ enable_notifications }}"
                  
                  - service: !input notification_service
                    data:
                      title: "{{ room_name }} Climate Control"
                      message: "Eco mode - Comfort zone ({{ current_temp }}Â°C)"
            
            default:
              # OFF mode - Maximum power savings (0W consumption)
              # A/C turns completely off when temperature is acceptable
              # Will restart when temp exits comfort zone (e.g., <21Â°C or >25Â°C)
              - service: climate.turn_off
                target:
                  entity_id: !input climate_entities
                continue_on_error: true
              
              - service: input_text.set_value
                target:
                  entity_id: !input helper_last_mode
                data:
                  value: "off"

              # Update mode start time for off-time protection tracking (always update when going to OFF)
              - if:
                  - condition: template
                    value_template: "{{ helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' }}"
                then:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ helper_mode_time }}"
                    data:
                      datetime: "{{ now() }}"
              
              - condition: template
                value_template: "{{ enable_notifications }}"
              
              - service: !input notification_service
                data:
                  title: "{{ room_name }} Climate Control"
                  message: "Turned off - Comfort zone ({{ current_temp }}Â°C)"

      # Temperature Stability Auto-Off (Auto/Smart Mode - temperature equilibrium reached AND in comfort zone)
      - conditions:
          - condition: template
            value_template: "{{ temp_stability_enabled }}"
          - condition: template
            value_template: "{{ control_mode in ['Smart', 'Auto'] }}"
          - condition: template
            value_template: "{{ temp_stability_detected }}"
          - condition: template
            value_template: "{{ last_mode not in ['off', 'stability_off', 'stability_eco', 'unavailable', 'unknown', none] }}"
          - condition: template
            value_template: "{{ time_since_change >= runtime_min }}"
          # v3.9.21 FIX: Only turn off when WITHIN comfort zone, not outside it with buffer
          # v3.9.26 FIX: Don't turn off if actively pursuing overshoot target in continue mode
          - condition: template
            value_template: >
              {% set in_comfort_zone = current_temp >= comfort_min_temp and current_temp <= comfort_max_temp %}
              {% set in_continue_mode = last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] %}
              {% set overshoot_target_reached = false %}

              {% if in_continue_mode %}
                {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                  {# Cooling: target reached when temp <= (target - overshoot) #}
                  {% set overshoot_target_reached = current_temp <= (target_temp - target_overshoot) %}
                {% elif last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
                  {# Heating: target reached when temp >= (target + overshoot) #}
                  {% set overshoot_target_reached = current_temp >= (target_temp + target_overshoot) %}
                {% endif %}
              {% endif %}

              {# Allow stability auto-off ONLY if: in comfort zone AND (not in continue mode OR overshoot target already reached) #}
              {{ in_comfort_zone and (not in_continue_mode or overshoot_target_reached) }}
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    ğŸ¯ Smart Feature: Temperature Stable & Comfortable
                    ğŸŒ¡ï¸ Temperature steady at {{ current_temp | round(1) }}Â°C for {{ time_in_current_mode | round(0) }} minutes
                    âœ… Within comfort zone ({{ comfort_min_temp }}-{{ comfort_max_temp }}Â°C) - switching to {{ stability_behavior|upper }} mode to save energy

                    ğŸ“‹ Technical: Â±{{ stability_tolerance }}Â°C tolerance, {{ stability_duration }}min requirement, {{ time_since_change | round(1) }}min since last change
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ stability_behavior == 'off' }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: !input climate_entities

                  - service: system_log.write
                    data:
                      message: >
                        ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Temperature Stability Auto-Off
                        Set AC to: OFF
                        Actual value: OFF
                        Reason: Temperature equilibrium reached - AC job complete
                        Stable at: {{ current_temp | round(1) }}Â°C for {{ time_in_current_mode | round(0) }} minutes
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
              
              - conditions:
                  - condition: template
                    value_template: "{{ stability_behavior == 'eco' }}"
                sequence:
                  # Set HVAC mode with compatibility check for eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                            expected_hvac_mode: >
                              {% if current_temp > comfort_max_temp %}
                                {% if 'cool' in available_modes %}
                                  cool
                                  {% elif 'auto' in available_modes %}
                                  auto
                                  {% elif 'heat_cool' in available_modes %}
                                  heat_cool
                                  {% else %}
                                  {{ available_modes[0] if available_modes else 'off' }}
                                {% endif %}
                                {% elif current_temp < comfort_min_temp %}
                                {% if 'heat' in available_modes %}
                                  heat
                                  {% elif 'auto' in available_modes %}
                                  auto
                                  {% elif 'heat_cool' in available_modes %}
                                  heat_cool
                                  {% else %}
                                  {{ available_modes[0] if available_modes else 'off' }}
                                {% endif %}
                                {% else %}
                                {% if 'auto' in available_modes %}
                                  auto
                                  {% elif 'heat_cool' in available_modes %}
                                  heat_cool
                                  {% else %}
                                  {{ available_modes[0] if available_modes else 'off' }}
                                {% endif %}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_hvac }}"
                          data:
                            value: "{{ expected_hvac_mode }}"
                          continue_on_error: true

                        - service: climate.set_hvac_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            hvac_mode: "{{ expected_hvac_mode }}"

                  - variables:
                      expected_temp: >
                        {% if current_temp > comfort_max_temp %}
                          {{ comfort_max_temp + 1 }}
                          {% elif current_temp < comfort_min_temp %}
                          {{ comfort_min_temp - 1 }}
                          {% else %}
                          {{ target_temp }}
                        {% endif %}

                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: "{{ expected_temp }}"
                    continue_on_error: true

                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entities
                    data:
                      temperature: "{{ expected_temp }}"

                  - service: system_log.write
                    data:
                      message: >
                        ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Temperature Stability Eco Mode
                        Set AC to: {{ ((comfort_max_temp + 1) if current_temp > comfort_max_temp else (comfort_min_temp - 1) if current_temp < comfort_min_temp else target_temp) | round(0) }}Â°C (rounded for AC compatibility)
                        Actual value: {{ ((comfort_max_temp + 1) if current_temp > comfort_max_temp else (comfort_min_temp - 1) if current_temp < comfort_min_temp else target_temp) | round(1) }}Â°C
                        Reason: Temperature stability eco mode (gentle maintenance after equilibrium)
                        Current: {{ current_temp | round(1) }}Â°C â†’ Stable for {{ time_in_current_mode | round(0) }} minutes
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                  # Set eco fan mode for efficient stability eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                            desired_eco_fan: "{{ fan_speed_eco }}"
                            expected_fan_mode: >
                              {% if desired_eco_fan in available_fans %}
                                {{ desired_eco_fan }}
                                {% elif 'Auto' in available_fans %}
                                Auto
                                {% elif 'auto' in available_fans %}
                                auto
                                {% elif 'Quiet' in available_fans %}
                                Quiet
                                {% elif 'quiet' in available_fans %}
                                quiet
                                {% elif 'Silence' in available_fans %}
                                Silence
                                {% elif 'silence' in available_fans %}
                                silence
                                {% elif 'Level 1' in available_fans %}
                                Level 1
                                {% elif '1' in available_fans %}
                                1
                                {% elif 'low' in available_fans %}
                                low
                                {% elif 'Low' in available_fans %}
                                Low
                                {% else %}
                                {{ available_fans[0] if available_fans else 'Auto' }}
                              {% endif %}
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "stability_{{ stability_behavior }}"

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and last_mode != 'stability_' + stability_behavior }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          - condition: template
            value_template: "{{ notification_service is defined and notification_service not in [none, ''] }}"
          - service: "{{ notification_service }}"
            data:
              title: "{{ room_name }} Climate Control"
              message: "Temperature Stability: {{ stability_behavior }} (stable {{ time_in_current_mode | round(0) }}min, {{ current_temp }}Â°C)"

      
      # Adaptive Control Mode - Auto-switch modes based on room occupancy
      - conditions:
          - condition: template
            value_template: "{{ adaptive_enabled }}"
          # Manual Override Protection
          - condition: template
            value_template: >
              {% if adaptive_override_helper and adaptive_override_helper not in ['', 'unknown', 'unavailable'] %}
                {{ not is_state(adaptive_override_helper, 'on') }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: >
              {% if adaptive_override_timeout > 0 %}
                {% set override_time = states(helper_override_timestamp) if helper_override_timestamp else none %}
                {% if override_time and override_time not in ['unknown', 'unavailable', ''] %}
                  {% set time_since_override = (as_timestamp(now()) - as_timestamp(override_time)) / 3600 %}
                  {{ time_since_override >= adaptive_override_timeout }}
                {% else %}
                  true
                {% endif %}
              {% else %}
                true
              {% endif %}
        sequence:
          # Debug logging for Adaptive Control evaluation
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} ADAPTIVE CONTROL: Evaluating conditions...
                
                âš™ï¸ Adaptive Settings:
                    â€¢ Enabled: {{ adaptive_enabled }}
                    â€¢ Current Mode: {{ control_mode }}
                    â€¢ Room Presence: {{ room_presence_detected }}
                    â€¢ Last Presence: {{ states(presence_detected_helper) if presence_detected_helper else 'N/A' }}
                    â€¢ Occupied Delay: {{ adaptive_occupied_delay }} min
                    â€¢ Vacant Delay: {{ adaptive_vacant_delay }} min
                    â€¢ Target Mode: {{ adaptive_target_mode | title }}
                {% if presence_detected_helper and states(presence_detected_helper) not in ['unknown', 'unavailable', ''] %}
                {% set presence_time = (as_timestamp(now()) - as_timestamp(states(presence_detected_helper))) / 60 %}
                    â€¢ Time Since Last Presence: {{ presence_time | round(1) }} min
                {% endif %}
              level: debug
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Additional parent conditions debug logging
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} ADAPTIVE CONTROL: Parent Conditions Detail...
                
                ğŸ”’ Override Protection:
                    â€¢ adaptive_enabled: {{ adaptive_enabled }}
                    â€¢ override_helper exists: {{ adaptive_override_helper not in ['', 'unknown', 'unavailable'] if adaptive_override_helper else false }}
                {% if adaptive_override_helper and adaptive_override_helper not in ['', 'unknown', 'unavailable'] %}
                    â€¢ override_helper state: {{ states(adaptive_override_helper) }}
                    â€¢ override_active: {{ is_state(adaptive_override_helper, 'on') }}
                {% endif %}
                    â€¢ override_timeout: {{ adaptive_override_timeout }} hours
                {% if helper_change and states(helper_change) not in ['unknown', 'unavailable', ''] %}
                {% set time_since_change = (as_timestamp(now()) - as_timestamp(states(helper_change))) / 3600 %}
                    â€¢ time_since_last_change: {{ time_since_change | round(2) }} hours
                    â€¢ timeout_met: {{ time_since_change >= adaptive_override_timeout }}
                {% endif %}
              level: debug
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Main condition evaluation and action logic
          - condition: or
            conditions:
              # REMOVED: Should NOT auto-switch from Manual to Auto/Smart
              # Manual mode is user's explicit choice - respect it!
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ false }}"  # Disabled - Manual mode stays manual
              # Switch to Manual + AC off when room vacant for configured time
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ control_mode in ['Auto', 'Smart'] }}"
                  - condition: template
                    value_template: "{{ not room_presence_detected }}"
                  - condition: template
                    value_template: >
                      {% set last_presence = states(presence_detected_helper) %}
                      {% if last_presence not in ['unknown', 'unavailable', ''] %}
                        {% set vacant_time = as_timestamp(now()) - as_timestamp(last_presence) %}
                        {{ (vacant_time / 60) >= adaptive_vacant_delay }}
                        {% else %}
                        false
                      {% endif %}
              # Handle case where already in Manual mode but AC still running and room vacant
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ control_mode == 'Manual' }}"
                  - condition: template
                    value_template: "{{ not room_presence_detected }}"
                  - condition: template
                    value_template: >
                      {% set last_presence = states(presence_detected_helper) %}
                      {% if last_presence not in ['unknown', 'unavailable', ''] %}
                        {% set vacant_time = as_timestamp(now()) - as_timestamp(last_presence) %}
                        {{ (vacant_time / 60) >= adaptive_vacant_delay }}
                        {% else %}
                        false
                      {% endif %}
                  - condition: template
                    value_template: >
                      {% if climate_list %}
                        {% set first_climate_state = states(climate_list[0]) %}
                        {{ first_climate_state not in ['off', 'Off', 'unavailable', 'unknown'] }}
                        {% else %}
                        false
                      {% endif %}
          
          # Execute actions when conditions are met
          # Handle occupied room - switch to Auto/Smart mode
          - choose:
            - conditions:
                - condition: template
                  value_template: "{{ control_mode == 'Manual' and room_presence_detected }}"
              sequence:
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      âœ… {{ room_name | upper }} ADAPTIVE CONTROL: OCCUPIED â†’ SWITCHING TO {{ adaptive_target_mode | title }} MODE
                      â€¢ Current Mode: {{ control_mode }} â†’ {{ adaptive_target_mode | title }}
                      â€¢ Room Presence: {{ room_presence_detected }}
                      â€¢ Required Delay: {{ adaptive_occupied_delay }} min
                      {% set last_presence = states(presence_detected_helper) %}
                      {% if last_presence not in ['unknown', 'unavailable', ''] %}
                      {% set presence_time = (as_timestamp(now()) - as_timestamp(last_presence)) / 60 %}
                      â€¢ Actual Presence Time: {{ presence_time | round(1) }} min ({{ presence_time | round(1) - adaptive_occupied_delay | round(1) }}min over threshold)
                      â€¢ Last Presence Detected: {{ as_timestamp(last_presence) | timestamp_custom('%H:%M:%S') }}
                      {% endif %}
                      â€¢ Action: Switching control mode helper to {{ adaptive_target_mode | title }}
                    level: info
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
                
                - service: input_select.select_option
                  target:
                    entity_id: "{{ control_mode_helper }}"
                  data:
                    option: "{{ adaptive_target_mode | title }}"
                
                # Debug completion log
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: "âœ… {{ room_name | upper }} ADAPTIVE CONTROL: OCCUPIED actions completed - control mode switched to {{ adaptive_target_mode | title }}"
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
                
                - condition: template
                  value_template: "{{ notification_service is defined and notification_service not in [none, ''] }}"
                - service: "{{ notification_service }}"
                  data:
                    title: "{{ room_name }} Adaptive Climate Control"
                    message: "Room occupied - switched to {{ adaptive_target_mode | title }} mode"
            
            # Handle vacant room - switch to Manual mode and turn AC off
            - conditions:
                - condition: template
                  value_template: "{{ control_mode in ['Auto', 'Smart'] and not room_presence_detected }}"
              sequence:
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ”´ Adaptive Control: VACANT â†’ SWITCHING TO MANUAL & TURNING AC OFF
                      â€¢ Current Mode: {{ control_mode }} â†’ Manual
                      â€¢ Room Presence: {{ room_presence_detected }}
                      â€¢ Required Delay: {{ adaptive_vacant_delay }} min
                      {% set last_presence = states(presence_detected_helper) %}
                      {% if last_presence not in ['unknown', 'unavailable', ''] %}
                      {% set vacant_time = (as_timestamp(now()) - as_timestamp(last_presence)) / 60 %}
                      â€¢ Actual Vacant Time: {{ vacant_time | round(1) }} min ({{ vacant_time | round(1) - adaptive_vacant_delay | round(1) }}min over threshold)
                      â€¢ Last Presence Detected: {{ as_timestamp(last_presence) | timestamp_custom('%H:%M:%S') }}
                      {% endif %}
                      â€¢ Actions: Turn off {{ climate_list | length }} climate entities (NO LONGER switching to Manual mode)
                    level: info
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                # CRITICAL: Runtime protection - ensure AC has run for minimum time before turning off
                - condition: template
                  value_template: "{{ time_since_change >= runtime_min }}"

                # DISABLED: No longer switching to Manual mode when room becomes vacant
                # Just turn off all climate entities
                - repeat:
                    for_each: "{{ climate_list }}"
                    sequence:
                      - if:
                          - condition: template
                            value_template: "{{ debug_enabled }}"
                        then:
                          - service: system_log.write
                            data:
                              message: "ğŸ”´ Adaptive Control: Turning off climate entity {{ repeat.item }} ({{ repeat.index }}/{{ climate_list | length }})"
                              level: debug
                              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                      - service: climate.turn_off
                        target:
                          entity_id: "{{ repeat.item }}"
                
                # Update last mode helper to prevent conflicts
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_mode }}"
                  data:
                    value: "adaptive_off"

                # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
                - condition: template
                  value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and last_mode != 'adaptive_off' }}"
                - service: input_datetime.set_datetime
                  target:
                    entity_id: "{{ helper_mode_time }}"
                  data:
                    datetime: "{{ now() }}"
                
                # Debug completion log
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: "âœ… {{ room_name | upper }} ADAPTIVE CONTROL: VACANT actions completed - all {{ climate_list | length }} climate entities turned off, helper set to adaptive_off"
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
                
                - condition: template
                  value_template: "{{ notification_service is defined and notification_service not in [none, ''] }}"
                - service: "{{ notification_service }}"
                  data:
                    title: "{{ room_name }} Adaptive Climate Control"
                    message: "Room vacant - turned AC off"

            # REMOVED: Manual mode should NEVER turn off AC based on presence
            # Users in Manual mode have full control - presence doesn't matter
            - conditions:
                - condition: template
                  value_template: "{{ false }}"  # This condition will never trigger
              sequence:
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ”´ Adaptive Control: ALREADY MANUAL â†’ TURNING AC OFF
                      â€¢ Already in Manual mode, room vacant, AC still running
                      â€¢ Room Presence: {{ room_presence_detected }}
                      â€¢ Required Delay: {{ adaptive_vacant_delay }} min
                      {% set last_presence = states(presence_detected_helper) %}
                      {% if last_presence not in ['unknown', 'unavailable', ''] %}
                      {% set vacant_time = (as_timestamp(now()) - as_timestamp(last_presence)) / 60 %}
                      â€¢ Actual Vacant Time: {{ vacant_time | round(1) }} min ({{ vacant_time | round(1) - adaptive_vacant_delay | round(1) }}min over threshold)
                      â€¢ Last Presence Detected: {{ as_timestamp(last_presence) | timestamp_custom('%H:%M:%S') }}
                      {% endif %}
                      â€¢ Action: Turning off {{ climate_list | length }} climate entities
                    level: info
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                # CRITICAL: Runtime protection - ensure AC has run for minimum time before turning off
                - condition: template
                  value_template: "{{ time_since_change >= runtime_min }}"

                # Turn off all climate entities
                - repeat:
                    for_each: "{{ climate_list }}"
                    sequence:
                      - if:
                          - condition: template
                            value_template: "{{ debug_enabled }}"
                        then:
                          - service: system_log.write
                            data:
                              message: "ğŸ”´ Adaptive Control: Turning off climate entity {{ repeat.item }} ({{ repeat.index }}/{{ climate_list | length }})"
                              level: debug
                              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                      - service: climate.turn_off
                        target:
                          entity_id: "{{ repeat.item }}"
                
                # Update last mode helper to prevent conflicts
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_mode }}"
                  data:
                    value: "adaptive_off"
                
                # Debug completion log
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: "âœ… {{ room_name | upper }} ADAPTIVE CONTROL: MANUAL+VACANT actions completed - all {{ climate_list | length }} climate entities turned off, helper set to adaptive_off"
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
                
                - condition: template
                  value_template: "{{ notification_service is defined and notification_service not in [none, ''] }}"
                - service: "{{ notification_service }}"
                  data:
                    title: "{{ room_name }} Adaptive Climate Control"
                    message: "Room vacant - turned AC off (was already in Manual mode)"

      # Adaptive Control Debug - Log when enabled but conditions not met
      - conditions:
          - condition: template
            value_template: "{{ adaptive_enabled and debug_enabled }}"
          - condition: not
            conditions:
              - condition: or
                conditions:
                  # Check if occupied conditions would be met
                  - condition: and
                    conditions:
                      - condition: template
                        value_template: "{{ control_mode == 'Manual' }}"
                      - condition: template
                        value_template: "{{ room_presence_detected }}"
                      - condition: template
                        value_template: >
                          {% set last_presence = states(presence_detected_helper) %}
                          {% if last_presence not in ['unknown', 'unavailable', ''] %}
                            {% set presence_time = as_timestamp(now()) - as_timestamp(last_presence) %}
                            {{ (presence_time / 60) >= adaptive_occupied_delay }}
                            {% else %}
                            false
                          {% endif %}
                  # Check if vacant conditions would be met
                  - condition: and
                    conditions:
                      - condition: template
                        value_template: "{{ control_mode in ['Auto', 'Smart'] }}"
                      - condition: template
                        value_template: "{{ not room_presence_detected }}"
                      - condition: template
                        value_template: >
                          {% set last_presence = states(presence_detected_helper) %}
                          {% if last_presence not in ['unknown', 'unavailable', ''] %}
                            {% set vacant_time = as_timestamp(now()) - as_timestamp(last_presence) %}
                            {{ (vacant_time / 60) >= adaptive_vacant_delay }}
                            {% else %}
                            false
                          {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                â³ Adaptive Control: Conditions not met
                {% set last_presence = states(presence_detected_helper) %}
                {% if last_presence not in ['unknown', 'unavailable', ''] %}
                {% set time_diff = (as_timestamp(now()) - as_timestamp(last_presence)) / 60 %}
                {% if control_mode == 'Manual' and room_presence_detected %}
                â€¢ OCCUPIED scenario: Need {{ adaptive_occupied_delay }}min, have {{ time_diff | round(1) }}min ({{ (adaptive_occupied_delay - time_diff) | round(1) }}min remaining)
                {% elif control_mode in ['Auto', 'Smart'] and not room_presence_detected %}
                â€¢ VACANT scenario: Need {{ adaptive_vacant_delay }}min, have {{ time_diff | round(1) }}min ({{ (adaptive_vacant_delay - time_diff) | round(1) }}min remaining)
                {% else %}
                â€¢ Mode: {{ control_mode }}, Presence: {{ room_presence_detected }}, Time: {{ time_diff | round(1) }}min - No matching scenario
                {% endif %}
                {% else %}
                â€¢ No valid presence timestamp available from helper: {{ presence_detected_helper }}
                {% endif %}
              level: debug
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

      # Manual Mode - Immediately clear automation states when detected
      - conditions:
          - condition: template
            value_template: "{{ control_mode == 'Manual' }}"
          - condition: template
            value_template: "{{ last_mode in ['stability_off', 'stability_eco', 'smart_off', 'smart_eco', 'smart_maintain', 'adaptive_off', 'eco', 'cooling', 'heating'] }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    ğŸ® Manual Mode: IMMEDIATE Control Restored
                    ğŸ”„ Clearing "{{ last_mode }}" state instantly
                    ğŸ’¡ You now have full manual control - no automation interference

                    ğŸ“‹ Technical: Manual mode = instant automation disable
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "manual"

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'manual' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          # CRITICAL: Update helper_change to start 3-hour override protection
          - condition: template
            value_template: "{{ helper_change not in [none, '', 'unavailable', 'unknown', []] and helper_change is string and helper_change != '' }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_change }}"
            data:
              datetime: "{{ now() }}"
              
          # Turn off AC when switching to Manual mode from automation-controlled state
          - service: climate.turn_off
            target:
              entity_id: !input climate_entities

      # Smart Mode room absence (room empty but still home)
      - conditions:
          - condition: template
            value_template: "{{ control_mode == 'Smart' }}"
          - condition: template
            value_template: "{{ not room_presence_detected }}"
          - condition: template
            value_template: "{{ minutes_since_presence >= presence_timeout }}"
          - condition: template
            value_template: "{{ proximity_zone == 'home' or anyone_home }}"
          - condition: template
            value_template: "{{ time_since_change >= runtime_min }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    ğŸšª Smart Mode: Room Empty
                    ğŸ’¡ Nobody detected in room for {{ minutes_since_presence | round(0) }} minutes
                    ğŸ  You're still home, so switching to {{ smart_behavior|upper }} mode to save energy

                    ğŸ“‹ Technical: {{ time_since_change | round(1) }}min since last change
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ smart_behavior == 'off' }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: !input climate_entities
              
              - conditions:
                  - condition: template
                    value_template: "{{ smart_behavior == 'eco' }}"
                sequence:
                  # Set HVAC mode with auto preference and fallback for room eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                            expected_hvac_mode: >
                              {% if 'auto' in available_modes %}
                                auto
                                {% elif 'Auto' in available_modes %}
                                Auto
                                {% elif 'heat_cool' in available_modes %}
                                heat_cool
                                {% elif 'Heat/Cool' in available_modes %}
                                heat_cool
                                {% elif current_temp > comfort_max_temp and 'cool' in available_modes %}
                                cool
                                {% elif current_temp < comfort_min_temp and 'heat' in available_modes %}
                                heat
                                {% else %}
                                {{ available_modes[0] if available_modes else 'off' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_hvac }}"
                          data:
                            value: "{{ expected_hvac_mode }}"
                          continue_on_error: true

                        - service: climate.set_hvac_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            hvac_mode: "{{ expected_hvac_mode }}"

                  - variables:
                      expected_temp: >
                        {% if current_temp > comfort_max_temp %}
                          {{ comfort_max_temp + eco_mode_setpoint_offset }}
                          {% elif current_temp < comfort_min_temp %}
                          {{ comfort_min_temp - eco_mode_setpoint_offset }}
                          {% else %}
                          {{ target_temp }}
                        {% endif %}

                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: "{{ expected_temp }}"
                    continue_on_error: true

                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entities
                    data:
                      temperature: "{{ expected_temp }}"

                  - service: system_log.write
                    data:
                      message: >
                        ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Smart Room Eco Mode
                        Set AC to: {{ ((comfort_max_temp + eco_mode_setpoint_offset) if current_temp > comfort_max_temp else (comfort_min_temp - eco_mode_setpoint_offset) if current_temp < comfort_min_temp else target_temp) | round(0) }}Â°C (rounded for AC compatibility)
                        Actual value: {{ ((comfort_max_temp + eco_mode_setpoint_offset) if current_temp > comfort_max_temp else (comfort_min_temp - eco_mode_setpoint_offset) if current_temp < comfort_min_temp else target_temp) | round(1) }}Â°C
                        Reason: {{ 'Eco cooling (comfort max +' + eco_mode_setpoint_offset|string + 'Â°C)' if current_temp > comfort_max_temp else 'Eco heating (comfort min -' + eco_mode_setpoint_offset|string + 'Â°C)' if current_temp < comfort_min_temp else 'Direct target (within comfort zone)' }}
                        Current: {{ current_temp | round(1) }}Â°C â†’ Comfort range: {{ comfort_min_temp | round(1) }}-{{ comfort_max_temp | round(1) }}Â°C
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

                  # Set eco fan mode for efficient smart room eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                            desired_eco_fan: "{{ fan_speed_eco }}"
                            expected_fan_mode: >
                              {% if desired_eco_fan in available_fans %}
                                {{ desired_eco_fan }}
                                {% elif 'Auto' in available_fans %}
                                Auto
                                {% elif 'auto' in available_fans %}
                                auto
                                {% elif 'Quiet' in available_fans %}
                                Quiet
                                {% elif 'quiet' in available_fans %}
                                quiet
                                {% elif 'Silence' in available_fans %}
                                Silence
                                {% elif 'silence' in available_fans %}
                                silence
                                {% elif 'Level 1' in available_fans %}
                                Level 1
                                {% elif '1' in available_fans %}
                                1
                                {% elif 'low' in available_fans %}
                                low
                                {% elif 'Low' in available_fans %}
                                Low
                                {% else %}
                                {{ available_fans[0] if available_fans else 'Auto' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_fan }}"
                          data:
                            value: "{{ expected_fan_mode }}"
                          continue_on_error: true

                        - service: climate.set_fan_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            fan_mode: "{{ expected_fan_mode }}"

              - conditions:
                  - condition: template
                    value_template: "{{ smart_behavior == 'maintain' }}"
                sequence:
                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: "{{ adjusted_target }}"
                    continue_on_error: true

                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entities
                    data:
                      temperature: "{{ adjusted_target }}"

                  - service: system_log.write
                    data:
                      message: >
                        ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Smart Room Maintain
                        Set AC to: {{ target_temp | round(0) }}Â°C (rounded for AC compatibility)
                        Actual value: {{ target_temp | round(1) }}Â°C
                        Reason: Smart mode maintain current temperature (room empty but still home)
                        Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ target_temp | round(1) }}Â°C
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "smart_{{ smart_behavior }}"

          # Update mode start time for effectiveness tracking (only if mode changed OR AC was off)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and last_mode != 'smart_' + smart_behavior }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "{{ room_name }} Climate Control"
              message: "Smart Mode: {{ smart_behavior }} (room empty {{ minutes_since_presence | round(0) }}min, {{ current_temp }}Â°C)"

      # Away mode (Global - nobody home)
      - conditions:
          - condition: template
            value_template: "{{ enable_away_mode }}"
          - condition: template
            value_template: "{{ not should_activate }}"
          - condition: template
            value_template: "{{ time_since_change >= runtime_min }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    ğŸ” {{ room_name | upper }} CLIMATE DEBUG: Away mode activated
                    Action: {{ away_action }}
                    Nobody home detected
                    Time since last change: {{ time_since_change | round(1) }} min
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ away_action == 'off' }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: !input climate_entities
              
              - conditions:
                  - condition: template
                    value_template: "{{ away_action == 'eco' }}"
                sequence:
                  # Set HVAC mode with auto preference and fallback for away eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                            selected_hvac_mode: >
                              {% if 'auto' in available_modes %}
                                auto
                                {% elif 'Auto' in available_modes %}
                                Auto
                                {% elif 'heat_cool' in available_modes %}
                                heat_cool
                                {% elif 'Heat/Cool' in available_modes %}
                                heat_cool
                                {% elif current_temp > comfort_max_temp and 'cool' in available_modes %}
                                cool
                                {% elif current_temp < comfort_min_temp and 'heat' in available_modes %}
                                heat
                                {% else %}
                                {{ available_modes[0] if available_modes else 'off' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_hvac }}"
                          data:
                            value: "{{ selected_hvac_mode }}"
                          continue_on_error: true

                        - service: climate.set_hvac_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            hvac_mode: "{{ selected_hvac_mode }}"

                  # Capture expected values for enhanced manual override detection (v3.3.0)
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ helper_expected_temp }}"
                    data:
                      value: >
                        {% if current_temp > comfort_max_temp %}
                          {{ cooling_target_temp + eco_mode_setpoint_offset }}
                          {% else %}
                          {{ heating_target_temp - eco_mode_setpoint_offset }}
                        {% endif %}
                    continue_on_error: true

                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entities
                    data:
                      temperature: >
                        {% if current_temp > comfort_max_temp %}
                          {{ cooling_target_temp + eco_mode_setpoint_offset }}
                          {% else %}
                          {{ heating_target_temp - eco_mode_setpoint_offset }}
                        {% endif %}

                  - service: system_log.write
                    data:
                      message: >
                        ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Away Eco Mode
                        Set AC to: {{ ((cooling_target_temp + eco_mode_setpoint_offset) if current_temp > comfort_max_temp else (heating_target_temp - eco_mode_setpoint_offset)) | round(0) }}Â°C (rounded for AC compatibility)
                        Actual value: {{ ((cooling_target_temp + eco_mode_setpoint_offset) if current_temp > comfort_max_temp else (heating_target_temp - eco_mode_setpoint_offset)) | round(1) }}Â°C
                        Reason: {{ 'Eco cooling (target +' + eco_mode_setpoint_offset|string + 'Â°C offset)' if current_temp > comfort_max_temp else 'Eco heating (target -' + eco_mode_setpoint_offset|string + 'Â°C offset)' }}
                        Current: {{ current_temp | round(1) }}Â°C â†’ Comfort range: {{ comfort_min_temp | round(1) }}-{{ comfort_max_temp | round(1) }}Â°C
                      level: warning
                      logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
                  
                  # Set eco fan mode for efficient away eco mode
                  - repeat:
                      for_each: "{{ climate_list }}"
                      sequence:
                        - variables:
                            current_entity: "{{ repeat.item }}"
                            available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                            desired_eco_fan: "{{ fan_speed_eco }}"
                            selected_fan_mode: >
                              {% if desired_eco_fan in available_fans %}
                                {{ desired_eco_fan }}
                                {% elif 'Auto' in available_fans %}
                                Auto
                                {% elif 'auto' in available_fans %}
                                auto
                                {% elif '1' in available_fans %}
                                1
                                {% elif 'Level 1' in available_fans %}
                                Level 1
                                {% elif 'low' in available_fans %}
                                low
                                {% elif 'Low' in available_fans %}
                                Low
                                {% else %}
                                {{ available_fans[0] if available_fans else 'Auto' }}
                              {% endif %}

                        # Capture expected values for enhanced manual override detection (v3.3.0)
                        - service: input_text.set_value
                          target:
                            entity_id: "{{ helper_expected_fan }}"
                          data:
                            value: "{{ selected_fan_mode }}"
                          continue_on_error: true

                        - service: climate.set_fan_mode
                          target:
                            entity_id: "{{ current_entity }}"
                          data:
                            fan_mode: "{{ selected_fan_mode }}"

          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "Climate Away Mode"
              message: "{{ away_action | title }} mode activated - nobody home"
      
      # High cooling mode - Maximum cooling when temperature is very high
      # Activates at cooling_high_temp (e.g., 26Â°C) but continues until target reached
      # Uses maximum fan speed for rapid cooling
      # NEW: Prevents short cycling by using target-based hysteresis logic
      - conditions:
          - condition: template
            value_template: "{{ should_activate }}"
          - condition: template
            value_template: >
              {% if last_mode == 'cooling' %}
                {# Already cooling - continue until target reached #}
                {% if current_temp <= (target_temp - target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - cooled to {{ (target_temp - target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% else %}
                  {{ should_activate and enable_cooling and current_temp > target_temp }}
                {% endif %}
              {% else %}
                {# Not cooling - start if high threshold exceeded #}
                {% set last_transition_val = states(helper_last_transition) if helper_last_transition else 'none' %}
                {% if last_transition_val == 'heating' %}
                  {{ enable_cooling and current_temp >= (cooling_high_temp + hysteresis_tolerance) }}
                {% else %}
                  {{ enable_cooling and current_temp >= cooling_high_temp }}
                {% endif %}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                {# Same cooling tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from heating/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (current_temp - target_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 85 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}

                {% if current_mode == 'cooling_high' %}
                  {% if temp_gap <= 0.5 %}
                    ğŸ¯ {{ room_name | upper }} HIGH COOLING - FINAL APPROACH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C almost at {{ adjusted_target }}Â°C target ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 90 %}| â„ï¸ MAXIMUM INTENSITY{% elif effectiveness >= 70 %}| âš¡ HIGH EFFECTIVENESS ({{ effectiveness }}%){% else %}| ğŸ”§ STRUGGLING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 2.0 %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - CRUISING TO TARGET
                    ğŸ“Š CONTINUE MODE: Cooling {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - EMERGENCY MODE
                    ğŸ“Š CONTINUE MODE: Large gap {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C excess!)
                    âš¡ Full power until comfortable | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 5.0 %}
                    ğŸš¨ {{ room_name | upper }} HIGH COOLING - EMERGENCY START
                    ğŸš€ START MODE: EXTREME heat {{ current_temp }}Â°C â‰¥ {{ cooling_high_temp }}Â°C ({{ distance_adjusted }}Â°C excess!)
                    â„ï¸ Maximum cooling power engaged | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 2.0 %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - RAPID COOL-DOWN
                    ğŸš€ START MODE: Hot {{ current_temp }}Â°C â‰¥ {{ cooling_high_temp }}Â°C threshold
                    âš¡ High-power cooling â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to cool) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    â„ï¸ {{ room_name | upper }} HIGH COOLING - PRECISION MODE
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¥ {{ cooling_high_temp }}Â°C
                    ğŸ¯ Gentle approach to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: HIGH COOLING MODE
                Temperature: {{ current_temp }}Â°C > {{ cooling_high_temp }}Â°C
                Target: {{ cooling_target_temp }}Â°C
                Fan: Maximum
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set HVAC mode with auto preference and fallback
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                    selected_hvac_mode: >
                      {% if 'cool' in available_modes %}
                        cool
                        {% elif 'Cool' in available_modes %}
                        Cool
                        {% elif 'auto' in available_modes %}
                        auto
                        {% elif 'Auto' in available_modes %}
                        Auto
                        {% elif 'heat_cool' in available_modes %}
                        heat_cool
                        {% elif 'Heat/Cool' in available_modes %}
                        Heat/Cool
                        {% else %}
                        {{ available_modes[0] if available_modes else 'off' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "{{ selected_hvac_mode }}"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: "{{ selected_hvac_mode }}"
          
          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: >
                {% if gradual_enabled %}
                  {{ [weather_adjusted_target, current_temp - 2] | min }}
                {% else %}
                  {{ weather_adjusted_target }}
                {% endif %}
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: >
                {% if gradual_enabled %}
                  {{ [weather_adjusted_target, current_temp - 2] | min }}
                {% else %}
                  {{ weather_adjusted_target }}
                {% endif %}

          - service: system_log.write
            data:
              message: >
                ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: High Cooling
                Set AC to: {{ ([weather_adjusted_target, current_temp - 2] | min if gradual_enabled else weather_adjusted_target) | round(0) }}Â°C (rounded for AC compatibility)
                Actual value: {{ ([weather_adjusted_target, current_temp - 2] | min if gradual_enabled else weather_adjusted_target) | round(1) }}Â°C
                Reason: {{ 'Gradual adjustment (target ' + weather_adjusted_target|string + 'Â°C, current-2Â°C = ' + (current_temp-2)|round(1)|string + 'Â°C, chose minimum)' if gradual_enabled else 'Direct target temperature' }}
                Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ weather_adjusted_target | round(1) }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Update hysteresis tracking - we're now cooling
          - condition: template
            value_template: "{{ helper_last_transition is defined and helper_last_transition != none }}"
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_last_transition }}"
            data:
              value: "cooling"
          
          # Set fan mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    desired_max_fan: !input fan_speed_max
                    selected_fan_mode: >
                      {% if desired_max_fan in available_fans %}
                        {{ desired_max_fan }}
                        {% elif '5' in available_fans %}
                        5
                        {% elif 'Level 5' in available_fans %}
                        Level 5
                        {% elif 'high' in available_fans %}
                        high
                        {% elif 'Auto' in available_fans %}
                        Auto
                        {% elif 'auto' in available_fans %}
                        auto
                        {% else %}
                        {{ available_fans[0] if available_fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
          
          # Set swing mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_swings: "{{ state_attr(repeat.item, 'swing_modes') | list }}"
                    desired_swing: !input swing_mode_active
                    selected_swing_mode: >
                      {% if desired_swing in available_swings %}
                        {{ desired_swing }}
                        {% elif desired_swing == 'both' and '3D' in available_swings %}
                        3D
                        {% elif desired_swing == 'both' and 'Both' in available_swings %}
                        Both
                        {% elif desired_swing == 'vertical' and 'Vertical' in available_swings %}
                        Vertical
                        {% elif desired_swing == 'Vertical' and 'vertical' in available_swings %}
                        vertical
                        {% elif desired_swing == 'horizontal' and 'Horizontal' in available_swings %}
                        Horizontal
                        {% elif desired_swing == 'Horizontal' and 'horizontal' in available_swings %}
                        horizontal
                        {% elif 'both' in available_swings %}
                        both
                        {% elif 'Both' in available_swings %}
                        Both
                        {% elif '3D' in available_swings %}
                        3D
                        {% elif 'Vertical' in available_swings %}
                        Vertical
                        {% elif 'vertical' in available_swings %}
                        vertical
                        {% else %}
                        {{ available_swings[0] if available_swings else 'off' }}
                      {% endif %}
                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_swing }}"
                  data:
                    value: "{{ selected_swing_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_swing_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    swing_mode: "{{ selected_swing_mode | trim }}"
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling"
          
          # Update mode start time for effectiveness tracking (only if it exists)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "{{ room_name }} Climate Control"
              message: "High cooling mode - {{ current_temp }}Â°C"
      
      # Medium cooling mode
      - conditions:
          - condition: template
            value_template: "{{ should_activate }}"
          - condition: template
            value_template: "{{ current_temp >= cooling_medium_temp and current_temp < cooling_high_temp }}"
          - condition: template
            value_template: >
              {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] %}
                {# Same cooling tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from heating/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: MEDIUM COOLING MODE
                Temperature: {{ current_temp }}Â°C ({{ cooling_medium_temp }}-{{ cooling_high_temp }}Â°C range)
                Target: {{ cooling_target_temp }}Â°C
                Fan: Auto/Medium (efficient)
                
                MANUAL MODE DEBUG:
                Control Mode: {{ control_mode }}
                Should Activate: {{ should_activate }}
                Extreme Temp Detected: {{ extreme_temp_detected }}
                Room Presence: {{ room_presence_detected }}
                Approaching Home: {{ approaching_home }}
                Extreme High Threshold: {{ extreme_high }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set HVAC mode to auto for efficient medium cooling
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                    selected_hvac_mode: >
                      {% if 'auto' in available_modes %}
                        auto
                        {% elif 'heat_cool' in available_modes %}
                        heat_cool
                        {% elif 'cool' in available_modes %}
                        cool
                        {% else %}
                        {{ available_modes[0] if available_modes else 'off' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "{{ selected_hvac_mode }}"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: "{{ selected_hvac_mode }}"
          
          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: >
                {% if gradual_enabled %}
                  {{ [cooling_target_temp, current_temp - 1] | min }}
                {% else %}
                  {{ cooling_target_temp }}
                {% endif %}
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: >
                {% if gradual_enabled %}
                  {{ [cooling_target_temp, current_temp - 1] | min }}
                {% else %}
                  {{ cooling_target_temp }}
                {% endif %}

          - service: system_log.write
            data:
              message: >
                ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Medium Cooling
                Set AC to: {{ ([cooling_target_temp, current_temp - 1] | min if gradual_enabled else cooling_target_temp) | round(0) }}Â°C (rounded for AC compatibility)
                Actual value: {{ ([cooling_target_temp, current_temp - 1] | min if gradual_enabled else cooling_target_temp) | round(1) }}Â°C
                Reason: {{ 'Gradual adjustment (target ' + cooling_target_temp|string + 'Â°C, current-1Â°C = ' + (current_temp-1)|round(1)|string + 'Â°C, chose minimum)' if gradual_enabled else 'Direct target temperature' }}
                Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ cooling_target_temp | round(1) }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set auto/medium fan mode for efficient cooling
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    selected_fan_mode: >
                      {% if 'Auto' in available_fans %}
                        Auto
                        {% elif 'auto' in available_fans %}
                        auto
                        {% elif 'medium' in available_fans %}
                        medium
                        {% elif 'Level 3' in available_fans %}
                        Level 3
                        {% elif '3' in available_fans %}
                        3
                        {% else %}
                        {{ available_fans[-1] if available_fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
          
          # Set swing mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_swings: "{{ state_attr(repeat.item, 'swing_modes') | list }}"
                    desired_swing: !input swing_mode_active
                    selected_swing_mode: >
                      {% if desired_swing in available_swings %}
                        {{ desired_swing }}
                        {% elif desired_swing == 'both' and '3D' in available_swings %}
                        3D
                        {% elif desired_swing == 'both' and 'Both' in available_swings %}
                        Both
                        {% elif desired_swing == 'vertical' and 'Vertical' in available_swings %}
                        Vertical
                        {% elif desired_swing == 'Vertical' and 'vertical' in available_swings %}
                        vertical
                        {% elif desired_swing == 'horizontal' and 'Horizontal' in available_swings %}
                        Horizontal
                        {% elif desired_swing == 'Horizontal' and 'horizontal' in available_swings %}
                        horizontal
                        {% elif 'both' in available_swings %}
                        both
                        {% elif 'Both' in available_swings %}
                        Both
                        {% elif '3D' in available_swings %}
                        3D
                        {% elif 'Vertical' in available_swings %}
                        Vertical
                        {% elif 'vertical' in available_swings %}
                        vertical
                        {% else %}
                        {{ available_swings[0] if available_swings else 'off' }}
                      {% endif %}
                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_swing }}"
                  data:
                    value: "{{ selected_swing_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_swing_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    swing_mode: "{{ selected_swing_mode | trim }}"
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "cooling"
          
          # Update mode start time for effectiveness tracking (only if it exists)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
      
      # Low heating mode - Gentle heating when temperature just falls below comfort zone
      # Activates at heating_low_temp (e.g., 19.9Â°C) but continues until target reached
      # Uses low fan speed for maximum efficiency with minimal power consumption
      # NEW: Prevents short cycling by using target-based hysteresis logic
      - conditions:
          - condition: template
            value_template: "{{ should_activate }}"
          - condition: template
            value_template: >
              {% if last_mode == 'heating' %}
                {# Already heating - continue until target reached or moved to higher tier #}
                {% if current_temp >= (target_temp + target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - heated to {{ (target_temp + target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% else %}
                  {{ should_activate and enable_heating and current_temp < target_temp and current_temp > heating_medium_temp }}
                {% endif %}
              {% else %}
                {# Not heating - start if low threshold exceeded and above medium #}
                {{ should_activate and enable_heating and current_temp <= heating_low_temp and current_temp > heating_medium_temp }}
              {% endif %}
          - condition: template
            value_template: >
              {% if last_mode in ['heating_low', 'heating_medium', 'heating_high'] %}
                {# Same heating tier switching - allow escalation, enforce runtime for de-escalation #}
                {{ final_escalation_level > 0 or time_in_current_mode > runtime_min }}
              {% elif (last_mode == 'off' or actual_ac_state == 'off') and enforce_offtime %}
                {# Starting from OFF - enforce off-time if enabled #}
                {# Check BOTH helper mode AND actual AC state to catch mode change scenarios #}
                {{ time_in_current_mode > offtime_min }}
              {% else %}
                {# Switching from cooling/eco OR off-time protection disabled #}
                true
              {% endif %}
        sequence:
          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set overshoot_turnoff = (target_temp + target_overshoot) | round(1) %}
                {% set temp_gap = (overshoot_turnoff - current_temp) | round(1) %}
                {% set temp_gap_adjusted = (adjusted_target - current_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 65 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}
                {% set esc_display = 'L' ~ escalation if escalation > 0 else ('DE-L' ~ deescalation if deescalation > 0 else 'L0') %}
                {% set selected_fan = (final_escalation_level + 1) | string if final_escalation_level >= 0 else '1' %}
                {% set current_fan = selected_fan %}
                {% set target_info = 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: +' ~ target_overshoot ~ 'Â°C | AC Setpoint: ' ~ adjusted_target ~ 'Â°C' if adjusted_target != target_temp else 'ğŸ¯ User: ' ~ target_temp ~ 'Â°C | Overshoot: +' ~ target_overshoot ~ 'Â°C' %}

                {% if current_mode == 'heating_low' %}
                  {% if temp_gap <= 0.3 %}
                    ğŸ¯ {{ room_name | upper }} LOW HEATING - PRECISION FINISH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C fine-tuning to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 80 %}| ğŸ¯ PRECISE CONTROL{% elif effectiveness >= 60 %}| âš™ï¸ GOOD EFFICIENCY ({{ effectiveness }}%){% else %}| ğŸ”§ FINE-TUNING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 1.5 %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - GENTLE APPROACH
                    ğŸ“Š CONTINUE MODE: Gradually warming {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - PATIENT MODE
                    ğŸ“Š CONTINUE MODE: Steady warming {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat)
                    ğŸŒ¡ï¸ Gentle power until comfort | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 3.0 %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - CAUTIOUS START
                    ğŸš€ START MODE: Moderate cold {{ current_temp }}Â°C â‰¤ {{ heating_low_temp }}Â°C ({{ temp_gap_adjusted }}Â°C deficit)
                    ğŸŒ¡ï¸ Gentle heating approach | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 1.0 %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - COMFORT ADJUSTMENT
                    ğŸš€ START MODE: Slight cold {{ current_temp }}Â°C â‰¤ {{ heating_low_temp }}Â°C threshold
                    âš™ï¸ Gentle warming â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} LOW HEATING - MICRO-ADJUST
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¤ {{ heating_low_temp }}Â°C
                    ğŸ¯ Minimal warming to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: LOW HEATING MODE
                Temperature: {{ current_temp }}Â°C < {{ heating_low_temp }}Â°C
                Target: {{ heating_target_temp }}Â°C
                Fan: Low/Minimum (efficient)
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: >
                {% if current_temp > comfort_max_temp %}
                  cool
                {% elif current_temp < comfort_min_temp %}
                  heat
                {% else %}
                  heat_cool
                {% endif %}
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: >
                {% if current_temp > comfort_max_temp %}
                  cool
                {% elif current_temp < comfort_min_temp %}
                  heat
                {% else %}
                  heat_cool
                {% endif %}

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ heating_target_temp }}"
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ heating_target_temp }}"

          - service: system_log.write
            data:
              message: >
                ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Low Heating
                Set AC to: {{ heating_target_temp | round(0) }}Â°C (rounded for AC compatibility)
                Actual value: {{ heating_target_temp | round(1) }}Â°C
                Reason: Direct target temperature (no gradual adjustment for heating)
                Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ heating_target_temp | round(1) }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set low fan mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    
                    # Smart low fan mode selection
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      
                      {# Try low speed equivalents in order of preference #}
                      {% if 'low' in fans %}
                        low
                        {% elif 'Low' in fans %}
                        Low
                        {% elif '1' in fans %}
                        1
                        {% elif 'Level 1' in fans %}
                        Level 1
                        {% elif 'quiet' in fans %}
                        quiet
                        {% elif 'Quiet' in fans %}
                        Quiet
                        {% elif 'eco' in fans %}
                        eco
                        {% elif 'Eco' in fans %}
                        Eco
                        {% elif 'auto' in fans %}
                        auto
                        {% elif 'Auto' in fans %}
                        Auto
                      {# Fallback to available options #}
                        {% elif '2' in fans %}
                        2
                        {% elif 'Level 2' in fans %}
                        Level 2
                        {% else %}
                        {{ fans[0] if fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
                
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART LOW HEAT FAN: {{ repeat.item }}
                      â€¢ Available: {{ available_fans | join(', ') }}
                      â€¢ Selected: {{ selected_fan_mode }}
                      â€¢ Reason: Low fan speed for gentle heating
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set swing mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_swings: "{{ state_attr(repeat.item, 'swing_modes') | list }}"
                    desired_swing: !input swing_mode_active
                    selected_swing_mode: >
                      {% if desired_swing in available_swings %}
                        {{ desired_swing }}
                        {% elif desired_swing == 'both' and '3D' in available_swings %}
                        3D
                        {% elif desired_swing == 'both' and 'Both' in available_swings %}
                        Both
                        {% elif desired_swing == 'vertical' and 'Vertical' in available_swings %}
                        Vertical
                        {% elif desired_swing == 'Vertical' and 'vertical' in available_swings %}
                        vertical
                        {% elif desired_swing == 'horizontal' and 'Horizontal' in available_swings %}
                        Horizontal
                        {% elif desired_swing == 'Horizontal' and 'horizontal' in available_swings %}
                        horizontal
                        {% elif 'both' in available_swings %}
                        both
                        {% elif 'Both' in available_swings %}
                        Both
                        {% elif '3D' in available_swings %}
                        3D
                        {% elif 'Vertical' in available_swings %}
                        Vertical
                        {% elif 'vertical' in available_swings %}
                        vertical
                        {% else %}
                        {{ available_swings[0] if available_swings else 'off' }}
                      {% endif %}
                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_swing }}"
                  data:
                    value: "{{ selected_swing_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_swing_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    swing_mode: "{{ selected_swing_mode | trim }}"
          
          # v3.9.13: Wait for fan/swing commands
          - delay:
              milliseconds: 2000

          # v3.9.13: Set temperature with correct fan/swing
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ heating_target_temp }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "heating"

          # Update hysteresis tracking - we're now heating
          - condition: template
            value_template: "{{ helper_last_transition is defined and helper_last_transition != none }}"
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_last_transition }}"
            data:
              value: "heating"
          
          # Update mode start time for effectiveness tracking (only if it exists)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "{{ room_name }} Climate Control"
              message: "Low heating mode - {{ current_temp }}Â°C"
      
      # Medium heating mode - Balanced heating when temperature drops further
      # Activates at heating_medium_temp (e.g., 19Â°C) for moderate heating
      # Uses medium fan speed for balanced efficiency and performance
      - conditions:
          - condition: template
            value_template: >
              {% if last_mode == 'heating_medium' %}
                {# Already heating medium - continue until target reached or moved to higher tier #}
                {% if current_temp >= (target_temp + target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - heated to {{ (target_temp + target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% else %}
                  {{ current_temp < target_temp and current_temp > heating_high_temp }}
                {% endif %}
              {% else %}
                {# Not heating medium - start if medium threshold exceeded and above high #}
                {% set time_protection_met = (last_mode in ['heating_low', 'heating_medium', 'heating_high'] and time_in_current_mode > runtime_min) or (last_mode == 'off' and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['heating_low', 'heating_medium', 'heating_high', 'off']) %}
                {{ should_activate and enable_heating and current_temp <= heating_medium_temp and current_temp > heating_high_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
        sequence:
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: MEDIUM HEATING MODE
                Temperature: {{ current_temp }}Â°C ({{ heating_low_temp }}-{{ heating_medium_temp }}Â°C range)
                Target: {{ heating_target_temp }}Â°C
                Fan: Auto/Medium (efficient)
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set HVAC mode to auto for efficient medium heating
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                    selected_hvac_mode: >
                      {% if 'auto' in available_modes %}
                        auto
                        {% elif 'heat_cool' in available_modes %}
                        heat_cool
                        {% elif 'heat' in available_modes %}
                        heat
                        {% else %}
                        {{ available_modes[0] if available_modes else 'off' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "{{ selected_hvac_mode }}"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: "{{ selected_hvac_mode }}"
          
          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ heating_target_temp }}"
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ heating_target_temp }}"

          - service: system_log.write
            data:
              message: >
                ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Medium Heating
                Set AC to: {{ heating_target_temp | round(0) }}Â°C (rounded for AC compatibility)
                Actual value: {{ heating_target_temp | round(1) }}Â°C
                Reason: Direct target temperature (no gradual adjustment for heating)
                Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ heating_target_temp | round(1) }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set auto/medium fan mode for efficient heating
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    selected_fan_mode: >
                      {% if 'Auto' in available_fans %}
                        Auto
                        {% elif 'auto' in available_fans %}
                        auto
                        {% elif 'medium' in available_fans %}
                        medium
                        {% elif 'Level 3' in available_fans %}
                        Level 3
                        {% elif '3' in available_fans %}
                        3
                        {% else %}
                        {{ available_fans[-1] if available_fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
          
          # Set swing mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_swings: "{{ state_attr(repeat.item, 'swing_modes') | list }}"
                    desired_swing: !input swing_mode_active
                    selected_swing_mode: >
                      {% if desired_swing in available_swings %}
                        {{ desired_swing }}
                        {% elif desired_swing == 'both' and '3D' in available_swings %}
                        3D
                        {% elif desired_swing == 'both' and 'Both' in available_swings %}
                        Both
                        {% elif desired_swing == 'vertical' and 'Vertical' in available_swings %}
                        Vertical
                        {% elif desired_swing == 'Vertical' and 'vertical' in available_swings %}
                        vertical
                        {% elif desired_swing == 'horizontal' and 'Horizontal' in available_swings %}
                        Horizontal
                        {% elif desired_swing == 'Horizontal' and 'horizontal' in available_swings %}
                        horizontal
                        {% elif 'both' in available_swings %}
                        both
                        {% elif 'Both' in available_swings %}
                        Both
                        {% elif '3D' in available_swings %}
                        3D
                        {% elif 'Vertical' in available_swings %}
                        Vertical
                        {% elif 'vertical' in available_swings %}
                        vertical
                        {% else %}
                        {{ available_swings[0] if available_swings else 'off' }}
                      {% endif %}
                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_swing }}"
                  data:
                    value: "{{ selected_swing_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_swing_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    swing_mode: "{{ selected_swing_mode | trim }}"
          
          # v3.9.13: Wait for fan/swing commands
          - delay:
              milliseconds: 2000

          # v3.9.13: Set temperature with correct fan/swing
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ heating_target_temp }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "heating"

          # Update hysteresis tracking - we're now heating
          - condition: template
            value_template: "{{ helper_last_transition is defined and helper_last_transition != none }}"
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_last_transition }}"
            data:
              value: "heating"
          
          # Update mode start time for effectiveness tracking (only if it exists)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "{{ room_name }} Climate Control"
              message: "Medium heating mode - {{ current_temp }}Â°C"
      
      # High heating mode - Maximum heating when temperature drops significantly
      # Activates at heating_high_temp (e.g., 18Â°C) for emergency heating
      # Uses maximum fan speed for rapid temperature recovery
      - conditions:
          - condition: template
            value_template: >
              {% if last_mode == 'heating_high' %}
                {# Already heating high - continue until target reached #}
                {% if current_temp >= (target_temp + target_overshoot) %}
                  False  {# EXIT: Target achieved with overshoot - heated to {{ (target_temp + target_overshoot) | round(1) }}Â°C (strategy: {{ overshoot_strategy }}) #}
                {% else %}
                  {{ should_activate and enable_heating and current_temp < target_temp }}
                {% endif %}
              {% else %}
                {# Not heating high - start if high threshold exceeded #}
                {% set time_protection_met = (last_mode in ['heating_low', 'heating_medium', 'heating_high'] and time_in_current_mode > runtime_min) or (last_mode == 'off' and (not enforce_offtime or time_in_current_mode > offtime_min)) or (last_mode not in ['heating_low', 'heating_medium', 'heating_high', 'off']) %}
                {{ should_activate and enable_heating and current_temp <= heating_high_temp and time_protection_met and (control_mode != 'Smart' or smart_presence_active) }}
              {% endif %}
        sequence:
          # Debug logging at exact condition evaluation time
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} DEBUG: HIGH HEATING CONDITION EVALUATION
                ğŸ“Š At Exact Condition Time (condition was TRUE):
                    â€¢ last_mode: "{{ last_mode }}"
                    â€¢ should_activate: {{ should_activate }}
                    â€¢ current_temp: {{ current_temp }}Â°C
                    â€¢ heating_high_temp: {{ heating_high_temp }}Â°C
                    â€¢ time_since_change: {{ time_since_change | round(1) }}min
                    â€¢ runtime_min: {{ runtime_min }}min
                    â€¢ temp_check: {{ current_temp <= heating_high_temp }}
                    â€¢ time_check: {{ time_since_change > runtime_min }}
                    â€¢ mode_check: {{ last_mode != 'heating_high' }}
                    â€¢ FULL_CONDITION: {{ should_activate and current_temp <= heating_high_temp and (time_since_change > runtime_min or last_mode != 'heating_high') }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          - service: system_log.write
            data:
              message: >
                {% set current_mode = states(helper_mode) | default('off') %}
                {% set temp_gap = (target_temp - current_temp) | round(1) %}
                {% set eta_minutes = (temp_gap / temp_change_rate) | round(0) if temp_change_rate > 0 else 99 %}
                {% set effectiveness = current_effectiveness if dynamic_enabled else 75 %}
                {% set escalation = escalation_level if dynamic_enabled else 0 %}
                {% set deescalation = deescalation_level if dynamic_enabled else 0 %}

                {% if current_mode == 'heating_high' %}
                  {% if temp_gap <= 0.5 %}
                    ğŸ¯ {{ room_name | upper }} HIGH HEATING - FINAL APPROACH
                    ğŸ“Š CONTINUE MODE: Temperature {{ current_temp }}Â°C almost at {{ adjusted_target }}Â°C target ({{ temp_gap_adjusted }}Â°C remaining)
                    â±ï¸ ETA: ~{{ eta_minutes }}min {% if effectiveness >= 90 %}| ğŸ”¥ MAXIMUM INTENSITY{% elif effectiveness >= 70 %}| âš¡ HIGH EFFECTIVENESS ({{ effectiveness }}%){% else %}| ğŸ”§ STRUGGLING ({{ effectiveness }}% effective){% endif %}
                  {% elif temp_gap <= 2.0 %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - CRUISING TO TARGET
                    ğŸ“Š CONTINUE MODE: Heating {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to go)
                    â±ï¸ ETA: ~{{ eta_minutes }}min | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}{% if escalation > 0 %} | ğŸ”¼ ESCALATING L{{ escalation }}{% elif deescalation > 0 %} | ğŸ”½ DE-ESCALATING L{{ deescalation }}{% endif %}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - EMERGENCY MODE
                    ğŸ“Š CONTINUE MODE: Large gap {{ current_temp }}Â°C â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C deficit!)
                    âš¡ Full power until comfortable | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }} | Effectiveness: {{ effectiveness }}%
                  {% endif %}
                {% else %}
                  {% if temp_gap >= 5.0 %}
                    ğŸš¨ {{ room_name | upper }} HIGH HEATING - EMERGENCY START
                    ğŸš€ START MODE: EXTREME cold {{ current_temp }}Â°C â‰¤ {{ heating_high_temp }}Â°C ({{ temp_gap_adjusted }}Â°C deficit!)
                    ğŸ”¥ Maximum heating power engaged | Target: {{ adjusted_target }}Â°C | ETA: ~{{ eta_minutes }}min
                  {% elif temp_gap >= 2.0 %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - RAPID WARM-UP
                    ğŸš€ START MODE: Cold {{ current_temp }}Â°C â‰¤ {{ heating_high_temp }}Â°C threshold
                    âš¡ High-power heating â†’ {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C to heat) | âš¡ Escalation: {{ esc_display }} | Fan: {{ current_fan }}
                  {% else %}
                    ğŸ”¥ {{ room_name | upper }} HIGH HEATING - PRECISION MODE
                    ğŸš€ START MODE: Fine-tuning {{ current_temp }}Â°C â‰¤ {{ heating_high_temp }}Â°C
                    ğŸ¯ Gentle approach to {{ adjusted_target }}Â°C ({{ temp_gap_adjusted }}Â°C remaining) | ETA: ~{{ eta_minutes }}min
                  {% endif %}
                {% endif %}
                â€¢ Last Mode: {{ current_mode }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ” {{ room_name | upper }} CLIMATE DEBUG: HIGH HEATING MODE
                Temperature: {{ current_temp }}Â°C < {{ heating_high_temp }}Â°C
                Target: {{ heating_target_temp }}Â°C
                Fan: Maximum (emergency)
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_expected_hvac }}"
            data:
              value: >
                {% if current_temp > comfort_max_temp %}
                  cool
                {% elif current_temp < comfort_min_temp %}
                  heat
                {% else %}
                  heat_cool
                {% endif %}
            continue_on_error: true

          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entities
            data:
              hvac_mode: >
                {% if current_temp > comfort_max_temp %}
                  cool
                {% elif current_temp < comfort_min_temp %}
                  heat
                {% else %}
                  heat_cool
                {% endif %}

          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: "{{ heating_target_temp }}"
            continue_on_error: true

          # v3.9.13 FIX: Set fan mode BEFORE setting temperature to prevent full-blast during transitions
          # Set max fan mode for emergency heating
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    desired_max_fan: !input fan_speed_max
                    selected_fan_mode: >
                      {% if desired_max_fan in available_fans %}
                        {{ desired_max_fan }}
                        {% elif '5' in available_fans %}
                        5
                        {% elif 'Level 5' in available_fans %}
                        Level 5
                        {% elif 'high' in available_fans %}
                        high
                        {% elif 'High' in available_fans %}
                        High
                        {% elif 'turbo' in available_fans %}
                        turbo
                        {% elif 'Turbo' in available_fans %}
                        Turbo
                        {% elif 'max' in available_fans %}
                        max
                        {% elif 'Max' in available_fans %}
                        Max
                        {% elif '4' in available_fans %}
                        4
                        {% elif 'Level 4' in available_fans %}
                        Level 4
                        {% elif 'Auto' in available_fans %}
                        Auto
                        {% elif 'auto' in available_fans %}
                        auto
                        {% else %}
                        {{ available_fans[-1] if available_fans else 'Auto' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
                
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART HIGH HEAT FAN: {{ repeat.item }}
                      â€¢ Available: {{ available_fans | join(', ') }}
                      â€¢ Selected: {{ (desired_max_fan if desired_max_fan in available_fans else ('5' if '5' in available_fans else ('high' if 'high' in available_fans else available_fans[-1]))) }}
                      â€¢ Reason: Maximum fan speed for emergency heating
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set swing mode with compatibility check
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_swings: "{{ state_attr(repeat.item, 'swing_modes') | list }}"
                    desired_swing: !input swing_mode_active
                    selected_swing_mode: >
                      {% if desired_swing in available_swings %}
                        {{ desired_swing }}
                        {% elif desired_swing == 'both' and '3D' in available_swings %}
                        3D
                        {% elif desired_swing == 'both' and 'Both' in available_swings %}
                        Both
                        {% elif desired_swing == 'vertical' and 'Vertical' in available_swings %}
                        Vertical
                        {% elif desired_swing == 'Vertical' and 'vertical' in available_swings %}
                        vertical
                        {% elif desired_swing == 'horizontal' and 'Horizontal' in available_swings %}
                        Horizontal
                        {% elif desired_swing == 'Horizontal' and 'horizontal' in available_swings %}
                        horizontal
                        {% elif 'both' in available_swings %}
                        both
                        {% elif 'Both' in available_swings %}
                        Both
                        {% elif '3D' in available_swings %}
                        3D
                        {% elif 'Vertical' in available_swings %}
                        Vertical
                        {% elif 'vertical' in available_swings %}
                        vertical
                        {% else %}
                        {{ available_swings[0] if available_swings else 'off' }}
                      {% endif %}
                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_swing }}"
                  data:
                    value: "{{ selected_swing_mode | trim }}"
                  continue_on_error: true

                - service: climate.set_swing_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    swing_mode: "{{ selected_swing_mode | trim }}"
          
          # v3.9.13: Wait for fan/swing commands
          - delay:
              milliseconds: 2000

          # v3.9.13: Set temperature with correct fan/swing
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: "{{ heating_target_temp }}"

          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "heating"

          # Update hysteresis tracking - we're now heating
          - condition: template
            value_template: "{{ helper_last_transition is defined and helper_last_transition != none }}"
          - service: input_text.set_value
            target:
              entity_id: "{{ helper_last_transition }}"
            data:
              value: "heating"
          
          # Update mode start time for effectiveness tracking (only if it exists)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true
          
          - condition: template
            value_template: "{{ enable_notifications }}"
          
          - service: !input notification_service
            data:
              title: "{{ room_name }} Climate Control"
              message: "High heating mode - {{ current_temp }}Â°C"
      

      # FALLBACK: Dynamic Escalation - Only if no normal modes triggered
      - conditions:
          - condition: template
            value_template: "{{ should_escalate }}"
          - condition: template
            value_template: "{{ should_activate }}"
        sequence:
          - condition: template
            value_template: "{{ debug_enabled }}"
          - service: system_log.write
            data:
              message: >
                ğŸ”¥ {{ room_name | upper }} SMART ESCALATION LEVEL {{ final_escalation_level }}/4 ACTIVATED
                Effectiveness: {{ current_effectiveness }}% â€¢ Distance: {{ distance_from_target | round(1) }}Â°C â€¢ Runtime: {{ time_in_current_mode }}min
                Reason: {% if final_escalation_level == 4 %}ğŸš¨ EMERGENCY - {{ 'Far from target' if distance_from_target > 4 else 'Completely ineffective' if current_effectiveness <= 10 else 'Wrong direction trend' }}
                {% elif final_escalation_level == 3 %}ğŸ”¥ HIGH - {{ 'Still far after 5min' if distance_from_target > 3 else 'Poor effectiveness' if current_effectiveness <= 25 else 'Progress stalled' }}
                {% elif final_escalation_level == 2 %}âš¡ MEDIUM - {{ 'Moderate distance' if distance_from_target > 2 else 'Below average performance' }}
                {% elif final_escalation_level == 1 %}ğŸ“ˆ LOW - {{ 'Minor distance issue' if distance_from_target > 1 else 'Mediocre effectiveness' }}
                {% endif %}
                Power Level: {{ 'MAXIMUM' if final_escalation_level == 4 else 'HIGH' if final_escalation_level == 3 else 'ELEVATED' if final_escalation_level == 2 else 'MODERATE' if final_escalation_level == 1 else 'NORMAL' }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Force maximum cooling/heating mode
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_modes: "{{ state_attr(repeat.item, 'hvac_modes') | list }}"
                    selected_hvac_mode: >
                      {% if current_temp > comfort_max_temp and 'cool' in available_modes %}
                        cool
                        {% elif current_temp < comfort_min_temp and 'heat' in available_modes %}
                        heat
                        {% elif 'auto' in available_modes %}
                        auto
                        {% elif 'heat_cool' in available_modes %}
                        heat_cool
                        {% else %}
                        {{ available_modes[0] if available_modes else 'off' }}
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_hvac }}"
                  data:
                    value: "{{ selected_hvac_mode }}"
                  continue_on_error: true

                - service: climate.set_hvac_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    hvac_mode: "{{ selected_hvac_mode }}"
          
          # Capture expected values for enhanced manual override detection (v3.3.0)
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_expected_temp }}"
            data:
              value: >
                {% if current_temp > comfort_max_temp %}
                  {{ cooling_target_temp }}
                {% elif current_temp < comfort_min_temp %}
                  {{ heating_target_temp }}
                {% else %}
                  {{ target_temp }}
                {% endif %}
            continue_on_error: true

          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: >
                {% if current_temp > comfort_max_temp %}
                  {{ cooling_target_temp }}
                {% elif current_temp < comfort_min_temp %}
                  {{ heating_target_temp }}
                {% else %}
                  {{ target_temp }}
                {% endif %}

          - service: system_log.write
            data:
              message: >
                ğŸŒ¡ï¸ {{ room_name | upper }} TEMP SET: Emergency Escalation
                Set AC to: {{ (cooling_target_temp if current_temp > comfort_max_temp else heating_target_temp if current_temp < comfort_min_temp else target_temp) | round(0) }}Â°C (rounded for AC compatibility)
                Actual value: {{ (cooling_target_temp if current_temp > comfort_max_temp else heating_target_temp if current_temp < comfort_min_temp else target_temp) | round(1) }}Â°C
                Reason: {{ 'Emergency cooling (trend ineffective)' if current_temp > comfort_max_temp else 'Emergency heating (trend ineffective)' if current_temp < comfort_min_temp else 'Emergency target (stalled temperature)' }}
                Current: {{ current_temp | round(1) }}Â°C â†’ Target: {{ (cooling_target_temp if current_temp > comfort_max_temp else heating_target_temp if current_temp < comfort_min_temp else target_temp) | round(1) }}Â°C
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          # Set graduated fan speed based on escalation level
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - variables:
                    current_entity: "{{ repeat.item }}"
                    available_fans: "{{ state_attr(repeat.item, 'fan_modes') | list }}"
                    
                    # Smart escalation fan speed selection
                    selected_fan_mode: >
                      {% set fans = state_attr(repeat.item, 'fan_modes') | list %}
                      {% if final_escalation_level == 4 %}
                        {# Level 4: MAXIMUM power - use highest available speed #}
                        {% set desired = fan_speed_max %}
                        {% if desired in fans %}
                          {{ desired }}
                          {% elif 'turbo' in fans %}
                          turbo
                          {% elif 'Turbo' in fans %}
                          Turbo
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif 'max' in fans %}
                          max
                          {% elif 'Max' in fans %}
                          Max
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 3 %}
                        {# Level 3: HIGH power - use high speed #}
                        {% if 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif '5' in fans %}
                          5
                          {% elif 'Level 5' in fans %}
                          Level 5
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 2 %}
                        {# Level 2: ELEVATED power - use medium-high speed #}
                        {% if '4' in fans %}
                          4
                          {% elif 'Level 4' in fans %}
                          Level 4
                          {% elif 'high' in fans %}
                          high
                          {% elif 'High' in fans %}
                          High
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% else %}
                          {{ fans[-1] if fans else 'Auto' }}
                        {% endif %}
                        {% elif final_escalation_level == 1 %}
                        {# Level 1: MODERATE power - use medium speed #}
                        {% set desired = fan_speed_medium %}
                        {% if desired in fans %}
                          {{ desired }}
                          {% elif '3' in fans %}
                          3
                          {% elif 'Level 3' in fans %}
                          Level 3
                          {% elif 'medium' in fans %}
                          medium
                          {% elif 'Medium' in fans %}
                          Medium
                          {% elif 'auto' in fans %}
                          auto
                          {% elif 'Auto' in fans %}
                          Auto
                          {% else %}
                          {{ fans[0] if fans else 'Auto' }}
                        {% endif %}
                        {% else %}
                        Auto
                      {% endif %}

                # Capture expected values for enhanced manual override detection (v3.3.0)
                - service: input_text.set_value
                  target:
                    entity_id: "{{ helper_expected_fan }}"
                  data:
                    value: "{{ selected_fan_mode }}"
                  continue_on_error: true

                - service: climate.set_fan_mode
                  target:
                    entity_id: "{{ current_entity }}"
                  data:
                    fan_mode: "{{ selected_fan_mode | trim }}"
                
                - condition: template
                  value_template: "{{ debug_enabled }}"
                - service: system_log.write
                  data:
                    message: >
                      ğŸ” SMART ESCALATION FAN LEVEL {{ final_escalation_level }}: {{ repeat.item }}
                      â€¢ Available: {{ available_fans | join(', ') }}
                      â€¢ Selected: {{ selected_fan_mode }}
                      â€¢ Power: {{ 'MAXIMUM' if final_escalation_level == 4 else 'HIGH' if final_escalation_level == 3 else 'ELEVATED' if final_escalation_level == 2 else 'MODERATE' if final_escalation_level == 1 else 'NORMAL' }}
                    level: debug
                    logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"
          
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: >
                {% if current_temp > comfort_max_temp %}
                  cooling_escalated
                {% else %}
                  heating_escalated  
                {% endif %}
          
          # Update mode start time for effectiveness tracking (only if it exists)
          - condition: template
            value_template: "{{ dynamic_enabled and helper_mode_time not in [none, '', 'unavailable', 'unknown', []] and helper_mode_time is string and helper_mode_time != '' and (last_mode != 'cooling' or actual_ac_state == 'off') }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ helper_mode_time }}"
            data:
              datetime: "{{ now() }}"
            continue_on_error: true

  # Turn off AC in Smart mode when presence is lost (after grace period)
  # v3.9.23 FIX: Don't turn off if presence detected NOW (even during confirmation delay)
  - if:
        - condition: template
          value_template: >
            {{
              actual_ac_state == 'on' and
              control_mode == 'Smart' and
              not smart_presence_active and
              not room_presence_detected and
              last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] and
              time_since_change >= runtime_min
            }}
    then:
      # Log the turn-off action
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                ğŸšª {{ room_name | upper }} SMART MODE - PRESENCE NOT CONFIRMED

                {% if room_presence_detected %}
                â³ Presence detected but confirmation delay not met:
                    â€¢ Control Mode: Smart
                    â€¢ Sensors detecting presence: YES
                    â€¢ Time with presence: {{ minutes_with_presence | round(1) }} min
                    â€¢ Required confirmation delay: {{ presence_confirmation_delay }} min
                    â€¢ Grace period since last confirmed: {{ presence_timeout }} min
                    â€¢ Current Mode: {{ last_mode }}
                    â€¢ Action: Turning AC OFF (presence not confirmed for {{ presence_confirmation_delay }} min)
                {% else %}
                âœ… Turning Off After Grace Period:
                    â€¢ Control Mode: Smart
                    â€¢ Sensors detecting presence: NO
                    â€¢ Minutes since last confirmed: {{ minutes_since_presence | round(1) }} min
                    â€¢ Grace Period: {{ presence_timeout }} minutes
                    â€¢ Current Mode: {{ last_mode }}
                    â€¢ Action: Turning AC OFF (no presence after grace period)
                {% endif %}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

      # Turn off the AC
      - service: climate.turn_off
        target:
          entity_id: !input climate_entities
        continue_on_error: true

      # Update helper to reflect AC is now off
      - condition: template
        value_template: >
          {{
            helper_mode is defined and
            helper_mode not in ['', 'unavailable', 'unknown'] and
            states(helper_mode) not in ['unavailable', 'unknown']
          }}
      - service: input_text.set_value
        target:
          entity_id: !input helper_last_mode
        data:
          value: "off"
        continue_on_error: true

      # Update mode start time for off-time protection tracking
      - if:
          - condition: template
            value_template: "{{ helper_mode_time not in [none, '', 'unavailable', 'unknown'] }}"
        then:
          - service: input_datetime.set_datetime
            target:
              entity_id: !input helper_mode_start_time
            data:
              datetime: "{{ now() }}"
            continue_on_error: true


  # Turn off AC if it's running but temperature has reached/passed target
  # v3.9.27 FIX: Use OVERSHOOT target, not user target!
  - if:
      - condition: template
        value_template: >
          {{
            actual_ac_state == 'on' and
            last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] and
            time_since_change >= runtime_min and
            (
              (last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] and current_temp <= (target_temp - target_overshoot)) or
              (last_mode in ['heating_low', 'heating_medium', 'heating_high'] and current_temp >= (target_temp + target_overshoot))
            )
          }}
    then:
      # Log the turn-off action
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                ğŸ¯ {{ room_name | upper }} TARGET REACHED - TURNING OFF

                âœ… Conditions Met:
                    â€¢ Current: {{ current_temp }}Â°C
                    â€¢ Target: {{ cooling_target_temp if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high'] else heating_target_temp }}Â°C
                    â€¢ Mode: {{ last_mode }}
                    â€¢ Runtime: {{ time_since_change | round(1) }}min (min: {{ runtime_min }}min)
                    â€¢ Action: Turning AC OFF (target achieved)
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

      # Turn off the AC
      - service: climate.turn_off
        target:
          entity_id: !input climate_entities

      # Update helper to show AC is now off
      - condition: template
        value_template: >
          {{
            helper_mode is defined and
            helper_mode not in ['', 'unavailable', 'unknown'] and
            states(helper_mode) not in ['unavailable', 'unknown']
          }}
      - service: input_text.set_value
        target:
          entity_id: !input helper_last_mode
        data:
          value: "off"
        continue_on_error: true

      # Update mode start time for off-time protection tracking
      - if:
          - condition: template
            value_template: "{{ helper_mode_time not in [none, '', 'unavailable', 'unknown'] }}"
        then:
          - service: input_datetime.set_datetime
            target:
              entity_id: !input helper_mode_start_time
            data:
              datetime: "{{ now() }}"
            continue_on_error: true

  # Debug: Show which conditions were evaluated but not met
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} DEBUG: Choose block completed - no conditions matched

            ğŸ“Š Final Summary:
                â€¢ should_activate: {{ should_activate }}
                â€¢ smart_presence_active: {{ smart_presence_active }}
                â€¢ current_temp: {{ current_temp }}Â°C
                â€¢ Control mode: {{ control_mode }}
                â€¢ AC state: {{ actual_ac_state }}
                â€¢ Time since change: {{ time_since_change | round(1) }}min
                â€¢ Room presence: {{ room_presence_detected }}
                â€¢ smart_behavior: {{ smart_behavior }}
                â€¢ extreme_temp_detected: {{ extreme_temp_detected }}

            ğŸŒ¡ï¸ Thresholds that were checked:
                â€¢ Cooling LOW: {{ current_temp }} >= {{ cooling_low_temp }} AND < {{ cooling_medium_temp }} = {{ current_temp >= cooling_low_temp and current_temp < cooling_medium_temp }}
                â€¢ Cooling MEDIUM: {{ current_temp }} >= {{ cooling_medium_temp }} AND < {{ cooling_high_temp }} = {{ current_temp >= cooling_medium_temp and current_temp < cooling_high_temp }}
                â€¢ Cooling HIGH: {{ current_temp }} >= {{ cooling_high_temp }} = {{ current_temp >= cooling_high_temp }}
                â€¢ Heating LOW: {{ current_temp }} <= {{ heating_low_temp }} AND > {{ heating_medium_temp }} = {{ current_temp <= heating_low_temp and current_temp > heating_medium_temp }}
                â€¢ Heating MEDIUM: {{ current_temp }} <= {{ heating_medium_temp }} AND > {{ heating_high_temp }} = {{ current_temp <= heating_medium_temp and current_temp > heating_high_temp }}
                â€¢ Heating HIGH: {{ current_temp }} <= {{ heating_high_temp }} = {{ current_temp <= heating_high_temp }}
                â€¢ Escalation: {{ should_escalate }}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  # Adaptive Control Status Debug Log
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            ğŸ” {{ room_name | upper }} ADAPTIVE CONTROL: Status Check

            ğŸ“Š Current Status:
                â€¢ Adaptive Enabled: {{ adaptive_enabled }}
                â€¢ Control Mode: {{ control_mode }}
                â€¢ Room Presence: {{ room_presence_detected }}
                â€¢ Last Presence: {{ states(presence_detected_helper) if presence_detected_helper else 'N/A' }}
                â€¢ Required Delay: {{ adaptive_occupied_delay }} min
            {% if presence_detected_helper and states(presence_detected_helper) not in ['unknown', 'unavailable', ''] %}
            {% set presence_timestamp = as_timestamp(states(presence_detected_helper)) %}
            {% if presence_timestamp %}
            {% set presence_time = (as_timestamp(now()) - presence_timestamp) / 60 %}
                â€¢ Time Present: {{ presence_time | round(1) }} min
                â€¢ Ready to Switch: {{ presence_time >= adaptive_occupied_delay }}
            {% endif %}
            {% endif %}
                â€¢ Override Timeout: {{ adaptive_override_timeout }}h
            {% if adaptive_override_helper and adaptive_override_helper not in ['', 'unknown', 'unavailable'] %}
                â€¢ Override Helper: {{ states(adaptive_override_helper) }}
            {% endif %}
                â€¢ DEBUG: manual_change_detected={{ manual_change_detected }}, helper_mode={{ states(helper_mode) | default('off') }}, actual_ac={{ actual_ac_state }}, time_since_change={% set change_timestamp = as_timestamp(states(helper_change)) if states(helper_change) not in ['unknown', 'unavailable', ''] else none %}{{ ((as_timestamp(now()) - change_timestamp) / 60) | round(1) if change_timestamp else 'N/A' }}min
            {% if adaptive_override_timeout > 0 %}
            {% set override_time = states(helper_override_timestamp) if helper_override_timestamp else none %}
            {% if override_time and override_time not in ['unknown', 'unavailable', ''] %}
            {% set override_timestamp = as_timestamp(override_time) %}
            {% if override_timestamp %}
            {% set time_since_override = (as_timestamp(now()) - override_timestamp) / 3600 %}
                â€¢ Time Since Manual Override: {{ time_since_override | round(1) }}h ({{ 'normal automatic operation' if time_since_override >= 24 else 'recent manual change' }})
                â€¢ Override Active: {{ time_since_override < adaptive_override_timeout }}
            {% endif %}
            {% endif %}
            {% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  # STATE SYNCHRONIZATION: Handle helper/AC mismatch (e.g., after HA restart)
  # If helper says "off" but AC is actually running, intelligently decide what to do
  - if:
      - condition: template
        value_template: "{{ last_mode == 'off' and actual_ac_state == 'on' }}"
    then:
      # Determine what the AC is probably doing based on current temperature
      - variables:
          probable_mode: >
            {% if current_temp >= cooling_high_temp %}
              cooling_high
            {% elif current_temp >= cooling_medium_temp %}
              cooling_medium
            {% elif current_temp >= cooling_low_temp %}
              cooling_low
            {% elif current_temp <= heating_high_temp %}
              heating_high
            {% elif current_temp <= heating_medium_temp %}
              heating_medium
            {% elif current_temp <= heating_low_temp %}
              heating_low
            {% elif current_temp >= comfort_max_temp %}
              cooling_low
            {% elif current_temp <= comfort_min_temp %}
              heating_low
            {% else %}
              off
            {% endif %}
          should_be_running: "{{ probable_mode != 'off' }}"

      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: >
                ğŸ”„ {{ room_name | upper }} STATE SYNC: Helper/AC mismatch detected

                ğŸ“Š Mismatch Details:
                    â€¢ Helper Mode: {{ last_mode }} (says AC should be OFF)
                    â€¢ Actual AC State: {{ actual_ac_state }} (AC is ON)
                    â€¢ Current Temp: {{ current_temp }}Â°C
                    â€¢ Target Temp: {{ target_temp }}Â°C
                    â€¢ Comfort Zone: {{ comfort_min_temp }}-{{ comfort_max_temp }}Â°C

                ğŸ¤” Analysis:
                    â€¢ Probable Mode: {{ probable_mode }}
                    â€¢ Should AC Be Running: {{ should_be_running }}

                ğŸ› ï¸ Action: {{ 'Updating helper to match AC operation' if should_be_running else 'Turning OFF AC (temp in comfort zone)' }}
                ğŸ’¡ Reason: {{ 'Helper out of sync - AC running but helper says "off" (possible causes: HA restart, manual control, or helper update lag)' if should_be_running else 'AC is ON but temp is comfortable - no heating/cooling needed (possible causes: manual turn-on, another automation, or lingering AC state)' }}
              level: warning
              logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

      # If AC should be running, update helper to track it
      - if:
          - condition: template
            value_template: "{{ should_be_running }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_mode
            data:
              value: "{{ probable_mode }}"
            continue_on_error: true

          - service: input_datetime.set_datetime
            target:
              entity_id: !input helper_last_change
            data:
              datetime: "{{ now() }}"
            continue_on_error: true

          # Update mode start time helper for off-time protection tracking
          - if:
              - condition: template
                value_template: "{{ helper_mode_time not in [none, '', 'unavailable', 'unknown'] }}"
            then:
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input helper_mode_start_time
                data:
                  datetime: "{{ now() }}"
                continue_on_error: true

          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    âœ… {{ room_name | upper }} STATE SYNC: Helper updated to {{ probable_mode }}
                    ğŸ“‹ AC running correctly for current temp ({{ current_temp }}Â°C) - helper synced, will continue operation
                    ğŸ’¡ Helper was "off" but AC should be running - restored tracking
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

      # If AC should NOT be running (temp in comfort zone), turn it off
      - if:
          - condition: template
            value_template: "{{ not should_be_running }}"
        then:
          - repeat:
              for_each: "{{ climate_list }}"
              sequence:
                - service: climate.turn_off
                  target:
                    entity_id: "{{ repeat.item }}"
                  continue_on_error: true

          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  message: >
                    âœ… {{ room_name | upper }} STATE SYNC: AC turned OFF
                    ğŸ“‹ Temperature {{ current_temp }}Â°C is in comfort zone ({{ comfort_min_temp }}-{{ comfort_max_temp }}Â°C) - no cooling/heating needed
                    ğŸ’¡ Helper was "off" but AC was running - turned off to save energy
                  level: warning
                  logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') }}"

  # v3.1.6/v3.1.7 helper_change update REMOVED - caused false override re-triggers
  # The update ran even when choose block had no actions, causing override re-activation
  # Proper fix is in the manual detection logic itself (see manual_change_detected variable)

  # Debug: No conditions matched
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          message: >
            âœ… {{ room_name | upper }} CLIMATE CONTROL: All Good

            {% if last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] and actual_ac_state == 'on' %}ğŸ”„ Status: AC running - {{ last_mode|title }} active ({{ (current_temp - target_temp) | abs | round(1) }}Â°C from target){% elif current_temp >= comfort_min_temp and current_temp <= comfort_max_temp and actual_ac_state == 'off' %}ğŸ¯ Status: Temperature {{ current_temp }}Â°C is perfect - AC off{% else %}â¸ï¸ Status: No action required right now{% endif %}

            ğŸ“‹ Technical Details:
                â€¢ Temperature: {{ current_temp }}Â°C
                â€¢ Occupancy: {% if room_presence_detected %}Room occupied{% elif anyone_home %}Home but elsewhere{% elif approaching_home %}Approaching{% else %}Away{% endif %}
                â€¢ Current Mode: {% if should_activate and last_mode in ['cooling_low', 'cooling_medium', 'cooling_high', 'heating_low', 'heating_medium', 'heating_high'] %}{{ last_mode|title }}{% if dynamic_enabled and final_escalation_level > 0 %} - ESCALATING L{{ final_escalation_level }} ğŸ”¼{% elif dynamic_enabled and deescalation_level > 0 %} - DE-ESCALATING L{{ deescalation_level }} ğŸ”½{% elif dynamic_enabled and current_effectiveness >= 80 %} - EFFECTIVE ({{ current_effectiveness }}%) âš–ï¸{% endif %}{% elif actual_ac_state == 'off' %}OFF âš«{% elif current_temp >= comfort_min_temp and current_temp <= comfort_max_temp %}IDLE - COMFORT ZONE{% if dynamic_enabled and deescalation_level > 0 %} (DE-ESCALATED L{{ deescalation_level }}) ğŸ”½{% endif %} âœ…{% elif should_activate %}MONITORING â¸ï¸{% else %}STANDBY{% if last_mode != 'off' %} - LAST: {{ last_mode|title }}{% endif %}{% endif %}
          level: warning
          logger: "blueprints.climate_control.{{ room_name | lower | replace(' ', '_') | regex_replace('[^a-z0-9_.]', '_') }}"

mode: restart